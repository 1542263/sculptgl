function Aabb(){this.min_=[0,0,0];this.max_=[0,0,0]}
Aabb.prototype={clone:function(){var a=new Aabb;a.min_=this.min_.slice();a.max_=this.max_.slice();return a},copy:function(a){vec3.copy(this.min_,a.min_);vec3.copy(this.max_,a.max_);return this},setCopy:function(a,b){vec3.copy(this.min_,a);vec3.copy(this.max_,b);return this},set:function(a,b,c,e,g,d){var h=this.min_,f=this.max_;h[0]=a;h[1]=b;h[2]=c;f[0]=e;f[1]=g;f[2]=d;return this},computeCenter:function(){var a=[0,0,0];return vec3.scale(a,vec3.add(a,this.min_,this.max_),0.5)},isOutside:function(a){var b=
this.min_,c=this.max_,e=a.min_;a=a.max_;return e[0]>c[0]||a[0]<b[0]||e[1]>c[1]||a[1]<b[1]||e[2]>c[2]||a[2]<b[2]?!0:!1},isInside:function(a){var b=this.min_,c=this.max_,e=a.min_;a=a.max_;return b[0]>=e[0]&&c[0]<=a[0]&&b[1]>=e[1]&&c[1]<=a[1]&&b[2]>=e[2]&&c[2]<=a[2]?!0:!1},pointInside:function(a){var b=this.min_,c=this.max_,e=a[0],g=a[1];a=a[2];return e<=b[0]||e>c[0]||g<=b[1]||g>c[1]||a<=b[2]||a>c[2]?!1:!0},expandsWithPoint:function(a,b,c){var e=this.min_,g=this.max_;a>g[0]&&(g[0]=a);a<e[0]&&(e[0]=a);
b>g[1]&&(g[1]=b);b<e[1]&&(e[1]=b);c>g[2]&&(g[2]=c);c<e[2]&&(e[2]=c)},expandsWithAabb:function(a){var b=this.min_,c=this.max_,e=a.min_,g=a.max_;a=e[0];var d=e[1],e=e[2],h=g[0],f=g[1],g=g[2];h>c[0]&&(c[0]=h);a<b[0]&&(b[0]=a);f>c[1]&&(c[1]=f);d<b[1]&&(b[1]=d);g>c[2]&&(c[2]=g);e<b[2]&&(b[2]=e)},intersectRay:function(a,b){var c=this.min_,e=this.max_,g=b[0],d=b[1],h=b[2],f=a[0],k=a[1],l=a[2],m=(c[0]-f)*g,g=(e[0]-f)*g,f=(c[1]-k)*d,d=(e[1]-k)*d,c=(c[2]-l)*h,h=(e[2]-l)*h,e=Math.max(Math.max(Math.min(m,g),
Math.min(f,d)),Math.min(c,h)),m=Math.min(Math.min(Math.max(m,g),Math.max(f,d)),Math.max(c,h));return 0<=m&&e<m},intersectSphere:function(a,b){var c=this.min_,e=this.max_,g=a[0],d=a[1],h=a[2],f=[0,0,0];f[0]=c[0]>g?c[0]:e[0]<g?e[0]:g;f[1]=c[1]>d?c[1]:e[1]<d?e[1]:d;f[2]=c[2]>h?c[2]:e[2]<h?e[2]:h;return vec3.sqrDist(a,f)<b},enlargeIfFlat:function(a){var b=this.min_,c=this.max_;b[0]===c[0]&&(b[0]-=a,c[0]+=a);b[1]===c[1]&&(b[1]-=a,c[1]+=a);b[2]===c[2]&&(b[2]-=a,c[2]+=a)}};function Camera(){this.mode_=Camera.mode.PLANE;this.rot_=quat.create();this.view_=mat4.create();this.proj_=mat4.create();this.lastNormalizedMouseXY_=[0,0];this.height_=this.width_=0;this.zoom_=20;this.transX_=1E-5;this.transY_=0;this.globalScale_=1;this.moveZ_=this.moveX_=0}Camera.mode={SPHERICAL:0,PLANE:1};
Camera.prototype={updateMode:function(a){this.mode_=a;this.rot_=quat.create();a=this.globalScale_;this.reset();this.globalScale_=a;this.zoom(-0.4)},start:function(a,b){this.lastNormalizedMouseXY_=Geometry.normalizedMouse(a,b,this.width_,this.height_)},rotate:function(a,b){var c=Geometry.normalizedMouse(a,b,this.width_,this.height_);if(this.mode_===Camera.mode.PLANE){var e=vec2.dist(this.lastNormalizedMouseXY_,c),g=[0,0];vec2.sub(g,c,this.lastNormalizedMouseXY_);g=[-g[1],g[0],0];vec3.normalize(g,g);
quat.mul(this.rot_,quat.setAxisAngle([0,0,0,0],g,2*e),this.rot_)}else if(this.mode_===Camera.mode.SPHERICAL){var e=Geometry.mouseOnUnitSphere(this.lastNormalizedMouseXY_),g=Geometry.mouseOnUnitSphere(c),d=Math.acos(Math.min(1,vec3.dot(e,g))),h=[0,0,0];vec3.normalize(h,vec3.cross(h,e,g));quat.mul(this.rot_,quat.setAxisAngle([0,0,0,0],h,2*d),this.rot_)}this.lastNormalizedMouseXY_=c},updateView:function(){var a=this.view_,b=this.transX_,c=this.transY_;mat4.lookAt(a,[b,c,this.zoom_],[b,c,0],[0,1,0]);
b=mat4.create();mat4.fromQuat(b,this.rot_);mat4.mul(a,a,b)},updateProjection:function(){this.proj_=mat4.create();mat4.perspective(this.proj_,1.222,this.width_/this.height_,0.01,1E5)},updateTranslation:function(){this.transX_+=this.moveX_*this.globalScale_/400;this.zoom_=Math.max(1E-5,this.zoom_+this.moveZ_*this.globalScale_/400)},translate:function(a,b){this.transX_-=a*this.globalScale_;this.transY_+=b*this.globalScale_},zoom:function(a){this.zoom_=Math.max(1E-5,this.zoom_-a*this.globalScale_)},reset:function(){this.rot_=
quat.create();this.zoom_=0;this.transX_=1E-5;this.transY_=0;this.globalScale_=1}};var Files={loadOBJ:function(a,b){for(var c=b.vertices_,e=b.triangles_,g=[],d=[],h=a.split("\n"),f=[],k=h.length,l=0;l<k;++l){var m=h[l],m=m.trim();if(m.startsWith("v "))f=m.split(/\s+/),c.push(new Vertex(c.length)),g.push(parseFloat(f[1]),parseFloat(f[2]),parseFloat(f[3]));else if(m.startsWith("f ")){var f=m.split(/\s+/),m=f[1].split("/"),n=f[2].split("/"),p=f[3].split("/"),m=parseInt(m[0],10),q=parseInt(n[0],10),p=parseInt(p[0],10),s=c.length;0>m?(m+=s,q+=s,p+=s):(--m,--q,--p);var n=c[m],r=c[q],
t=c[p],v=e.length;n.tIndices_.push(v);r.tIndices_.push(v);t.tIndices_.push(v);e.push(new Triangle(v));d.push(m,q,p);4<f.length&&(++v,f=parseInt(f[4].split("/")[0],10),0>f?f+=s:--f,q=c[f],n.tIndices_.push(v),t.tIndices_.push(v),q.tIndices_.push(v),e.push(new Triangle(v)),d.push(m,p,f))}}b.vertexArray_=new Float32Array(2*g.length);b.normalArray_=new Float32Array(2*g.length);b.indexArray_=new SculptGL.indexArrayType(2*d.length);b.vertexArray_.set(g);b.indexArray_.set(d)},exportOBJ:function(a){var b=
a.vertexArray_,c=a.indexArray_,e="s 0\n",g=a.vertices_.length;a=a.triangles_.length;for(var d=0,h=0,d=0;d<g;++d)h=3*d,e+="v "+b[h]+" "+b[h+1]+" "+b[h+2]+"\n";for(d=0;d<a;++d)h=3*d,e+="f "+(1+c[h])+" "+(1+c[h+1])+" "+(1+c[h+2])+"\n";return e}};var Geometry={normalizedMouse:function(a,b,c,e){return[2*a/c-1,1-2*b/e]},mouseOnUnitSphere:function(a){var b=a[0];a=a[1];var c=1-b*b-a*a,c=0<c?Math.sqrt(c):0,b=[b,a,c];return vec3.normalize(b,b)},intersectionRayTriangle:function(a,b,c,e,g,d,h){var f=[0,0,0];vec3.sub(f,a,c);var k=vec3.dot(f,d),l=vec3.dot(vec3.sub(f,b,c),d);if(0<=k*l||k===l)return!1;vec3.scaleAndAdd(h,a,vec3.sub(f,b,a),-k/(l-k));a=[0,0,0];vec3.cross(a,d,vec3.sub(f,e,c));if(0>vec3.dot(a,vec3.sub(f,h,c)))return!1;vec3.cross(a,d,vec3.sub(f,
g,e));if(0>vec3.dot(a,vec3.sub(f,h,e)))return!1;vec3.cross(a,d,vec3.sub(f,c,g));return 0>vec3.dot(a,vec3.sub(f,h,c))?!1:!0},unproject:function(a,b,c,e,g,d,h){a=[2*a/d-1,2*b/h-1,2*c-1,1];b=mat4.create();vec4.transformMat4(a,a,mat4.invert(b,mat4.mul(b,g,e)));e=a[3];return[a[0]/e,a[1]/e,a[2]/e]},project:function(a,b,c,e,g,d,h){a=[a,b,c,1];vec4.transformMat4(a,a,e);vec4.transformMat4(a,a,g);e=a[3];return[0.5*(a[0]/e+1)*d,h-0.5*(a[1]/e+1)*h,0.5*(a[2]/e+1)]},point2Dto3D:function(a,b,c,e){return Geometry.unproject(b,
a.height_-c,e,a.view_,a.proj_,a.width_,a.height_)},point3Dto2D:function(a,b){return Geometry.project(b[0],b[1],b[2],a.view_,a.proj_,a.width_,a.height_)},computeTriangleAabb:function(a,b,c,e,g,d,h,f,k,l){var m=Math.min(b,g,f),n=Math.min(c,d,k),p=Math.min(e,h,l);b=Math.max(b,g,f);c=Math.max(c,d,k);e=Math.max(e,h,l);h=a.min_;a=a.max_;h[0]=m;h[1]=n;h[2]=p;a[0]=b;a[1]=c;a[2]=e},normal:function(a,b,c,e,g,d,h,f,k,l){g-=b;d-=c;h-=e;b=f-b;c=k-c;f=l-e;k=l=e=0;e=d*f-h*c;l=h*b-g*f;k=g*c-d*b;g=e*e+l*l+k*k;0!==
g&&(g=1/Math.sqrt(g),a[0]=e*g,a[1]=l*g,a[2]=k*g)},pointInsideTriangle:function(a,b,c,e){var g=[0,0,0];vec3.sub(g,b,c);var d=[0,0,0];vec3.sub(d,b,e);b=[0,0,0];vec3.sub(b,a,c);c=[0,0,0];vec3.sub(c,a,e);e=[0,0,0];a=vec3.len(vec3.cross(e,g,d));g=vec3.len(vec3.cross(e,g,b));d=vec3.len(vec3.cross(e,d,c));b=vec3.len(vec3.cross(e,b,c));return 1E-4>Math.abs(a-(g+d+b))?!0:!1},sphereIntersectTriangle:function(a,b,c,e,g){return Geometry.distanceToSegment(a,c,e)<b||Geometry.distanceToSegment(a,e,g)<b||Geometry.distanceToSegment(a,
c,g)<b?!0:!1},distanceToSegment:function(a,b,c){var e=[0,0,0];vec3.sub(e,a,b);var g=[0,0,0];vec3.sub(g,c,b);var d=vec3.sqrLen(g),d=vec3.dot(e,g)/d;if(0>d)return vec3.sqrLen(e);if(1<d)return vec3.sqrLen(vec3.sub(e,a,c));e[0]=a[0]-b[0]+d*g[0];e[1]=a[1]-b[1]+d*g[1];e[2]=a[2]-b[2]+d*g[2];return vec3.sqrLen(e)},signedAngle2d:function(a,b){var c=a[0],e=a[1],g=b[0],d=b[1];return Math.atan2(c*d-e*g,c*g+e*d)},pointPlaneDistance:function(a,b,c){return vec3.dot(vec3.sub([0,0,0],a,b),c)},mirrorPoint:function(a,
b,c){return vec3.sub(a,a,vec3.scale([0,0,0],c,2*Geometry.pointPlaneDistance(a,b,c)))}};function Grid(){this.aabb_=new Aabb;this.size_=this.cellSize_=this.dimZ_=this.dimY_=this.dimX_=0;this.iVerts_=[]}
Grid.prototype={setBoundaries:function(a){var b=[0,0,0];vec3.sub(b,a.max_,a.min_);vec3.scale(b,b,0.1);vec3.sub(a.min_,a.min_,b);vec3.add(a.max_,a.max_,b);this.aabb_=a},init:function(a){this.cellSize_=a;var b=this.aabb_,c=[0,0,0];vec3.sub(c,b.max_,b.min_);var b=Math.ceil(c[0]/a),e=Math.ceil(c[1]/a);a=Math.ceil(c[2]/a);0>=b&&(b=1);0>=e&&(e=1);0>=a&&(a=1);var c=this.size_=1+b*e*a,g=this.iVerts_;g.length=c;for(var d=0;d<c;++d)g[d]=[];this.dimX_=b;this.dimY_=e;this.dimZ_=a},build:function(a,b){for(var c=
a.vertexArray_,e=this.aabb_.min_,g=this.dimX_,d=g*this.dimY_,h=0,f=0,k=0,l=0,k=0,m=this.cellSize_,n=this.size_,p=this.iVerts_,q=b.length,l=0;l<q;++l){var s=b[l],k=3*s,h=Math.floor((c[k]-e[0])/m),f=Math.floor((c[k+1]-e[1])/m),k=Math.floor((c[k+2]-e[2])/m),h=h+f*g+k*d;0>h?h=0:h>=n&&(h=n-1);p[h].push(s)}},getNeighborhood:function(a,b,c){var e=this.aabb_.min_,g=this.cellSize_,d=this.dimX_,h=this.dimY_,f=this.dimZ_,k=d*this.dimY_;a=Math.floor((a-e[0])/g);b=Math.floor((b-e[1])/g);c=Math.floor((c-e[2])/
g);0>a?a=0:a>=d&&(a=d-1);0>b?b=0:b>=h&&(b=h-1);0>c?c=0:c>=f&&(c=f-1);var l=g=e=-1,m=1,n=1,p=1;0>=a&&(e=0);a>=d-1&&(m=0);0>=b&&(g=0);b>=h-1&&(n=0);0>=c&&(l=0);c>=f-1&&(p=0);for(var q=f=h=0,s=this.iVerts_,r=[],h=e;h<=m;++h)for(f=g;f<=n;++f)for(q=l;q<=p;++q)r.push.apply(r,s[a+h+(b+f)*d+(c+q)*k]);return r}};function Mesh(a){this.vertices_=[];this.triangles_=[];this.indexArray_=this.normalArray_=this.vertexArray_=null;this.center_=[0,0,0];this.octree_=new Octree;this.matTransform_=mat4.create();this.leavesUpdate_=[];this.render_=new Render(a)}Mesh.globalScale_=500;Mesh.stateMask_=1;
Mesh.prototype={getTrianglesFromVertices:function(a){for(var b=++Triangle.tagMask_,c=[],e=a.length,g=this.vertices_,d=this.triangles_,h=0;h<e;++h)for(var f=g[a[h]].tIndices_,k=f.length,l=0;l<k;++l){var m=f[l];d[m].tagFlag_!==b&&(c.push(m),d[m].tagFlag_=b)}return c},getVerticesFromTriangles:function(a){for(var b=++Vertex.tagMask_,c=[],e=a.length,g=this.vertices_,d=this.indexArray_,h=0;h<e;++h){var f=3*a[h],k=d[f],l=d[f+1],f=d[f+2];g[k].tagFlag_!==b&&(c.push(k),g[k].tagFlag_=b);g[l].tagFlag_!==b&&(c.push(l),
g[l].tagFlag_=b);g[f].tagFlag_!==b&&(c.push(f),g[f].tagFlag_=b)}return c},expandsTriangles:function(a,b){for(var c=++Triangle.tagMask_,e=a.length,g=this.vertices_,d=this.triangles_,h=this.indexArray_,f=0,k=0,f=0;f<e;++f)d[a[f]].tagFlag_=c;for(f=0;b;){for(--b;f<e;++f){for(var k=3*a[f],l=g[h[k]].tIndices_,m=g[h[k+1]].tIndices_,n=g[h[k+2]].tIndices_,p=l.length,q=m.length,s=n.length,k=0;k<p;++k){var r=d[l[k]];r.tagFlag_!==c&&(r.tagFlag_=c,a.push(l[k]))}for(k=0;k<q;++k)l=d[m[k]],l.tagFlag_!==c&&(l.tagFlag_=
c,a.push(m[k]));for(k=0;k<s;++k)m=d[n[k]],m.tagFlag_!==c&&(m.tagFlag_=c,a.push(n[k]))}f=e;e=a.length}},expandsVertices:function(a,b){for(var c=++Vertex.tagMask_,e=a.length,g=this.vertices_,d=0,h=0,d=0;d<e;++d)g[a[d]].tagFlag_=c;for(d=0;b;){for(--b;d<e;++d)for(var f=g[a[d]].ringVertices_,k=f.length,h=0;h<k;++h){var l=g[f[h]];l.tagFlag_!==c&&(l.tagFlag_=c,a.push(f[h]))}d=e;e=a.length}},computeRingVertices:function(a){var b=++Vertex.tagMask_,c=this.vertices_,e=this.indexArray_,g=c[a];g.ringVertices_.length=
0;for(var d=g.ringVertices_,g=g.tIndices_,h=g.length,f=0;f<h;++f){var k=3*g[f],l=e[k],m=e[k+1],k=e[k+2];l!==a&&c[l].tagFlag_!==b&&(d.push(l),c[l].tagFlag_=b);m!==a&&c[m].tagFlag_!==b&&(d.push(m),c[m].tagFlag_=b);k!==a&&c[k].tagFlag_!==b&&(d.push(k),c[k].tagFlag_=b)}},moveTo:function(a){mat4.translate(this.matTransform_,mat4.create(),vec3.sub(a,a,this.center_))},render:function(a,b){this.render_.render(a,b,this.matTransform_,3*this.triangles_.length,this.center_)},initMesh:function(a,b){var c=this.vertexArray_,
e=this.vertices_.length,g=this.triangles_.length,d=new Aabb;d.set(c[0],c[1],c[2],c[0],c[1],c[2]);for(var h=0,f=0,h=0;h<e;++h)this.computeRingVertices(h),f=3*h,d.expandsWithPoint(c[f],c[f+1],c[f+2]);this.center_=d.computeCenter();for(var h=vec3.dist(d.min_,d.max_),k=Mesh.globalScale_/h,h=0;h<e;++h)f=3*h,c[f]*=k,c[f+1]*=k,c[f+2]*=k;mat4.scale(this.matTransform_,this.matTransform_,[k,k,k]);vec3.scale(d.min_,d.min_,k);vec3.scale(d.max_,d.max_,k);vec3.scale(this.center_,this.center_,k);c=[0,0,0];vec3.sub(c,
d.max_,d.min_);vec3.scale(c,c,0.2);vec3.sub(d.min_,d.min_,c);vec3.add(d.max_,d.max_,c);d.enlargeIfFlat(vec3.length(c));for(h=0;h<g;++h)this.updateTriangleAabbAndNormal(h);for(h=0;h<e;++h)this.updateVertexNormal(h);e=Array(g);for(h=0;h<g;++h)e[h]=h;++Triangle.tagMask_;this.octree_=new Octree;this.octree_.build(this,e,d);this.render_.initBuffers(this.vertexArray_,this.normalArray_,this.indexArray_);this.render_.updateShaders(this.render_.shaderType_,a,b)},updateBuffers:function(){this.render_.updateBuffers(this.vertexArray_,
this.normalArray_,this.indexArray_)},updateMesh:function(a,b){for(var c=b.length,e=a.length,g=0,g=0;g<e;++g)this.updateTriangleAabbAndNormal(a[g]);this.updateOctree(a);for(g=0;g<c;++g)this.updateVertexNormal(b[g])},updateTriangleAabbAndNormal:function(a){var b=this.vertexArray_,c=this.indexArray_,e=this.triangles_[a];a*=3;var g=3*c[a],d=3*c[a+1],h=3*c[a+2];a=b[g];var c=b[g+1],g=b[g+2],f=b[d],k=b[d+1],d=b[d+2],l=b[h],m=b[h+1],b=b[h+2];Geometry.normal(e.normal_,a,c,g,f,k,d,l,m,b);Geometry.computeTriangleAabb(e.aabb_,
a,c,g,f,k,d,l,m,b)},updateVertexNormal:function(a){for(var b=this.triangles_,c=this.normalArray_,e=this.vertices_[a].tIndices_,g=e.length,d=0,h=0,f=0,k=0;k<g;++k)var l=b[e[k]].normal_,d=d+l[0],h=h+l[1],f=f+l[2];b=1/Math.sqrt(d*d+h*h+f*f);a*=3;c[a]=d*b;c[a+1]=h*b;c[a+2]=f*b},updateOctree:function(a){for(var b=a.length,c=[],e=this.triangles_,g=0,d,g=0;g<b;++g){var h=e[a[g]];d=h.leaf_;if(d.aabbSplit_.pointInside(h.aabb_.computeCenter()))h.aabb_.isInside(d.aabbLoose_)||d.aabbLoose_.expandsWithAabb(h.aabb_);
else if(c.push(a[g]),d=d.iTris_,0<d.length){var f=d[d.length-1],h=h.posInLeaf_;d[h]=f;e[f].posInLeaf_=h;d.pop()}}a=c.length;for(g=0;g<a;++g)if(b=e[c[g]],this.octree_.aabbLoose_.isOutside(b.aabb_)){c=new Aabb;c.setCopy(this.octree_.aabbSplit_.min_,this.octree_.aabbSplit_.max_);g=[0,0,0];vec3.scale(g,vec3.sub(g,c.max_,c.min_),0.2);vec3.sub(c.min_,c.min_,g);vec3.add(c.max_,c.max_,g);d=[];e=e.length;for(g=0;g<e;++g)d.push(g);this.octree_=new Octree;++Triangle.tagMask_;this.octree_.build(this,d,c);this.leavesUpdate_.length=
0;break}else d=b.leaf_,this.octree_.addTriangle(this,b),d===b.leaf_&&(d=d.iTris_,b.posInLeaf_=d.length,d.push(c[g]))},checkLeavesUpdate:function(){Tools.tidy(this.leavesUpdate_);var a=this.leavesUpdate_,b=a.length,c=[],e=Octree.maxTriangles_,g=Octree.maxDepth_;++Triangle.tagMask_;for(var d=0,h=0,d=0;d<b;++d){h=a[d];if(null===h)break;h.iTris_.length?h.iTris_.length>e&&h.depth_<g&&h.constructCells(this):Octree.checkEmptiness(h,c)}Tools.tidy(c);a=c.length;for(d=0;d<a;++d){b=c[d].child_;for(h=0;8>h;++h)b[h]=
null}this.leavesUpdate_.length=0}};function Octree(a,b){this.parent_="undefined"!==typeof a?a:null;this.depth_="undefined"!==typeof b?b:0;this.child_=[];this.aabbLoose_=new Aabb;this.aabbSplit_=new Aabb;this.iTris_=[]}Octree.maxDepth_=8;Octree.maxTriangles_=100;
Octree.prototype={build:function(a,b,c){var e=this.aabbSplit_,g=this.aabbLoose_;e.copy(c);g.copy(c);this.iTris_.length=0;c=this.iTris_;var d=a.triangles_,h=b.length,f=Triangle.tagMask_,k=0,l;if(this.parent_&&this.parent_.child_[7]===this)for(k=0;k<h;++k)l=d[b[k]],l.tagFlag_!==f&&(g.expandsWithAabb(l.aabb_),c.push(b[k]));else for(k=0;k<h;++k)l=d[b[k]],e.pointInside(l.aabb_.computeCenter())&&l.tagFlag_!==f&&(g.expandsWithAabb(l.aabb_),c.push(b[k]));b=c.length;if(b>Octree.maxTriangles_&&this.depth_<
Octree.maxDepth_)this.constructCells(a);else for(k=0;k<b;++k)l=d[c[k]],l.tagFlag_=f,l.leaf_=this,l.posInLeaf_=k},constructCells:function(a){var b=this.child_,c=this.iTris_,e=this.aabbSplit_.min_,g=this.aabbSplit_.max_,d=e[0],h=e[1],f=e[2],k=g[0],l=g[1],m=g[2],n=this.aabbSplit_.computeCenter(),p=n[0],q=n[1],s=n[2],r=0.5*(k-d),t=0.5*(l-h),v=0.5*(m-f),u=this.depth_+1,w=new Aabb;b[0]=new Octree(this,u);b[0].build(a,c,w.setCopy(e,n));b[1]=new Octree(this,u);b[1].build(a,c,w.set(d+r,h,f,p+r,q,s));b[2]=
new Octree(this,u);b[2].build(a,c,w.set(p,q-t,s,k,l-t,m));b[3]=new Octree(this,u);b[3].build(a,c,w.set(d,h,f+v,p,q,s+v));b[4]=new Octree(this,u);b[4].build(a,c,w.set(d,h+t,f,p,q+t,s));b[5]=new Octree(this,u);b[5].build(a,c,w.set(p,q,s-v,k,l,m-v));b[6]=new Octree(this,u);b[6].build(a,c,w.setCopy(n,g));b[7]=new Octree(this,u);b[7].build(a,c,w.set(p-r,q,s,k-r,l,m));this.iTris_.length=0},intersectRay:function(a,b){if(this.aabbLoose_.intersectRay(a,b)){if(this.child_[0]){for(var c=[],e=this.child_,g=0;8>
g;++g){var d=e[g].intersectRay(a,b);c.push.apply(c,d)}return c}return this.iTris_}return[]},intersectSphere:function(a,b,c){if(this.aabbSplit_.intersectSphere(a,b)){if(this.child_[0]){for(var e=[],g=this.child_,d=0;8>d;++d){var h=g[d].intersectSphere(a,b,c);e.push.apply(e,h)}return e}c.push(this);return this.iTris_}return[]},addTriangle:function(a,b){if(this.aabbSplit_.pointInside(b.aabb_.computeCenter())){this.aabbLoose_.expandsWithAabb(b.aabb_);var c=this.child_;if(c[0])for(var e=0;8>e;++e)c[e].addTriangle(a,
b);else b.posInLeaf_=this.iTris_.length,b.leaf_=this,this.iTris_.push(b.id_)}}};Octree.checkEmptiness=function(a,b){var c=a.parent_;if(c){for(var e=c.child_,g=0,g=0;8>g;++g)if(0<e[g].iTris_.length||e[g].child_[0])return;b.push(c);for(g=0;8>g;++g)b.push(e[g]);Octree.checkEmptiness(c,b)}};function Picking(a){this.mesh_=null;this.pickedTriangle_=-1;this.pickedVertices_=[];this.interPoint_=[0,0,0];this.rDisplay_=50;this.rWorldSqr_=0;this.camera_=a;this.eyeDir_=[0,0,0]}
Picking.prototype={intersectionMouseMesh:function(a,b,c,e,g){var d=Geometry.point2Dto3D(this.camera_,b,c,0),h=Geometry.point2Dto3D(this.camera_,b,c,1),f=mat4.create();mat4.invert(f,a.matTransform_);vec3.transformMat4(d,d,f);vec3.transformMat4(h,h,f);e&&(Geometry.mirrorPoint(d,e,g),Geometry.mirrorPoint(h,e,g));this.intersectionRayMesh(a,d,h,b,c);a=this.eyeDir_;vec3.sub(a,h,d);vec3.normalize(a,a)},intersectionRayMesh:function(a,b,c,e,g){this.mesh_=null;this.pickedTriangle_=-1;var d=a.triangles_,h=a.vertexArray_,
f=a.indexArray_,k=[0,0,0];vec3.sub(k,c,b);vec3.normalize(k,k);for(var k=a.octree_.intersectRay(b,[1/k[0],1/k[1],1/k[2]]),l=-1,m=k.length,n=[0,0,0],p=0;p<m;++p){var q=k[p],s=d[q],q=3*q,r=3*f[q],t=3*f[q+1],q=3*f[q+2];if(Geometry.intersectionRayTriangle(b,c,[h[r],h[r+1],h[r+2]],[h[t],h[t+1],h[t+2]],[h[q],h[q+1],h[q+2]],s.normal_,n)&&(s=vec3.sqrDist(b,n),s<l||-1===l))l=s,vec3.copy(this.interPoint_,n),this.pickedTriangle_=k[p]}-1!==this.pickedTriangle_?(this.mesh_=a,a=[0,0,0],vec3.transformMat4(a,this.interPoint_,
this.mesh_.matTransform_),b=Geometry.point3Dto2D(this.camera_,a)[2],e=Geometry.point2Dto3D(this.camera_,e+this.rDisplay_,g,b),this.rWorldSqr_=vec3.sqrDist(a,e)):this.rWorldSqr_=0},pickVerticesInSphere:function(a){this.pickedVertices_=[];for(var b=this.mesh_.vertices_,c=this.mesh_.vertexArray_,e=this.mesh_.octree_.intersectSphere(this.interPoint_,a,this.mesh_.leavesUpdate_),e=this.mesh_.getVerticesFromTriangles(e),g=e.length,d=++Vertex.sculptMask_,h=this.pickedVertices_,f=0,k=f=0;k<g;++k){var f=e[k],
l=b[f],f=3*f;vec3.sqrDist([c[f],c[f+1],c[f+2]],this.interPoint_)<a&&(l.sculptFlag_=d,h.push(e[k]))}0===this.pickedVertices_.length&&-1!==this.pickedTriangle_&&(a=this.mesh_.indexArray_,f=3*this.pickedTriangle_,this.pickedVertices_.push(a[f],a[f+1],a[f+2]))}};function Render(a){this.gl_=a;this.color_=[168,66,66];this.shaderType_=Render.mode.PHONG;this.reflectionTexUnif_=this.colorUnif_=this.lightPositionUnif_=this.radiusSquaredUnif_=this.centerPickingUnif_=this.normalMatrixUnif_=this.mvMatrixUnif_=this.mvpMatrixUnif_=this.barycenterAttrib_=this.normalAttrib_=this.vertexAttrib_=this.vertexShader_=this.fragmentShader_=this.shaderProgram_=this.reflectionLoc_=this.indexBuffer_=this.barycenterBuffer_=this.normalBuffer_=this.vertexBuffer_=null}
Render.mode={PHONG:0,TRANSPARENCY:1,WIREFRAME:2,MATERIAL:3};
Render.prototype={updateShaders:function(a,b,c){var e=this.gl_;this.shaderType_=a;e.deleteProgram(this.shaderProgram_);a>=Render.mode.MATERIAL&&(this.reflectionLoc_=this.loadTexture(e,b[a-Render.mode.MATERIAL]));this.initShaders(c)},loadTexture:function(a,b){var c=a.createTexture();a.bindTexture(a.TEXTURE_2D,c);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,b);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR_MIPMAP_NEAREST);
a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null);return c},initShaders:function(a){var b=this.gl_;switch(this.shaderType_){case Render.mode.PHONG:this.loadShaders(a.phongVertex,a.phongFragment);break;case Render.mode.WIREFRAME:this.loadShaders(a.wireframeVertex,a.wireframeFragment);break;case Render.mode.TRANSPARENCY:this.loadShaders(a.transparencyVertex,a.transparencyFragment);break;default:this.loadShaders(a.reflectionVertex,a.reflectionFragment)}a=this.shaderProgram_=b.createProgram();
b.attachShader(a,this.vertexShader_);b.attachShader(a,this.fragmentShader_);b.linkProgram(a);b.useProgram(a);this.vertexAttrib_=b.getAttribLocation(this.shaderProgram_,"vertex");this.normalAttrib_=b.getAttribLocation(this.shaderProgram_,"normal");this.shaderType_===Render.mode.WIREFRAME&&(this.barycenterAttrib_=b.getAttribLocation(this.shaderProgram_,"barycenter"));this.mvpMatrixUnif_=b.getUniformLocation(a,"mvpMat");this.mvMatrixUnif_=b.getUniformLocation(a,"mvMat");this.normalMatrixUnif_=b.getUniformLocation(a,
"nMat");this.centerPickingUnif_=b.getUniformLocation(a,"centerPicking");this.radiusSquaredUnif_=b.getUniformLocation(a,"radiusSquared");this.colorUnif_=b.getUniformLocation(a,"color");this.shaderType_===Render.mode.TRANSPARENCY&&(this.lightPositionUnif_=b.getUniformLocation(a,"lightPos"));this.shaderType_>=Render.mode.MATERIAL&&(this.reflectionTexUnif_=b.getUniformLocation(a,"refTex"));b.detachShader(a,this.fragmentShader_);b.deleteShader(this.fragmentShader_);b.detachShader(a,this.vertexShader_);
b.deleteShader(this.vertexShader_)},loadShaders:function(a,b){var c=this.gl_;this.vertexShader_=c.createShader(c.VERTEX_SHADER);c.shaderSource(this.vertexShader_,a);c.compileShader(this.vertexShader_);this.fragmentShader_=c.createShader(c.FRAGMENT_SHADER);c.shaderSource(this.fragmentShader_,b);c.compileShader(this.fragmentShader_)},initBuffers:function(a,b,c){var e=this.gl_;this.vertexBuffer_=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,this.vertexBuffer_);e.bufferData(e.ARRAY_BUFFER,a,e.DYNAMIC_DRAW);
this.normalBuffer_=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,this.normalBuffer_);e.bufferData(e.ARRAY_BUFFER,b,e.DYNAMIC_DRAW);this.indexBuffer_=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.indexBuffer_);e.bufferData(e.ELEMENT_ARRAY_BUFFER,c,e.STATIC_DRAW)},render:function(a,b,c,e,g){var d=this.gl_;d.useProgram(this.shaderProgram_);var h=b.interPoint_;b=b.rWorldSqr_;var f=mat4.create();mat4.mul(f,a.view_,c);c=mat4.create();mat4.mul(c,a.proj_,f);d.enableVertexAttribArray(this.vertexAttrib_);
d.bindBuffer(d.ARRAY_BUFFER,this.vertexBuffer_);d.vertexAttribPointer(this.vertexAttrib_,3,d.FLOAT,!1,0,0);d.enableVertexAttribArray(this.normalAttrib_);d.bindBuffer(d.ARRAY_BUFFER,this.normalBuffer_);d.vertexAttribPointer(this.normalAttrib_,3,d.FLOAT,!1,0,0);d.uniformMatrix4fv(this.mvMatrixUnif_,!1,f);d.uniformMatrix4fv(this.mvpMatrixUnif_,!1,c);d.uniformMatrix3fv(this.normalMatrixUnif_,!1,mat3.normalFromMat4(mat3.create(),f));d.uniform3fv(this.centerPickingUnif_,vec3.transformMat4([0,0,0],h,f));
d.uniform1f(this.radiusSquaredUnif_,b);switch(this.shaderType_){case Render.mode.PHONG:d.uniform3fv(this.colorUnif_,vec3.scale([0,0,0],this.color_,1/255));this.drawBuffer(e);break;case Render.mode.WIREFRAME:d.enableVertexAttribArray(this.barycenterAttrib_);d.bindBuffer(d.ARRAY_BUFFER,this.barycenterBuffer_);d.vertexAttribPointer(this.barycenterAttrib_,3,d.FLOAT,!1,0,0);d.uniform3fv(this.colorUnif_,vec3.scale([0,0,0],this.color_,1/255));d.drawArrays(d.TRIANGLES,0,e);break;case Render.mode.TRANSPARENCY:d.depthMask(!1);
d.enable(d.BLEND);d.uniform4fv(this.colorUnif_,[this.color_[0]/255,this.color_[1]/255,this.color_[2]/255,0.15]);d.uniform3fv(this.lightPositionUnif_,g);this.drawBuffer(e);d.disable(d.BLEND);d.depthMask(!0);break;default:d.activeTexture(d.TEXTURE0),d.bindTexture(d.TEXTURE_2D,this.reflectionLoc_),d.uniform1i(this.reflectionTexUnif_,0),this.drawBuffer(e)}},drawBuffer:function(a){var b=this.gl_;b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,this.indexBuffer_);b.drawElements(b.TRIANGLES,a,SculptGL.elementIndexType,
0)},updateBuffers:function(a,b,c){if(this.shaderType_===Render.mode.WIREFRAME)this.makeWireframeBuffers(a,b,c);else{var e=this.gl_;e.bindBuffer(e.ARRAY_BUFFER,this.vertexBuffer_);e.bufferData(e.ARRAY_BUFFER,a,e.DYNAMIC_DRAW);e.bindBuffer(e.ARRAY_BUFFER,this.normalBuffer_);e.bufferData(e.ARRAY_BUFFER,b,e.DYNAMIC_DRAW);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.indexBuffer_);e.bufferData(e.ELEMENT_ARRAY_BUFFER,c,e.STATIC_DRAW)}},makeWireframeBuffers:function(a,b,c){for(var e=this.gl_,g=new Float32Array(3*
c.length),d=0,h=0,f=0,d=0;d<c.length;++d)h=3*d,f=3*c[d],g[h]=a[f],g[h+1]=a[f+1],g[h+2]=a[f+2];e.bindBuffer(e.ARRAY_BUFFER,this.vertexBuffer_);e.bufferData(e.ARRAY_BUFFER,g,e.DYNAMIC_DRAW);a=new Float32Array(3*c.length);for(d=0;d<c.length;++d)h=3*d,f=3*c[d],a[h]=b[f],a[h+1]=b[f+1],a[h+2]=b[f+2];e.bindBuffer(e.ARRAY_BUFFER,this.normalBuffer_);e.bufferData(e.ARRAY_BUFFER,a,e.DYNAMIC_DRAW);b=new Float32Array(3*c.length);for(d=0;d<c.length/3;++d)h=9*d,b[h]=1,b[h+1]=0,b[h+2]=0,b[h+3]=0,b[h+4]=1,b[h+5]=
0,b[h+6]=0,b[h+7]=0,b[h+8]=1;this.barycenterBuffer_||(this.barycenterBuffer_=e.createBuffer());e.bindBuffer(e.ARRAY_BUFFER,this.barycenterBuffer_);e.bufferData(e.ARRAY_BUFFER,b,e.DYNAMIC_DRAW)}};function Sculpt(a){this.states_=a;this.mesh_=null;this.intensity_=0.75;this.tool_=Sculpt.tool.BRUSH;this.topo_=Sculpt.topo.SUBDIVISION;this.detail_=0.75;this.culling_=this.negative_=!1;this.d2Max_=this.d2Min_=0;this.d2Thickness_=0.5;this.d2Move_=0;this.rotateData_={normal:[0,0,0],center2d:[0,0]};this.rotateDataSym_={normal:[0,0,0],center2d:[0,0]}}Sculpt.tool={BRUSH:0,INFLATE:1,ROTATE:2,SMOOTH:3,FLATTEN:4,PINCH:5,CREASE:6};Sculpt.topo={STATIC:0,SUBDIVISION:1,DECIMATION:2,UNIFORMISATION:3,ADAPTIVE:4};
Sculpt.prototype={setAdaptiveParameters:function(a){this.d2Max_=0.2*a*(1.1-this.detail_);this.d2Min_=this.d2Max_/4.2025;this.d2Move_=0.2375*this.d2Min_;this.d2Thickness_=1.1*(4*this.d2Move_+this.d2Max_/3)},sculptMesh:function(a,b,c,e,g,d){var h=this.mesh_,f=a.pickedVertices_,k=a.rWorldSqr_,l=a.interPoint_,m=a.eyeDir_;a=h.vertices_;var n=h.getTrianglesFromVertices(f);this.states_.pushState(n,f);var p=new Topology(this.states_);p.mesh_=h;p.radiusSquared_=k;p.center_=l;this.setAdaptiveParameters(k);
switch(this.topo_){case Sculpt.topo.SUBDIVISION:n=p.subdivision(n,this.d2Max_);break;case Sculpt.topo.DECIMATION:n=p.decimation(n,this.d2Min_);break;case Sculpt.topo.UNIFORMISATION:case Sculpt.topo.ADAPTIVE:n=p.subdivision(n,this.d2Max_),n=p.decimation(n,this.d2Min_)}for(var f=h.getVerticesFromTriangles(n),q=f.length,s=[],r=[],t=Vertex.sculptMask_,v=h.normalArray_,u=m[0],w=m[1],m=m[2],y=0;y<q;++y){var x=f[y];if(a[x].sculptFlag_===t){s.push(x);var z=3*x;0>=v[z]*u+v[z+1]*w+v[z+2]*m&&r.push(x)}}if(0!==
r.length)switch(this.culling_&&(s=r),this.tool_){case Sculpt.tool.BRUSH:this.flatten(l,s,r,k,0.5*this.intensity_);this.brush(l,s,r,k,this.intensity_);break;case Sculpt.tool.INFLATE:this.inflate(l,s,k,this.intensity_);break;case Sculpt.tool.ROTATE:this.rotate(l,s,k,b,c,e,g,d);break;case Sculpt.tool.SMOOTH:this.smooth(s,this.intensity_);break;case Sculpt.tool.FLATTEN:this.flatten(l,s,r,k,this.intensity_);break;case Sculpt.tool.PINCH:this.pinch(l,s,k,this.intensity_);break;case Sculpt.tool.CREASE:this.crease(l,
s,r,k,this.intensity_)}this.topo_===Sculpt.topo.ADAPTIVE&&(n=p.adaptTopology(n,this.d2Thickness_),f=h.getVerticesFromTriangles(n));h.updateMesh(n,f)},brush:function(a,b,c,e,g){var d=this.areaNormal(c);if(d){c=this.mesh_.vertexArray_;e=Math.sqrt(e);var h=b.length;g=0.1*g*e;this.topo_===Sculpt.topo.ADAPTIVE&&(g=Math.min(Math.sqrt(this.d2Move_),g));this.negative_&&(g=-g);var f=a[0],k=a[1];a=a[2];for(var l=d[0],m=d[1],d=d[2],n=0;n<h;++n){var p=3*b[n],q=c[p]-f,s=c[p+1]-k,r=c[p+2]-a,q=Math.sqrt(q*q+s*s+
r*r)/e,q=3*q*q*q*q-4*q*q*q+1,q=g*q;c[p]+=l*q;c[p+1]+=m*q;c[p+2]+=d*q}}},inflate:function(a,b,c,e){var g=this.mesh_,d=g.vertexArray_,g=g.normalArray_,h=b.length;c=Math.sqrt(c);e=0.1*e*c;this.topo_===Sculpt.topo.ADAPTIVE&&(e=Math.min(Math.sqrt(this.d2Move_),e));this.negative_&&(e=-e);var f=a[0],k=a[1];a=a[2];for(var l=0;l<h;++l){var m=3*b[l],n=d[m]-f,p=d[m+1]-k,q=d[m+2]-a,n=Math.sqrt(n*n+p*p+q*q)/c,n=3*n*n*n*n-4*n*n*n+1,n=e*n;d[m]+=g[m]*n;d[m+1]+=g[m+1]*n;d[m+2]+=g[m+2]*n}},startRotate:function(a,b,
c,e,g,d){var h=Geometry.point2Dto3D(a.camera_,b,c,0),f=Geometry.point2Dto3D(a.camera_,b,c,1),k=mat4.create();mat4.invert(k,this.mesh_.matTransform_);vec3.transformMat4(h,h,k);vec3.transformMat4(f,f,k);this.initRotateData(a,h,f,b,c,this.rotateData_);e&&(h=[h[0],h[1],h[2]],Geometry.mirrorPoint(h,g,d),f=[f[0],f[1],f[2]],Geometry.mirrorPoint(f,g,d),this.initRotateData(e,h,f,b,c,this.rotateDataSym_),e.rWorldSqr_=a.rWorldSqr_)},initRotateData:function(a,b,c,e,g,d){a.intersectionRayMesh(this.mesh_,b,c,e,
g);a.mesh_&&(a.pickVerticesInSphere(a.rWorldSqr_),a=[0,0,0],vec3.sub(a,b,c),d.normal=vec3.normalize(a,a),d.center2d=[e,g])},rotate:function(a,b,c,e,g,d,h,f){var k=this.rotateData_;f&&(k=this.rotateDataSym_);f=k.center2d;g=[e-f[0],g-f[1]];if(!(30>vec2.len(g))){vec2.normalize(g,g);k=k.normal;e=[0,0,0,0];d=[d-f[0],h-f[1]];vec2.normalize(d,d);d=Geometry.signedAngle2d(g,d);h=this.mesh_.vertexArray_;c=Math.sqrt(c);f=b.length;g=a[0];for(var l=a[1],m=a[2],n=0;n<f;++n){var p=3*b[n],q=h[p]-g,s=h[p+1]-l,r=h[p+
2]-m,q=Math.sqrt(q*q+s*s+r*r)/c,s=[h[p],h[p+1],h[p+2]];quat.setAxisAngle(e,k,d*(3*q*q*q*q-4*q*q*q+1));vec3.sub(s,s,a);vec3.transformQuat(s,s,e);vec3.add(s,s,a);h[p]=s[0];h[p+1]=s[1];h[p+2]=s[2]}}},smooth:function(a,b){var c=this.mesh_.vertexArray_,e=a.length,g=new Float32Array(3*e);this.laplacianSmooth(a,g);for(var d=this.d2Move_,h=Math.sqrt(d),f=this.topo_===Sculpt.topo.ADAPTIVE,k=0;k<e;++k){var l=3*a[k],m=3*k,n=(g[m]-c[l])*b,p=(g[m+1]-c[l+1])*b,m=(g[m+2]-c[l+2])*b;if(f){var q=n*n+p*p+m*m;q>d&&(q=
h/Math.sqrt(q),n*=q,p*=q,m*=q)}c[l]+=n;c[l+1]+=p;c[l+2]+=m}},flatten:function(a,b,c,e,g){var d=this.areaNormal(c);if(d){var h=this.areaCenter(c);c=this.mesh_.vertexArray_;e=Math.sqrt(e);var f=b.length;g*=0.3;var k=a[0],l=a[1];a=a[2];for(var m=h[0],n=h[1],h=h[2],p=d[0],q=d[1],d=d[2],s=Math.sqrt(this.d2Move_),r=this.topo_===Sculpt.topo.ADAPTIVE,t=0;t<f;++t){var v=3*b[t],u=c[v],w=c[v+1],y=c[v+2],x=(u-m)*p+(w-n)*q+(y-h)*d,u=u-k,w=w-l,y=y-a,y=Math.sqrt(u*u+w*w+y*y)/e,y=3*y*y*y*y-4*y*y*y+1,y=r?Math.min(s,
x*g*y):x*g*y;c[v]-=p*y;c[v+1]-=q*y;c[v+2]-=d*y}}},pinch:function(a,b,c,e){var g=this.mesh_.vertexArray_;c=Math.sqrt(c);var d=b.length,h=a[0],f=a[1];a=a[2];var k=Math.sqrt(this.d2Move_),l=this.topo_===Sculpt.topo.ADAPTIVE;e*=0.05;for(var m=0;m<d;++m){var n=3*b[m],p=g[n],q=g[n+1],s=g[n+2],r=p-h,t=q-f,v=s-a,r=Math.sqrt(r*r+t*t+v*v)/c,r=3*r*r*r*r-4*r*r*r+1,r=l?Math.min(k,e*r):e*r;g[n]+=(h-p)*r;g[n+1]+=(f-q)*r;g[n+2]+=(a-s)*r}},crease:function(a,b,c,e,g){var d=this.areaNormal(c);if(d){c=this.mesh_.vertexArray_;
e=Math.sqrt(e);var h=b.length,f=a[0],k=a[1];a=a[2];var l=d[0],m=d[1],d=d[2],n=Math.sqrt(this.d2Move_),p=this.topo_===Sculpt.topo.ADAPTIVE;g*=0.05;var q=5E3;this.negative_&&(q=-5E3);for(var s=0;s<h;++s){var r=3*b[s],t=c[r],v=c[r+1],u=c[r+2],w=t-f,y=v-k,x=u-a,w=Math.sqrt(w*w+y*y+x*x)/e,x=3*w*w*w*w-4*w*w*w+1,x=g*x,z=q*x*x,w=(f-t+l*z)*x,y=(k-v+m*z)*x,x=(a-u+d*z)*x;p&&(t=w*w+y*y+x*x,t>d2Move&&(t=n/Math.sqrt(t),w*=t,y*=t,x*=t));c[r]+=w;c[r+1]+=y;c[r+2]+=x}}},smoothFlat:function(a,b){var c=this.mesh_,e=
c.vertexArray_,c=c.normalArray_,g=a.length,d=new Float32Array(3*g);this.laplacianSmooth(a,d);for(var h=0;h<g;++h){var f=3*a[h],k=e[f],l=e[f+1],m=e[f+2],n=c[f],p=c[f+1],q=c[f+2],s=3*h,r=d[s],t=d[s+1],s=d[s+2],v=n*(r-k)+p*(t-l)+q*(s-m);e[f]+=(r-n*v-k)*b;e[f+1]+=(t-p*v-l)*b;e[f+2]+=(s-q*v-m)*b}},laplacianSmooth:function(a,b){for(var c=this.mesh_,e=c.vertices_,c=c.vertexArray_,g=a.length,d=0;d<g;++d){var h=3*d,f=e[a[d]],k=f.ringVertices_,l=k.length,m=0,n=0,p=0,q=0,s=0;if(l!==f.tIndices_.length){for(q=
f=0;q<l;++q){var s=k[q],r=e[s];r.ringVertices_.length!==r.tIndices_.length&&(s*=3,m+=c[s],n+=c[s+1],p+=c[s+2],++f)}b[h]=m/f;b[h+1]=n/f;b[h+2]=p/f}else{for(q=0;q<l;++q)s=3*k[q],m+=c[s],n+=c[s+1],p+=c[s+2];b[h]=m/l;b[h+1]=n/l;b[h+2]=p/l}}},areaNormal:function(a){for(var b=this.mesh_.normalArray_,c=a.length,e=0,g=0,d=0,h=0;h<c;++h)var f=3*a[h],e=e+b[f],g=g+b[f+1],d=d+b[f+2];a=Math.sqrt(e*e+g*g+d*d);if(0===a)return null;a=1/a;return[e*a,g*a,d*a]},areaCenter:function(a){for(var b=this.mesh_.vertexArray_,
c=a.length,e=0,g=0,d=0,h=0;h<c;++h)var f=3*a[h],e=e+b[f],g=g+b[f+1],d=d+b[f+2];return[e/c,g/c,d/c]}};var Tools={nextHighestPowerOfTwo:function(a){--a;for(var b=1;32>b;b<<=1)a|=a>>b;return a+1},tidy:function(a){a.sort(function(a,b){return a-b});for(var b=a.length,c=0,e=0,c=1;c<b;++c)a[e]!==a[c]&&(a[++e]=a[c]);1<c&&(a.length=e+1)},intersectionArrays:function(a,b){for(var c=0,e=0,g=[],d=a.length,h=b.length;c<d&&e<h;)a[c]<b[e]?c++:a[c]>b[e]?e++:(g.push(a[c]),++c,++e);return g}};"function"!==typeof String.prototype.endsWith&&(String.prototype.endsWith=function(a){return this.slice(-a.length)===a});
"function"!==typeof String.prototype.startsWith&&(String.prototype.startsWith=function(a){return this.slice(0,a.length)===a});Array.prototype.rotate=function(){return function(a){a=-a;var b=this.length;a=(Math.abs(a)>=b&&(a%=b),0>a&&(a+=b),a);for(var c,e;a;a=(Math.ceil(b/a)-1)*a-b+(b=a))for(c=b;c>a;e=this[--c],this[c]=this[c-a],this[c-a]=e);return this}}();function Topology(a){this.states_=a;this.mesh_=null;this.center_=[0,0,0];this.verticesMap_={};this.radiusSquared_=0;this.iTrisToDelete_=[];this.iVertsToDelete_=[];this.iVertsDecimated_=[]};Topology.prototype.subdivision=function(a,b){var c=this.mesh_.triangles_,e=0;do e=c.length,a=this.subdivide(a,b);while(e!==c.length);return a};
Topology.prototype.subdivide=function(a,b){var c=this.mesh_,e=c.vertices_,g=c.triangles_,d=e.length,h=g.length,f=[],k=[];this.verticesMap_={};this.initSplit(a,f,k,b);20<f.length&&c.expandsTriangles(f,3);this.states_.pushState(f,c.getVerticesFromTriangles(f));k.length=f.length;this.checkArrayLength(f.length);this.subdivideTriangles(f,k,b);for(var k=[],l=g.length,f=0,f=h;f<l;++f)k.push(f);c.expandsTriangles(k,1);f=k.slice(l-h);this.states_.pushState(f,c.getVerticesFromTriangles(f));a.push.apply(a,k);
for(var h=[],l=a.length,m=++Triangle.tagMask_,f=0;f<l;++f){var n=a[f],p=g[n];p.tagFlag_!==m&&(p.tagFlag_=m,h.push(n))}for(f=g.length;0<k.length;)k=this.fillTriangles(k);for(l=g.length;f<l;++f)h.push(f);g=[];k=e.length;for(f=d;f<k;++f)g.push(f);d=g.length;c.expandsVertices(g,1);f=new Sculpt;f.mesh_=c;f.smoothFlat(g.slice(d),1);for(var c=this.mesh_.vertexArray_,f=this.center_,k=f[0],l=f[1],m=f[2],n=Vertex.sculptMask_,d=g.length,q=0,f=0;f<d;++f){var p=g[f],q=3*p,s=c[q]-k,r=c[q+1]-l,q=c[q+2]-m;e[p].sculptFlag_=
s*s+r*r+q*q<this.radiusSquared_?n:n-1}return h};
Topology.prototype.checkArrayLength=function(a){var b=this.mesh_,c=b.triangles_,e=b.vertexArray_,g=b.normalArray_,d=b.indexArray_,h=0,f=3*b.vertices_.length+200*a;if(e.length<f){b=new Float32Array(2*f);f=e.length;for(h=0;h<f;++h)b[h]=e[h];this.mesh_.vertexArray_=b;b=new Float32Array(2*f);for(h=0;h<f;++h)b[h]=g[h];this.mesh_.normalArray_=b}a=3*c.length+200*a;if(d.length<a){b=new SculptGL.indexArrayType(2*a);a=d.length;for(h=0;h<a;++h)b[h]=d[h];this.mesh_.indexArray_=b}};
Topology.prototype.initSplit=function(a,b,c,e){for(var g=a.length,d=0;d<g;++d){switch(this.findSplit(a[d],e,!0)){case 1:c.push(1);break;case 2:c.push(2);break;case 3:c.push(3);break;default:continue}b.push(a[d])}};
Topology.prototype.findSplit=function(a,b,c){var e=this.mesh_,g=e.vertexArray_,e=e.indexArray_,d=3*a;a=e[d+1];var h=e[d+2],d=3*e[d],e=[g[d],g[d+1],g[d+2]],d=3*a;a=[g[d],g[d+1],g[d+2]];d=3*h;g=[g[d],g[d+1],g[d+2]];if(c&&!Geometry.sphereIntersectTriangle(this.center_,2*this.radiusSquared_,e,a,g)&&!Geometry.pointInsideTriangle(this.center_,e,a,g))return 0;d=[0,0,0];c=vec3.sqrLen(vec3.sub(d,e,a));a=vec3.sqrLen(vec3.sub(d,a,g));e=vec3.sqrLen(vec3.sub(d,e,g));return c>a&&c>e?c>b?1:0:a>e?a>b?2:0:e>b?3:0};
Topology.prototype.subdivideTriangles=function(a,b,c){for(var e=this.mesh_.indexArray_,g=a.length,d=0;d<g;++d){var h=3*a[d];if(1===b[d])this.halfEdgeSplit(a[d],e[h],e[h+1],e[h+2]);else if(2===b[d])this.halfEdgeSplit(a[d],e[h+1],e[h+2],e[h]);else if(3===b[d])this.halfEdgeSplit(a[d],e[h+2],e[h],e[h+1]);else{var f=this.findSplit(a[d],c);1===f?this.halfEdgeSplit(a[d],e[h],e[h+1],e[h+2]):2===f?this.halfEdgeSplit(a[d],e[h+1],e[h+2],e[h]):3===f&&this.halfEdgeSplit(a[d],e[h+2],e[h],e[h+1])}}};
Topology.prototype.halfEdgeSplit=function(a,b,c,e){var g=this.mesh_,d=g.vertices_,h=g.triangles_,f=g.vertexArray_,k=g.normalArray_,l=g.indexArray_,m=h[a].leaf_,g=m.iTris_,n=d[b],p=d[c],q=d[e],s=this.verticesMap_,r=[Math.min(b,c),Math.max(b,c)],t=!1,v=s[r];void 0===v&&(v=d.length,t=!0,s[r]=v);q.ringVertices_.push(v);var u=3*a;l[u]=b;l[u+1]=v;l[u+2]=e;s=h.length;r=new Triangle(s);u=3*s;l[u]=v;l[u+1]=c;l[u+2]=e;r.stateFlag_=Mesh.stateMask_;q.tIndices_.push(s);p.replaceTriangle(a,s);r.leaf_=m;r.posInLeaf_=
g.length;if(t){var w=d.length,l=new Vertex(w),u=3*b,m=f[u],q=f[u+1],t=f[u+2],y=k[u],x=k[u+1],z=k[u+2],u=3*c,E=f[u],F=f[u+1],A=f[u+2],B=k[u],C=k[u+1],G=k[u+2],u=y*B+x*C+z*G,H=0,H=-1>=u?Math.PI:1<=u?0:Math.acos(u),I=y+B,J=x+C,K=z+G,D=1/Math.sqrt(I*I+J*J+K*K),u=3*w;k[u]=I*D;k[u+1]=J*D;k[u+2]=K*D;w=m-E;I=q-F;J=t-A;D=Math.sqrt(w*w+I*I+J*J);0<w*(y-B)+I*(x-C)+J*(z-G)?(f[u]=0.5*(m+E)+0.12*k[u]*H*D,f[u+1]=0.5*(q+F)+0.12*k[u+1]*H*D,f[u+2]=0.5*(t+A)+0.12*k[u+2]*H*D):(f[u]=0.5*(m+E)-0.12*k[u]*H*D,f[u+1]=0.5*
(q+F)-0.12*k[u+1]*H*D,f[u+2]=0.5*(t+A)-0.12*k[u+2]*H*D);l.stateFlag_=Mesh.stateMask_;l.ringVertices_.push(b,c,e);n.replaceRingVertex(c,v);p.replaceRingVertex(b,v);l.tIndices_.push(a,s);d.push(l)}else b=d[v],b.ringVertices_.push(e),b.tIndices_.push(a,s);g.push(s);h.push(r)};
Topology.prototype.fillTriangles=function(a){for(var b=this.mesh_,c=b.vertices_,e=b.triangles_,b=b.indexArray_,g=a.length,d=[],h=0;h<g;++h){var f=a[h],k=3*f,l=b[k],m=b[k+1],k=b[k+2],n=this.verticesMap_,p=n[[Math.min(l,m),Math.max(l,m)]],q=n[[Math.min(m,k),Math.max(m,k)]],n=n[[Math.min(l,k),Math.max(l,k)]],s=c[l].ringVertices_.length,r=c[m].ringVertices_.length,t=c[k].ringVertices_.length,v=0;p?v=q?n?s<r&&s<t?2:r<t?3:1:s<t?2:1:n&&r<t?3:1:q?v=n&&r<s?3:2:n&&(v=3);if(1===v)this.fillTriangle(f,l,m,k,p);
else if(2===v)this.fillTriangle(f,m,k,l,q);else if(3===v)this.fillTriangle(f,k,l,m,n);else continue;d.push(f,e.length-1)}return d};
Topology.prototype.fillTriangle=function(a,b,c,e,g){var d=this.mesh_,h=d.vertices_,f=d.triangles_,d=d.indexArray_,k=3*a;d[k]=b;d[k+1]=g;d[k+2]=e;b=f[a].leaf_;var l=b.iTris_,m=h[c],n=h[e],k=h[g];k.ringVertices_.push(e);n.ringVertices_.push(g);h=f.length;k.tIndices_.push(a,h);var p=new Triangle(h),k=3*h;d[k]=g;d[k+1]=c;d[k+2]=e;p.stateFlag_=Mesh.stateMask_;p.leaf_=b;p.posInLeaf_=l.length;n.tIndices_.push(h);m.replaceTriangle(a,h);l.push(h);f.push(p)};Topology.prototype.decimation=function(a,b){for(var c=0,e=this.radiusSquared_,g=Math.sqrt(e),d=this.mesh_,h=d.triangles_,f=d.vertexArray_,d=d.indexArray_,k=this.center_,l=k[0],m=k[1],k=k[2],n=0;n<a.length;++n){var p=a[n];if(!(0>h[p].tagFlag_)){var c=3*p,q=d[c],s=d[c+1],r=d[c+2],c=3*q,t=f[c],v=f[c+1],u=f[c+2],c=3*s,w=f[c],y=f[c+1],x=f[c+2],c=3*r,z=f[c],E=f[c+1],F=f[c+2],A=(t+w+z)/3-l,B=(v+y+E)/3-m,C=(u+x+F)/3-k,c=A*A+B*B+C*C;if(c<e)c=1;else if(c<2*e)c=(Math.sqrt(c)-g)/(g*Math.SQRT2-g),c=3*c*c*c*c-
4*c*c*c+1;else continue;var A=w-t,B=y-v,C=x-u,G=A*A+B*B+C*C,A=w-z,B=y-E,C=x-F,w=A*A+B*B+C*C,A=t-z,B=v-E,C=u-F,t=A*A+B*B+C*C;G<w&&G<t?G<b*c&&this.decimateTriangles(p,this.findOppositeTriangle(p,q,s),a):w<t?w<b*c&&this.decimateTriangles(p,this.findOppositeTriangle(p,s,r),a):t<b*c&&this.decimateTriangles(p,this.findOppositeTriangle(p,q,r),a)}}this.applyDeletion();return this.getValidModifiedTriangles(this.getValidModifiedVertices(),a)};
Topology.prototype.applyDeletion=function(){var a=this.iTrisToDelete_;Tools.tidy(a);for(var b=0,b=a.length-1;0<=b;--b)this.deleteTriangle(a[b]);a=this.iVertsToDelete_;Tools.tidy(a);for(b=a.length-1;0<=b;--b)this.deleteVertex(a[b])};Topology.prototype.getValidModifiedVertices=function(){for(var a=this.mesh_.vertices_,b=this.iVertsDecimated_,c=b.length,e=a.length,g=++Vertex.tagMask_,d=[],h=0;h<c;++h){var f=b[h];if(!(f>=e)){var k=a[f];k.tagFlag_!==g&&(k.tagFlag_=g,d.push(f))}}return d};
Topology.prototype.getValidModifiedTriangles=function(a,b){var c=this.mesh_,e=c.triangles_,c=c.getTrianglesFromVertices(a);b.push.apply(b,c);for(var c=[],g=b.length,d=e.length,h=++Triangle.tagMask_,f=0;f<g;++f){var k=b[f];if(!(k>=d)){var l=e[k];l.tagFlag_!==h&&(l.tagFlag_=h,c.push(k))}}return c};
Topology.prototype.findOppositeTriangle=function(a,b,c){var e=this.mesh_.vertices_;b=e[b].tIndices_;c=e[c].tIndices_;b.sort(function(a,b){return a-b});c.sort(function(a,b){return a-b});c=Tools.intersectionArrays(b,c);return 2!==c.length?-1:c[0]===a?c[1]:c[0]};
Topology.prototype.decimateTriangles=function(a,b,c){if(-1!==b){var e=this.mesh_.indexArray_,g=3*a,d=e[g],h=e[g+1],f=e[g+2],g=3*b,k=e[g],l=e[g+1],e=e[g+2];d===k?h===e?this.edgeCollapse(a,b,d,h,f,l,c):this.edgeCollapse(a,b,d,f,h,e,c):d===l?h===k?this.edgeCollapse(a,b,d,h,f,e,c):this.edgeCollapse(a,b,d,f,h,k,c):d===e?h===l?this.edgeCollapse(a,b,d,h,f,k,c):this.edgeCollapse(a,b,d,f,h,l,c):h===k?this.edgeCollapse(a,b,f,h,d,l,c):h===l?this.edgeCollapse(a,b,f,h,d,e,c):this.edgeCollapse(a,b,f,h,d,k,c)}};
Topology.prototype.edgeCollapse=function(a,b,c,e,g,d,h){var f=this.mesh_,k=f.vertices_,l=f.triangles_,m=f.vertexArray_,n=f.normalArray_,p=f.indexArray_,q=k[c],s=k[e],r=q.ringVertices_,t=s.ringVertices_,v=q.tIndices_,u=s.tIndices_,w=k[g],y=k[d];if(r.length===v.length&&t.length===u.length&&w.ringVertices_.length===w.tIndices_.length&&y.ringVertices_.length===y.tIndices_.length)if(this.iVertsDecimated_.push(c,e),this.states_.pushState(v,r),this.states_.pushState(u,t),r.sort(function(a,b){return a-b}),
t.sort(function(a,b){return a-b}),k=0,3<=Tools.intersectionArrays(r,t).length)q.removeTriangle(b),s.removeTriangle(a),w.tIndices_.push(b),y.tIndices_.push(a),k=3*a,p[k]===e?p[k]=d:p[k+1]===e?p[k+1]=d:p[k+2]=d,k=3*b,p[k]===c?p[k]=g:p[k+1]===c?p[k+1]=g:p[k+2]=g,f.computeRingVertices(c),f.computeRingVertices(e),f.computeRingVertices(g),f.computeRingVertices(d),this.cleanUpSingularVertex(c),this.cleanUpSingularVertex(e),this.cleanUpSingularVertex(g),this.cleanUpSingularVertex(d);else{var k=3*c,x=3*e;
g=n[k]+n[x];d=n[k+1]+n[x+1];var x=n[k+2]+n[x+2],z=1/Math.sqrt(g*g+d*d+x*x);g*=z;d*=z;x*=z;n[k]=g;n[k+1]=d;n[k+2]=x;r.push.apply(r,t);q.removeTriangle(a);q.removeTriangle(b);s.removeTriangle(a);s.removeTriangle(b);w.removeTriangle(a);y.removeTriangle(b);v.push.apply(v,u);q=u.length;for(n=n=0;n<q;++n)t=3*u[n],p[t]===e?p[t]=c:p[t+1]===e?p[t+1]=c:p[t+2]=c;f.computeRingVertices(c);q=u=p=0;t=r.length;for(n=0;n<t;++n)w=r[n],f.computeRingVertices(w),w*=3,p+=m[w],u+=m[w+1],q+=m[w+2];p/=t;u/=t;q/=t;f=g*(p-
m[k])+d*(u-m[k+1])+x*(q-m[k+2]);m[k]=p-g*f;m[k+1]=u-d*f;m[k+2]=q-x*f;s.tagFlag_=-1;l[a].tagFlag_=-1;l[b].tagFlag_=-1;this.iVertsToDelete_.push(e);this.iTrisToDelete_.push(a,b);h.push.apply(h,v);this.cleanUpSingularVertex(c)}};
Topology.prototype.deleteTriangle=function(a){var b=0,c=this.mesh_,e=c.vertices_,g=c.triangles_,d=c.vertexArray_,h=c.normalArray_,c=c.indexArray_,f=g[a],b=f.posInLeaf_,f=f.leaf_.iTris_,k=f[f.length-1];a!==k&&(f[b]=k,g[k].posInLeaf_=b);f.pop();f=g.length-1;if(f!==a){var k=g[f],b=3*f,l=c[b],m=c[b+1],n=c[b+2],p=Mesh.stateMask_,q=this.states_.undos_[this.states_.curUndoIndex_];k.stateFlag_!==p&&(k.stateFlag_=p,q.tState_.push(k.clone()),q.iArState_.push(l,m,n));k.id_=a;k.leaf_.iTris_[k.posInLeaf_]=a;var s=
e[l],r=e[m],e=e[n];s.stateFlag_!==p&&(b=3*l,s.stateFlag_=p,q.vState_.push(s.clone()),q.vArState_.push(d[b],d[b+1],d[b+2]),q.nArState_.push(h[b],h[b+1],h[b+2]));r.stateFlag_!==p&&(b=3*m,r.stateFlag_=p,q.vState_.push(r.clone()),q.vArState_.push(d[b],d[b+1],d[b+2]),q.nArState_.push(h[b],h[b+1],h[b+2]));e.stateFlag_!==p&&(b=3*n,e.stateFlag_=p,q.vState_.push(e.clone()),q.vArState_.push(d[b],d[b+1],d[b+2]),q.nArState_.push(h[b],h[b+1],h[b+2]));s.replaceTriangle(f,a);r.replaceTriangle(f,a);e.replaceTriangle(f,
a);this.iVertsDecimated_.push(l,m,n);g[a]=k;a*=3;c[a]=l;c[a+1]=m;c[a+2]=n}g.pop()};
Topology.prototype.deleteVertex=function(a){var b=this.mesh_,c=b.vertices_,e=b.triangles_,g=b.vertexArray_,d=b.normalArray_,h=b.indexArray_,b=c.length-1;if(a!==b){var f=0,k=c[b],f=3*b,l=g[f],m=g[f+1],n=g[f+2],p=d[f],q=d[f+1],s=d[f+2],r=Mesh.stateMask_,t=this.states_.undos_[this.states_.curUndoIndex_];k.stateFlag_!==r&&(k.stateFlag_=r,t.vState_.push(k.clone()),t.vArState_.push(l,m,n),t.nArState_.push(p,q,s));k.id_=a;for(var v=k.tIndices_,u=k.ringVertices_,w=v.length,y=u.length,x=0,x=0;x<w;++x){var f=
v[x],z=e[f],f=3*f;z.stateFlag_!==r&&(z.stateFlag_=r,t.tState_.push(z.clone()),t.iArState_.push(h[f],h[f+1],h[f+2]));h[f]===b?h[f]=a:h[f+1]===b?h[f+1]=a:h[f+2]=a}for(x=0;x<y;++x)f=u[x],e=c[f],e.stateFlag_!==r&&(f*=3,e.stateFlag_=r,t.vState_.push(e.clone()),t.vArState_.push(g[f],g[f+1],g[f+2]),t.nArState_.push(d[f],d[f+1],d[f+2])),e.replaceRingVertex(b,a);c[a]=k;f=3*a;g[f]=l;g[f+1]=m;g[f+2]=n;d[f]=p;d[f+1]=q;d[f+2]=s}c.pop()};Topology.prototype.adaptTopology=function(a,b){for(var c=this.mesh_,e=c.triangles_,g=c.vertexArray_,d=this.radiusSquared_,h=c.getVerticesFromTriangles(a),f=h.length,k=[],l=c.vertices_.length,m=0,n=0,m=this.center_,p=m[0],q=m[1],s=m[2],r=0,t=0,m=n=0;m<f;++m){var v=h[m];v>=l||(n=3*v,r=g[n]-p,t=g[n+1]-q,n=g[n+2]-s,r*r+t*t+n*n<d&&k.push(v))}this.checkCollisions(k,b);m=c.getTrianglesFromVertices(this.iVertsDecimated_);a.push.apply(a,m);c=[];g=a.length;d=e.length;++Triangle.tagMask_;h=Triangle.tagMask_;
for(m=0;m<g;++m)f=a[m],f>=d||(k=e[f],k.tagFlag_!==h&&(k.tagFlag_=h,c.push(f)));return c};
Topology.prototype.checkCollisions=function(a,b){var c=this.mesh_,e=c.vertices_,g=c.vertexArray_,d=0;this.iVertsDecimated_=[];this.iTrisToDelete_=[];this.iVertsToDelete_=[];var h=0.25*b,f=new Aabb,k=a.length;0<k&&(d=3*a[0],f.min_=[g[d],g[d+1],g[d+2]],f.max_=[g[d],g[d+1],g[d+2]]);for(var l=0,m=0,l=0;l<k;++l)d=3*a[l],f.expandsWithPoint(g[d],g[d+1],g[d+2]);var n=new Grid;n.setBoundaries(f);n.init(Math.sqrt(h));n.build(c,a);for(l=0;l<k;++l)if(f=a[l],d=e[f],!(0>d.tagFlag_)){var d=d.ringVertices_,p=d.length;
++Vertex.tagMask_;for(m=0;m<p;++m)e[d[m]].tagFlag_=Vertex.tagMask_;for(var d=3*f,q=g[d],s=g[d+1],r=g[d+2],t=n.getNeighborhood(q,s,r),v=t.length,m=0;m<v;++m){var u=t[m];if(f!==u){var w=e[u];if(!(0>w.tagFlag_||w.tagFlag_===Vertex.tagMask_)){var d=3*u,y=q-g[d],x=s-g[d+1],d=r-g[d+2];if(y*y+x*x+d*d<h){p>w.ringVertices_.length?this.vertexJoin(f,u):this.vertexJoin(u,f);break}}}}}this.applyDeletion();h=this.iVertsDecimated_=this.getValidModifiedVertices();k=h.length;g=[];n=Vertex.sculptMask_;for(l=0;l<k;++l)d=
h[l],e[d].sculptFlag_===n&&g.push(d);e=new Sculpt;e.mesh_=c;c.expandsVertices(g,1);e.smooth(g,1)};
Topology.prototype.vertexJoin=function(a,b){var c=this.mesh_,e=c.vertices_,g=c.vertexArray_,d=c.normalArray_,h=e[a],e=e[b],f=h.tIndices_,k=e.tIndices_,l=h.ringVertices_.slice(0),m=e.ringVertices_.slice(0),n=l.length,p=m.length,q=Mesh.stateMask_;this.states_.pushState(f,l);this.states_.pushState(k,m);f=this.states_.undos_[this.states_.curUndoIndex_];k=0;h.stateFlag_!==q&&(k=3*a,h.stateFlag_=q,f.vState_.push(h.clone()),f.vArState_.push(g[k],g[k+1],g[k+2]),f.nArState_.push(d[k],d[k+1],d[k+2]));e.stateFlag_!==
q&&(k=3*b,h.stateFlag_=q,f.vState_.push(e.clone()),f.vArState_.push(g[k],g[k+1],g[k+2]),f.nArState_.push(d[k],d[k+1],d[k+2]));g=[];d=[];this.trianglesRotate(h.tIndices_,a,g);if(this.adjustEdgeOrientation(g)&&(this.trianglesRotate(e.tIndices_,b,d),this.adjustEdgeOrientation(d))){l.sort(function(a,b){return a-b});m.sort(function(a,b){return a-b});q=Tools.intersectionArrays(l,m);0===q.length?this.connect1Ring(g,d):this.connect1RingCommonVertices(g,d,q);for(g=g=0;g<n;++g)c.computeRingVertices(l[g]);for(g=
0;g<p;++g)c.computeRingVertices(m[g]);this.iVertsDecimated_.push(a,b);this.iVertsToDelete_.push(a,b);h.tagFlag_=-1;e.tagFlag_=-1;this.cleanUpNeighborhood(l,m)}};
Topology.prototype.connect1RingCommonVertices=function(a,b,c){var e=this.mesh_,g=e.vertices_,d=e.triangles_,e=a.length,h=b.length,f=c.length,k=0;++Vertex.tagMask_;for(var l=Vertex.tagMask_,k=0;k<f;++k)g[c[k]].tagFlag_=l;for(var f=this.iTrisToDelete_,m=null,n=null,p=0,k=0;k<e;++k)m=g[a[k].v1],n=g[a[k].v2],m.tagFlag_===l&&n.tagFlag_===l&&(p=a[k].t,m.removeTriangle(p),n.removeTriangle(p),d[p].tagFlag_=-1,f.push(p));for(k=0;k<h;++k)m=g[b[k].v1],n=g[b[k].v2],m.tagFlag_===l&&n.tagFlag_===l&&(p=b[k].t,m.removeTriangle(p),
n.removeTriangle(p),d[p].tagFlag_=-1,f.push(p));d=[];f=[];d.push([]);f.push([]);this.matchEdgesCommonVertices(a,b,c[0]);for(k=0;k<e;++k)m=g[a[k].v1],n=g[a[k].v2],(m.tagFlag_!==l||n.tagFlag_!==l)&&d[d.length-1].push(a[k]),n.tagFlag_===l&&0!==d[d.length-1].length&&d.push([]);for(k=0;k<h;++k)m=g[b[k].v1],n=g[b[k].v2],(m.tagFlag_!==l||n.tagFlag_!==l)&&f[f.length-1].push(b[k]),n.tagFlag_===l&&0!==f[f.length-1].length&&f.push([]);0===d[d.length-1].length&&d.pop();0===f[f.length-1].length&&f.pop();b=d.length;
c=f.length-1;for(l=h=g=0;g<b||0<=c;)if(l=h=-1,g<b&&(h=d[g][0].v1),0<=c&&(l=f[c][f[c].length-1].v2),h===l)d[g].length>f[c].length?this.connectLinkedEdges(d[g],f[c]):this.connectLinkedEdges(f[c],d[g]),++g,--c;else for(k=0;k<e;++k)if(m=a[k].v1,m===h){this.connectLoop(d[g]);++g;break}else if(m===l){this.connectLoop(f[c]);--c;break}};
Topology.prototype.connect1Ring=function(a,b){var c=this.mesh_,e=c.vertices_,c=c.indexArray_;this.matchEdgesNearest(a,b);var g=a.length,d=b.length,h=d/g,f=0;g===d&&(f=-1);for(var k=0,l=0,k=0;k<g;++k)l=0,0!==k&&(l=Math.floor(d-h*k)),c[3*a[k].t+2]=b[l].v1,e[b[l].v1].tIndices_.push(a[k].t),l!==f&&(c[3*b[l].t+2]=a[k].v1,e[a[k].v1].tIndices_.push(b[l].t)),f=l};
Topology.prototype.connectLinkedEdges=function(a,b){var c=this.mesh_,e=c.vertices_,g=c.triangles_,c=c.indexArray_,d=a.length,h=b.length,f=b[0],k=f.t;e[f.v1].removeTriangle(k);e[f.v2].removeTriangle(k);var f=b[h-1],l=f.t;e[f.v1].removeTriangle(l);e[f.v2].removeTriangle(l);for(var f=h/d,m=0,n=0,p=0,n=0;n<d;++n)p=Math.floor(h-f*(n+1)),1>p&&(p=1),c[3*a[n].t+2]=b[p].v1,e[b[p].v1].tIndices_.push(a[n].t),p!==m&&p!==h-1&&(c[3*b[p].t+2]=a[n].v1,e[a[n].v1].tIndices_.push(b[p].t)),m=p;g[k].tagFlag_=-1;g[l].tagFlag_=
-1;this.iTrisToDelete_.push(k,l)};Topology.prototype.connectLoop=function(a){var b=this.mesh_,c=b.vertices_,e=b.indexArray_,g=a.length,d=a[0],h=d.t,f=d.v1;c[f].removeTriangle(h);c[d.v2].removeTriangle(h);c=c[f];for(d=1;d<g;++d){var k=a[d].t;e[3*k+2]=f;c.tIndices_.push(k)}b.triangles_[h].tagFlag_=-1;this.iTrisToDelete_.push(h)};
Topology.prototype.trianglesRotate=function(a,b,c){for(var e=this.mesh_.indexArray_,g=a.length,d=0,h=0,f=0,k=0,l=0;l<g;++l)d=3*a[l],h=e[d],f=e[d+1],k=e[d+2],k!==b&&(h===b?(e[d]=f,e[d+1]=k):(e[d+1]=h,e[d]=k),e[d+2]=b),c.push({v1:e[d],v2:e[d+1],t:a[l]})};
Topology.prototype.adjustEdgeOrientation=function(a){for(var b=a.length,c=0,e=-1,g=a[0].v1,d=0,h=0,d=0;d<b-1;d++){c=a[d].v2;e=-1;for(h=d+1;h<b;++h)if(a[h].v1===c)if(a[h].v2!==g)e=h;else{c=a[d+1];a[d+1]=a[h];a[h]=c;++d;d+1<b&&(g=a[d+1].v1);break}if(h===b){if(-1===e)return!1;c=a[d+1];a[d+1]=a[e];a[e]=c}}return!0};
Topology.prototype.matchEdgesCommonVertices=function(a,b,c){for(var e=a.length,g=-1,d=0,d=0;d<e;++d)if(a[d].v1===c){g=d;break}a.rotate(g);a=b.length;g=-1;for(d=0;d<a;++d)if(b[d].v1===c){g=d;break}b.rotate(g)};Topology.prototype.matchEdgesNearest=function(a,b){for(var c=this.mesh_.vertexArray_,e=0,g=3*a[0].v1,d=c[g],h=c[g+1],f=c[g+2],g=3*b[0].v1,k=d-c[g],l=h-c[g+1],g=f-c[g+2],m=k*k+l*l+g*g,n=b.length,p=1;p<n;++p)g=3*b[p].v1,k=d-c[g],l=h-c[g+1],g=f-c[g+2],k=k*k+l*l+g*g,k<m&&(m=k,e=p);b.rotate(e)};
Topology.prototype.cleanUpNeighborhood=function(a,b){for(var c=a.length,e=0,e=0;e<c;++e)this.cleanUpSingularVertex(a[e]);c=b.length;for(e=0;e<c;++e)this.cleanUpSingularVertex(b[e])};
Topology.prototype.cleanUpSingularVertex=function(a){var b=this.mesh_,c=b.vertices_,e=b.vertexArray_,g=b.normalArray_,d=b.indexArray_,h=c[a];if(!(0>h.tagFlag_)){var f=0,f=3*a,k=e[f],l=e[f+1],m=e[f+2],n=g[f],p=g[f+1],q=g[f+2];this.states_.pushState(h.tIndices_,h.ringVertices_);var s=Mesh.stateMask_,r=this.states_.undos_[this.states_.curUndoIndex_];h.stateFlag_!==s&&(h.stateFlag_=s,r.vState_.push(h.clone()),r.vArState_.push(k,l,m),r.nArState_.push(n,p,q));if(!this.deleteVertexIfDegenerate(a)){var t=
[];this.trianglesRotate(h.tIndices_,a,t);if(this.adjustEdgeOrientation(t)){for(var r=t.length,v=t[0].v1,u=-1,f=0,f=1;f<r-1;++f)if(t[f].v2===v){u=f;break}if(-1!==u){this.checkArrayLength(1);r=c.length;v=new Vertex(r);v.stateFlag_=s;f=3*r;e[f]=k;e[f+1]=l;e[f+2]=m;g[f]=-n;g[f+1]=-p;g[f+2]=-q;for(f=0;f<=u;++f)e=t[f].t,v.tIndices_.push(e),h.removeTriangle(e),d[3*e+2]=r;c.push(v);b.computeRingVertices(a);b.computeRingVertices(r);c=v.ringVertices_;d=c.length;for(f=0;f<d;++f)b.computeRingVertices(c[f]);h=
h.ringVertices_;c=h.length;for(f=0;f<c;++f)b.computeRingVertices(h[f]);this.iVertsDecimated_.push(a,r);h=[];h.push(a,r);f=new Sculpt;f.mesh_=b;f.smooth(h,1);this.cleanUpSingularVertex(a);this.cleanUpSingularVertex(r)}}}}};
Topology.prototype.deleteVertexIfDegenerate=function(a){var b=this.mesh_,c=b.vertices_,e=b.triangles_,g=b.indexArray_,d=c[a];if(0>d.tagFlag_)return!0;Tools.tidy(d.tIndices_);var h=d.tIndices_.length,f=0,k=f=0;if(0===h)return d.tagFlag_=-1,this.iVertsToDelete_.push(a),this.iVertsDecimated_.push(a),!0;if(1===h){var h=d.tIndices_[0],f=3*h,l=[];l.push(g[f],g[f+1],g[f+2]);Tools.tidy(l);g=l.length;for(f=0;f<g;++f)k=l[f],k!==a&&(c[k].removeTriangle(h),b.computeRingVertices(k));d.tagFlag_=-1;e[h].tagFlag_=
-1;this.iTrisToDelete_.push(h);this.iVertsToDelete_.push(a);this.iVertsDecimated_.push(a);for(f=0;f<g;++f)k=l[f],k!==a&&3>c[k].tIndices_.length&&this.deleteVertexIfDegenerate(k);return!0}if(2===h){h=d.tIndices_[0];f=3*h;l=[];l.push(g[f],g[f+1],g[f+2]);Tools.tidy(l);for(var m=l.length,f=0;f<m;++f)k=l[f],k!==a&&(c[k].removeTriangle(h),b.computeRingVertices(k));var n=d.tIndices_[1],f=3*n,p=[];p.push(g[f],g[f+1],g[f+2]);Tools.tidy(p);g=p.length;for(f=0;f<g;++f)k=p[f],k!==a&&(c[k].removeTriangle(n),b.computeRingVertices(k));
d.tagFlag_=-1;e[h].tagFlag_=-1;e[n].tagFlag_=-1;this.iTrisToDelete_.push(h,n);this.iVertsToDelete_.push(a);this.iVertsDecimated_.push(a);for(f=0;f<m;++f)k=l[f],k!==a&&3>c[k].tIndices_.length&&this.deleteVertexIfDegenerate(k);for(f=0;f<g;++f)k=p[f],k!==a&&3>c[k].tIndices_.length&&this.deleteVertexIfDegenerate(k);return!0}return!1};function Triangle(a){this.id_=a;this.normal_=[0,0,1];this.aabb_=new Aabb;this.posInLeaf_=this.leaf_=null;this.tagFlag_=1}Triangle.tagMask_=1;Triangle.prototype={clone:function(){var a=new Triangle(this.id_);a.normal_=this.normal_.slice();a.aabb_=this.aabb_.clone();a.leaf_=this.leaf_;a.posInLeaf_=this.posInLeaf_;return a}};function State(){this.nbVerticesState_=this.nbTrianglesState_=0;this.vArState_=[];this.nArState_=[];this.iArState_=[];this.vState_=[];this.tState_=[];this.aabbState_=new Aabb}function States(){this.mesh_=null;this.undos_=[];this.redos_=[];this.curUndoIndex_=0;this.firstState_=!1}
States.prototype={start:function(){++Mesh.stateMask_;var a=this.undos_;this.firstState_?a.length=0:10<a.length&&(a.shift(),--this.curUndoIndex_);this.firstState_=!1;this.redos_.length=0;if(a.length)for(var b=a.length-1;b!==this.curUndoIndex_;)a.pop(),--b;a.push(new State);this.curUndoIndex_=a.length-1;a=a[this.curUndoIndex_];b=this.mesh_;a.nbTrianglesState_=b.triangles_.length;a.nbVerticesState_=b.vertices_.length;a.aabbState_=b.octree_.aabbSplit_.clone()},pushState:function(a,b){this.pushStateTriangles(a);
this.pushStateVertices(b)},pushStateTriangles:function(a){for(var b=this.undos_[this.curUndoIndex_],c=b.iArState_,b=b.tState_,e=this.mesh_,g=e.indexArray_,d=e.triangles_,h=Mesh.stateMask_,f=a.length,e=0,k=b.length,e=0;e<f;++e){var l=d[a[e]];l.stateFlag_!==h&&(l.stateFlag_=h,b.push(l.clone()))}a=b.length;c.length=3*a;h=d=0;for(e=k;e<a;++e)h=3*b[e].id_,d=3*e,c[d]=g[h],c[d+1]=g[h+1],c[d+2]=g[h+2]},pushStateVertices:function(a){for(var b=this.undos_[this.curUndoIndex_],c=b.vArState_,e=b.nArState_,b=b.vState_,
g=this.mesh_,d=g.vertexArray_,h=g.normalArray_,f=g.vertices_,k=Mesh.stateMask_,l=a.length,g=0,m=b.length,g=0;g<l;++g){var n=f[a[g]];n.stateFlag_!==k&&(n.stateFlag_=k,b.push(n.clone()))}a=b.length;c.length=3*a;e.length=3*a;k=f=0;for(g=m;g<a;++g)k=3*b[g].id_,f=3*g,c[f]=d[k],c[f+1]=d[k+1],c[f+2]=d[k+2],e[f]=h[k],e[f+1]=h[k+1],e[f+2]=h[k+2]},undo:function(){if(this.undos_.length&&!this.firstState_){var a=new State,b=this.mesh_;a.nbTrianglesState_=b.triangles_.length;a.nbVerticesState_=b.vertices_.length;
a.aabbState_=b.octree_.aabbSplit_.clone();this.pushRedoTriangles(a);this.pushRedoVertices(a);this.pullUndoTriangles();this.pullUndoVertices();this.recomputeOctree(this.undos_[this.curUndoIndex_].aabbState_);b.updateBuffers();this.redos_.push(a);this.curUndoIndex_?(this.firstState_=!1,--this.curUndoIndex_):this.firstState_=!0}},pushRedoTriangles:function(a){var b=this.mesh_,c=b.indexArray_,e=b.triangles_,g=e.length,b=this.undos_[this.curUndoIndex_],d=b.tState_,h=d.length,f=b.nbTrianglesState_,b=a.iArState_;
a=a.tState_;var k=0,l=0;if(f<g){for(k=f;k<g;++k)a.push(e[k].clone());for(k=0;k<h;++k)l=d[k].id_,l<f&&a.push(e[l].clone());e.length=f}else{e.length=f;for(k=0;k<h;++k)l=d[k].id_,l<g&&a.push(e[l].clone())}e=a.length;b.length=3*e;for(k=g=0;k<e;++k)l=3*a[k].id_,g=3*k,b[g]=c[l],b[g+1]=c[l+1],b[g+2]=c[l+2]},pushRedoVertices:function(a){var b=this.mesh_,c=b.vertexArray_,e=b.normalArray_,g=b.vertices_,d=g.length,b=this.undos_[this.curUndoIndex_],h=b.vState_,f=h.length,k=b.nbVerticesState_,b=a.vArState_,l=
a.nArState_;a=a.vState_;var m=0,n=0;if(k<d){for(m=k;m<d;++m)a.push(g[m].clone());for(m=0;m<f;++m)n=h[m].id_,n<k&&a.push(g[n].clone());g.length=k}else{g.length=k;for(m=0;m<f;++m)n=h[m].id_,n<d&&a.push(g[n].clone())}g=a.length;b.length=3*g;l.length=3*g;for(m=d=0;m<g;++m)n=3*a[m].id_,d=3*m,b[d]=c[n],b[d+1]=c[n+1],b[d+2]=c[n+2],l[d]=e[n],l[d+1]=e[n+1],l[d+2]=e[n+2]},pullUndoTriangles:function(){for(var a=this.undos_[this.curUndoIndex_],b=this.mesh_,c=b.indexArray_,b=b.triangles_,e=a.tState_,g=a.iArState_,
a=a.nbTrianglesState_,d=e.length,h=0,f=0,k=0,h=0;h<d;++h)f=e[h],f.id_<a&&(k=f.id_,b[k]=f.clone(),k*=3,f=3*h,c[k]=g[f],c[k+1]=g[f+1],c[k+2]=g[f+2])},pullUndoVertices:function(){for(var a=this.undos_[this.curUndoIndex_],b=this.mesh_,c=b.vertexArray_,e=b.normalArray_,b=b.vertices_,g=a.vState_,d=a.vArState_,h=a.nArState_,a=a.nbVerticesState_,f=g.length,k=0,l=0,m=0,k=0;k<f;++k)l=g[k],l.id_<a&&(m=l.id_,b[m]=l.clone(),m*=3,l=3*k,c[m]=d[l],c[m+1]=d[l+1],c[m+2]=d[l+2],e[m]=h[l],e[m+1]=h[l+1],e[m+2]=h[l+2])},
redo:function(){if(this.redos_.length){var a=this.redos_[this.redos_.length-1],b=this.mesh_;b.triangles_.length=a.nbTrianglesState_;b.vertices_.length=a.nbVerticesState_;this.pullRedoTriangles();this.pullRedoVertices();this.recomputeOctree(a.aabbState_.clone());b.updateBuffers();this.firstState_?this.firstState_=!1:this.curUndoIndex_++;this.redos_.pop()}},pullRedoTriangles:function(){for(var a=this.redos_[this.redos_.length-1],b=a.iArState_,a=a.tState_,c=a.length,e=this.mesh_,g=e.indexArray_,e=e.triangles_,
d=0,h=0,f=0,d=0;d<c;++d)h=a[d],f=h.id_,e[f]=h.clone(),f*=3,h=3*d,g[f]=b[h],g[f+1]=b[h+1],g[f+2]=b[h+2]},pullRedoVertices:function(){for(var a=this.redos_[this.redos_.length-1],b=a.vArState_,c=a.nArState_,a=a.vState_,e=a.length,g=this.mesh_,d=g.vertexArray_,h=g.normalArray_,g=g.vertices_,f=0,k=0,l=0,f=0;f<e;++f)k=a[f],l=k.id_,g[l]=k.clone(),l*=3,k=3*f,d[l]=b[k],d[l+1]=b[k+1],d[l+2]=b[k+2],h[l]=c[k],h[l+1]=c[k+1],h[l+2]=c[k+2]},recomputeOctree:function(a){for(var b=this.mesh_,c=b.triangles_.length,
e=Array(c),g=0;g<c;++g)e[g]=g;++Triangle.tagMask_;b.octree_=new Octree;b.octree_.build(b,e,a)},reset:function(){this.mesh_=null;this.undos_=[];this.redos_=[];this.curUndoIndex_=0;this.firstState_=!1}};function Vertex(a){this.id_=a;this.tIndices_=[];this.ringVertices_=[];this.stateFlag_=this.sculptFlag_=this.tagFlag_=1}Vertex.tagMask_=1;Vertex.sculptMask_=1;
Vertex.prototype={clone:function(){var a=new Vertex(this.id_);a.tIndices_=this.tIndices_.slice();a.ringVertices_=this.ringVertices_.slice();a.tagFlag_=this.tagFlag_;a.sculptFlag_=this.sculptFlag_;a.stateFlag_=this.stateFlag_;return a},replaceTriangle:function(a,b){for(var c=this.tIndices_,e=c.length,g=0;g<e;++g)if(a===c[g]){c[g]=b;break}},replaceRingVertex:function(a,b){for(var c=this.ringVertices_,e=c.length,g=0;g<e;++g)if(a===c[g]){c[g]=b;break}},removeTriangle:function(a){for(var b=this.tIndices_,
c=b.length,e=0;e<c;++e)if(a===b[e]){b[e]=b[c-1];b.pop();break}},removeRingVertex:function(a){for(var b=this.ringVertices_,c=b.length,e=0;e<c;++e)if(a===b[e]){b[e]=b[c-1];b.pop();break}}};function SculptGL(){this.gl_=null;this.mouseButton_=this.sumDisplacement_=this.lastMouseY_=this.lastMouseX_=0;this.cameraTimer_=-1;this.symmetry_=!1;this.ptPlane_=[0,0,0];this.nPlane_=[1,0,0];this.states_=new States;this.camera_=new Camera;this.picking_=new Picking(this.camera_);this.pickingSym_=new Picking(this.camera_);this.sculpt_=new Sculpt(this.states_);this.mesh_=null;this.textures_=[];this.shaders_={};this.sphere_="";this.ctrlNbTriangles_=this.ctrlNbVertices_=this.ctrlNegative_=this.ctrlSculpt_=
this.ctrlShaders_=this.ctrlColor_=null;this.resetSphere_=this.resetSphere;this.open_=this.openFile;this.save_=this.saveFile;this.undo_=this.onUndo;this.redo_=this.onRedo;this.dummyFunc_=function(){}}SculptGL.elementIndexType=0;SculptGL.indexArrayType=Uint16Array;
SculptGL.prototype={start:function(){var a=this;$("#fileopen").change(function(b){a.loadFile(b)});this.initWebGL();this.loadShaders();this.initGui();this.onWindowResize();this.loadTextures();this.initEvents()},initEvents:function(){var a=this,b=$("#canvas");b.mousedown(function(b){a.onMouseDown(b)});b.mouseup(function(b){a.onMouseUp(b)});b.mousewheel(function(b,e){a.onMouseWheel(b,e)});b.mousemove(function(b){a.onMouseMove(b)});b.mouseout(function(b){a.onMouseOut(b)});b[0].addEventListener("webglcontextlost",
a.onContextLost,!1);b[0].addEventListener("webglcontextrestored",a.onContextRestored,!1);$(window).keydown(function(b){a.onKeyDown(b)});$(window).keyup(function(b){a.onKeyUp(b)});$(window).resize(function(b){a.onWindowResize(b)})},initWebGL:function(){var a={antialias:!1,stencil:!0};try{this.gl_=$("#canvas")[0].getContext("webgl",a)||$("#canvas")[0].getContext("experimental-webgl",a)}catch(b){alert("Could not initialise WebGL.")}if(a=this.gl_)a.getExtension("OES_element_index_uint")?(SculptGL.elementIndexType=
a.UNSIGNED_INT,SculptGL.indexArrayType=Uint32Array):(SculptGL.elementIndexType=a.UNSIGNED_SHORT,SculptGL.indexArrayType=Uint16Array),a.viewportWidth=$(window).width(),a.viewportHeight=$(window).height(),a.clearColor(0.2,0.2,0.2,1),a.enable(a.DEPTH_TEST),a.depthFunc(a.LEQUAL),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT)},loadTextures:function(){var a=new Image,b=this;a.onload=function(){b.loadSphere()};a.src="ressources/clay.jpg";var c=new Image;c.src=
"ressources/chavant.jpg";var e=new Image;e.src="ressources/skin.jpg";var g=new Image;g.src="ressources/drink.jpg";var d=new Image;d.src="ressources/redvelvet.jpg";var h=new Image;h.src="ressources/orange.jpg";var f=new Image;f.src="ressources/bronze.jpg";this.textures_.push(a,c,e,g,d,h,f)},loadShaders:function(){var a=function(a){var b=new XMLHttpRequest;b.open("GET",a,!1);b.send(null);return b.responseText},b=this.shaders_;b.phongVertex=a("shaders/phongVertex.glsl");b.phongFragment=a("shaders/phongFragment.glsl");
b.wireframeVertex=a("shaders/wireframeVertex.glsl");b.wireframeFragment=a("shaders/wireframeFragment.glsl");b.transparencyVertex=a("shaders/transparencyVertex.glsl");b.transparencyFragment=a("shaders/transparencyFragment.glsl");b.reflectionVertex=a("shaders/reflectionVertex.glsl");b.reflectionFragment=a("shaders/reflectionFragment.glsl")},loadSphere:function(){var a=new XMLHttpRequest;a.open("GET","ressources/sphere.obj",!0);var b=this;a.onload=function(){b.sphere_=this.responseText;b.resetSphere()};
a.send(null)},initGui:function(){var a=new dat.GUI;a.domElement.style.position="absolute";a.domElement.style.height="300px";this.initGeneralGui(a);a=new dat.GUI;this.initEditingGui(a)},initGeneralGui:function(a){var b=this,c=a.addFolder("Files (import/export)");c.add(this,"resetSphere_").name("Reset sphere");c.add(this,"open_").name("Load OBJ file");c.add(this,"save_").name("Save OBJ file");c.open();c=a.addFolder("Camera");c.add(this.camera_,"mode_",{Spherical:Camera.mode.SPHERICAL,Plane:Camera.mode.PLANE}).name("Camera").onChange(function(a){b.camera_.updateMode(parseInt(a,
10));b.render()});c.open();a=a.addFolder("History");a.add(this,"undo_").name("Undo (Ctrl+Z)");a.add(this,"redo_").name("Redo (Ctrl+Y)");a.open()},initEditingGui:function(a){var b=this,c=a.addFolder("Mesh");this.ctrlNbVertices_=c.add(this,"dummyFunc_").name("Ver : 0");this.ctrlNbTriangles_=c.add(this,"dummyFunc_").name("Tri : 0");this.ctrlColor_=c.addColor(new Render,"color_").name("Color");this.ctrlColor_.onChange(function(){b.render()});var e={Phong:Render.mode.PHONG,"Wireframe (slow)":Render.mode.WIREFRAME,
Transparency:Render.mode.TRANSPARENCY,Clay:Render.mode.MATERIAL,Chavant:Render.mode.MATERIAL+1,Skin:Render.mode.MATERIAL+2,Drink:Render.mode.MATERIAL+3,"Red velvet":Render.mode.MATERIAL+4,Orange:Render.mode.MATERIAL+5,Bronze:Render.mode.MATERIAL+6};this.ctrlShaders_=c.add(new Render,"shaderType_",e).name("Shader");this.ctrlShaders_.onChange(function(a){b.mesh_&&(b.mesh_.render_.updateShaders(parseInt(a,10),b.textures_,b.shaders_),b.mesh_.updateBuffers(),b.render())});c.open();c=a.addFolder("Sculpt");
this.ctrlSculpt_=c.add(this.sculpt_,"tool_",{"Brush (1)":Sculpt.tool.BRUSH,"Inflate (2)":Sculpt.tool.INFLATE,"Rotate (3)":Sculpt.tool.ROTATE,"Smooth (4)":Sculpt.tool.SMOOTH,"Flatten (5)":Sculpt.tool.FLATTEN,"Pinch (6)":Sculpt.tool.PINCH,"Crease (7)":Sculpt.tool.CREASE}).name("Tool");this.ctrlSculpt_.onChange(function(a){b.sculpt_.tool_=parseInt(a,10)});this.ctrlNegative_=c.add(this.sculpt_,"negative_").name("Negative (N)");c.add(this,"symmetry_").name("Symmetry");c.add(this.sculpt_,"culling_").name("Sculpt culling");
c.add(this.picking_,"rDisplay_",20,200).name("Radius");c.add(this.sculpt_,"intensity_",0,1).name("Intensity");c.open();a=a.addFolder("Topology");a.add(this.sculpt_,"topo_",{Static:Sculpt.topo.STATIC,Subdivision:Sculpt.topo.SUBDIVISION,Decimation:Sculpt.topo.DECIMATION,Uniformisation:Sculpt.topo.UNIFORMISATION,"Adaptive (!!!)":Sculpt.topo.ADAPTIVE}).name("Tool").onChange(function(a){b.sculpt_.topo_=parseInt(a,10)});a.add(this.sculpt_,"detail_",0,1).name("Detail");a.open()},render:function(){var a=
this.gl_;a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);this.camera_.updateView();this.mesh_&&this.mesh_.render(this.camera_,this.picking_)},onWindowResize:function(){var a=$(window).width(),b=$(window).height();this.camera_.width_=a;this.camera_.height_=b;$("#canvas").attr("width",a);$("#canvas").attr("height",b);var c=this.gl_;c.viewportWidth=a;c.viewportHeight=b;c.viewport(0,0,a,b);this.camera_.updateProjection();this.render()},onKeyDown:function(a){a.stopPropagation();a.preventDefault();var b=
a.which;if(a.ctrlKey&&90===b)this.onUndo();else if(a.ctrlKey&&89===b)this.onRedo();else{switch(b){case 49:case 97:this.ctrlSculpt_.setValue(Sculpt.tool.BRUSH);break;case 50:case 98:this.ctrlSculpt_.setValue(Sculpt.tool.INFLATE);break;case 51:case 99:this.ctrlSculpt_.setValue(Sculpt.tool.ROTATE);break;case 52:case 100:this.ctrlSculpt_.setValue(Sculpt.tool.SMOOTH);break;case 53:case 101:this.ctrlSculpt_.setValue(Sculpt.tool.FLATTEN);break;case 54:case 102:this.ctrlSculpt_.setValue(Sculpt.tool.PINCH);
break;case 55:case 103:this.ctrlSculpt_.setValue(Sculpt.tool.CREASE);break;case 78:this.ctrlNegative_.setValue(!this.sculpt_.negative_);break;case 37:case 81:case 65:this.camera_.moveX_=-1;break;case 39:case 68:this.camera_.moveX_=1;break;case 38:case 90:case 87:this.camera_.moveZ_=-1;break;case 40:case 83:this.camera_.moveZ_=1}var c=this;-1===this.cameraTimer_&&(this.cameraTimer_=setInterval(function(){c.camera_.updateTranslation();c.render()},20))}},onKeyUp:function(a){a.stopPropagation();a.preventDefault();
switch(a.which){case 37:case 81:case 65:case 39:case 68:this.camera_.moveX_=0;break;case 38:case 90:case 87:case 40:case 83:this.camera_.moveZ_=0}-1!==this.cameraTimer_&&(0===this.camera_.moveX_&&0===this.camera_.moveZ_)&&(clearInterval(this.cameraTimer_),this.cameraTimer_=-1)},onMouseDown:function(a){a.stopPropagation();a.preventDefault();var b=a.pageX,c=a.pageY;a=this.mouseButton_=a.which;1===a?this.mesh_&&(this.states_.start(),this.sculpt_.tool_===Sculpt.tool.ROTATE&&(this.symmetry_?this.sculpt_.startRotate(this.picking_,
b,c,this.pickingSym_,this.ptPlane_,this.nPlane_):this.sculpt_.startRotate(this.picking_,b,c))):3===a&&this.camera_.start(b,c)},onMouseUp:function(a){a.stopPropagation();a.preventDefault();this.mesh_&&this.mesh_.checkLeavesUpdate();this.mouseButton_=0},onMouseWheel:function(a,b){a.stopPropagation();a.preventDefault();this.camera_.zoom(b/100);this.render()},onMouseMove:function(a){a.stopPropagation();a.preventDefault();var b=a.pageX;a=a.pageY;this.mesh_&&1!==this.mouseButton_&&this.picking_.intersectionMouseMesh(this.mesh_,
b,a);1===this.mouseButton_?(this.sculpt_.tool_!==Sculpt.tool.ROTATE?this.sculptStroke(b,a):this.picking_.mesh_&&(this.picking_.pickVerticesInSphere(this.picking_.rWorldSqr_),this.sculpt_.sculptMesh(this.picking_,b,a,this.lastMouseX_,this.lastMouseY_),this.symmetry_&&(this.pickingSym_.pickVerticesInSphere(this.pickingSym_.rWorldSqr_),this.sculpt_.sculptMesh(this.pickingSym_,this.lastMouseX_,this.lastMouseY_,b,a,!0))),this.mesh_.updateBuffers(),this.ctrlNbVertices_.name("Ver : "+this.mesh_.vertices_.length),
this.ctrlNbTriangles_.name("Tri : "+this.mesh_.triangles_.length)):3===this.mouseButton_?this.camera_.rotate(b,a):2===this.mouseButton_&&this.camera_.translate((b-this.lastMouseX_)/3E3,(a-this.lastMouseY_)/3E3);this.lastMouseX_=b;this.lastMouseY_=a;this.render()},sculptStroke:function(a,b){var c=this.ptPlane_,e=this.nPlane_,g=this.picking_,d=this.pickingSym_,h=a-this.lastMouseX_,f=b-this.lastMouseY_,k=Math.sqrt(h*h+f*f);this.sumDisplacement_+=k;var l=0.2*g.rDisplay_,m=k/Math.floor(k/l),h=h/k,f=f/
k;a=this.lastMouseX_;b=this.lastMouseY_;var n=this.mesh_,p=this.symmetry_,q=this.sculpt_;if(this.sumDisplacement_>50*l)this.sumDisplacement_=0;else if(this.sumDisplacement_>l)for(l=this.sumDisplacement_=0;l<k;l+=m){g.intersectionMouseMesh(n,a,b);if(!g.mesh_)break;g.pickVerticesInSphere(g.rWorldSqr_);q.sculptMesh(g);if(p){d.intersectionMouseMesh(n,a,b,c,e);if(!d.mesh_)break;d.rWorldSqr_=g.rWorldSqr_;d.pickVerticesInSphere(d.rWorldSqr_);q.sculptMesh(d)}a+=h*m;b+=f*m}},onMouseOut:function(){this.mouseButton_=
0},onContextLost:function(){alert("shit happens : context lost")},onContextRestored:function(){alert("context is restored")},loadFile:function(a){a.stopPropagation();a.preventDefault();if(0!==a.target.files.length&&(a=a.target.files[0],a.name.endsWith(".obj"))){var b=new FileReader,c=this;b.onload=function(a){c.startMeshLoad();Files.loadOBJ(a.target.result,c.mesh_);c.endMeshLoad();$("#fileopen").replaceWith($("#fileopen").clone(!0))};b.readAsText(a)}},resetSphere:function(){this.startMeshLoad();Files.loadOBJ(this.sphere_,
this.mesh_);this.endMeshLoad()},startMeshLoad:function(){this.mesh_=new Mesh(this.gl_);this.states_.reset();this.states_.mesh_=this.mesh_;this.sculpt_.mesh_=this.mesh_;Mesh.stateMask_=1;Vertex.tagMask_=1;Vertex.sculptMask_=1;Triangle.tagMask_=1},endMeshLoad:function(){var a=this.mesh_;a.render_.shaderType_=Render.mode.MATERIAL;a.initMesh(this.textures_,this.shaders_);a.moveTo([0,0,0]);a=vec3.dist(a.octree_.aabbLoose_.max_,a.octree_.aabbLoose_.min_);this.camera_.reset();this.camera_.globalScale_=a;
this.camera_.zoom(-0.4);this.updateGuiMesh();this.render()},updateGuiMesh:function(){if(this.mesh_){var a=this.mesh_;this.ctrlColor_.object=a.render_;this.ctrlColor_.updateDisplay();this.ctrlShaders_.object=a.render_;this.ctrlShaders_.updateDisplay();this.ctrlNbVertices_.name("Ver : "+a.vertices_.length);this.ctrlNbTriangles_.name("Tri : "+a.triangles_.length)}},openFile:function(){$("#fileopen").trigger("click")},saveFile:function(){if(this.mesh_){var a=[Files.exportOBJ(this.mesh_)],a=new Blob(a,
{type:"text/plain;charset=utf-8"});saveAs(a,"yourMesh.obj")}},onUndo:function(){this.states_.undo();this.render();this.updateGuiMesh()},onRedo:function(){this.states_.redo();this.render();this.updateGuiMesh()}};
