function Aabb(){this.min_=[0,0,0];this.max_=[0,0,0]}
Aabb.prototype={clone:function(){var a=new Aabb;a.min_=this.min_.slice();a.max_=this.max_.slice();return a},copy:function(a){vec3.copy(this.min_,a.min_);vec3.copy(this.max_,a.max_);return this},setCopy:function(a,b){vec3.copy(this.min_,a);vec3.copy(this.max_,b);return this},set:function(a,b,c,d,g,f){var k=this.min_,e=this.max_;k[0]=a;k[1]=b;k[2]=c;e[0]=d;e[1]=g;e[2]=f;return this},computeCenter:function(){var a=[0,0,0];return vec3.scale(a,vec3.add(a,this.min_,this.max_),0.5)},isOutside:function(a){var b=
this.min_,c=this.max_,d=a.min_;a=a.max_;return d[0]>c[0]||a[0]<b[0]||d[1]>c[1]||a[1]<b[1]||d[2]>c[2]||a[2]<b[2]?!0:!1},isInside:function(a){var b=this.min_,c=this.max_,d=a.min_;a=a.max_;return b[0]>=d[0]&&c[0]<=a[0]&&b[1]>=d[1]&&c[1]<=a[1]&&b[2]>=d[2]&&c[2]<=a[2]?!0:!1},pointInside:function(a){var b=this.min_,c=this.max_,d=a[0],g=a[1];a=a[2];return d<=b[0]||d>c[0]||g<=b[1]||g>c[1]||a<=b[2]||a>c[2]?!1:!0},expandsWithPoint:function(a,b,c){var d=this.min_,g=this.max_;a>g[0]&&(g[0]=a);a<d[0]&&(d[0]=a);
b>g[1]&&(g[1]=b);b<d[1]&&(d[1]=b);c>g[2]&&(g[2]=c);c<d[2]&&(d[2]=c)},expandsWithAabb:function(a){var b=this.min_,c=this.max_,d=a.min_,g=a.max_;a=d[0];var f=d[1],d=d[2],k=g[0],e=g[1],g=g[2];k>c[0]&&(c[0]=k);a<b[0]&&(b[0]=a);e>c[1]&&(c[1]=e);f<b[1]&&(b[1]=f);g>c[2]&&(c[2]=g);d<b[2]&&(b[2]=d)},intersectRay:function(a,b){var c=this.min_,d=this.max_,g=b[0],f=b[1],k=b[2],e=a[0],h=a[1],l=a[2],m=(c[0]-e)*g,g=(d[0]-e)*g,e=(c[1]-h)*f,f=(d[1]-h)*f,c=(c[2]-l)*k,k=(d[2]-l)*k,d=Math.max(Math.max(Math.min(m,g),
Math.min(e,f)),Math.min(c,k)),m=Math.min(Math.min(Math.max(m,g),Math.max(e,f)),Math.max(c,k));return 0<=m&&d<m},intersectSphere:function(a,b){var c=this.min_,d=this.max_,g=a[0],f=a[1],k=a[2],e=[0,0,0];e[0]=c[0]>g?c[0]:d[0]<g?d[0]:g;e[1]=c[1]>f?c[1]:d[1]<f?d[1]:f;e[2]=c[2]>k?c[2]:d[2]<k?d[2]:k;return vec3.sqrDist(a,e)<b},enlargeIfFlat:function(a){var b=this.min_,c=this.max_;b[0]===c[0]&&(b[0]-=a,c[0]+=a);b[1]===c[1]&&(b[1]-=a,c[1]+=a);b[2]===c[2]&&(b[2]-=a,c[2]+=a)}};function Camera(){this.mode_=Camera.mode.PLANE;this.rot_=quat.create();this.view_=mat4.create();this.proj_=mat4.create();this.lastNormalizedMouseXY_=[0,0];this.height_=this.width_=0;this.zoom_=20;this.transY_=this.transX_=0;this.globalScale_=1;this.moveZ_=this.moveX_=0}Camera.mode={SPHERICAL:0,PLANE:1};
Camera.prototype={updateMode:function(a){this.mode_=a;this.rot_=quat.create();a=this.globalScale_;this.reset();this.globalScale_=a;this.zoom(-0.4)},start:function(a,b){this.lastNormalizedMouseXY_=Geometry.normalizedMouse(a,b,this.width_,this.height_)},rotate:function(a,b){var c=Geometry.normalizedMouse(a,b,this.width_,this.height_);if(this.mode_===Camera.mode.PLANE){var d=vec2.dist(this.lastNormalizedMouseXY_,c),g=[0,0];vec2.sub(g,c,this.lastNormalizedMouseXY_);g=[-g[1],g[0],0];vec3.normalize(g,g);
quat.mul(this.rot_,quat.setAxisAngle([0,0,0,0],g,2*d),this.rot_)}else if(this.mode_===Camera.mode.SPHERICAL){var d=Geometry.mouseOnUnitSphere(this.lastNormalizedMouseXY_),g=Geometry.mouseOnUnitSphere(c),f=Math.acos(Math.min(1,vec3.dot(d,g))),k=[0,0,0];vec3.normalize(k,vec3.cross(k,d,g));quat.mul(this.rot_,quat.setAxisAngle([0,0,0,0],k,2*f),this.rot_)}this.lastNormalizedMouseXY_=c},updateView:function(){var a=this.view_,b=this.transX_,c=this.transY_;mat4.lookAt(a,[b,c,this.zoom_],[b,c,0],[0,1,0]);
b=mat4.create();mat4.fromQuat(b,this.rot_);mat4.mul(a,a,b)},updateProjection:function(){this.proj_=mat4.create();mat4.perspective(this.proj_,1.222,this.width_/this.height_,0.01,1E5)},updateTranslation:function(){this.transX_+=this.moveX_*this.globalScale_/400;this.zoom_=Math.max(1E-5,this.zoom_+this.moveZ_*this.globalScale_/400)},translate:function(a,b){this.transX_-=a*this.globalScale_;this.transY_+=b*this.globalScale_},zoom:function(a){this.zoom_=Math.max(1E-5,this.zoom_-a*this.globalScale_)},reset:function(){this.rot_=
quat.create();this.zoom_=0;this.transX_=1E-5;this.transY_=0;this.globalScale_=1},unproject:function(a,b,c){var d=this.height_;a=[2*a/this.width_-1,(d-2*b)/d,2*c-1,1];b=mat4.create();vec4.transformMat4(a,a,mat4.invert(b,mat4.mul(b,this.proj_,this.view_)));b=a[3];return[a[0]/b,a[1]/b,a[2]/b]},project:function(a){a=[a[0],a[1],a[2],1];vec4.transformMat4(a,a,this.view_);vec4.transformMat4(a,a,this.proj_);var b=a[3],c=this.height_;return[0.5*(a[0]/b+1)*this.width_,c-0.5*(a[1]/b+1)*c,0.5*(a[2]/b+1)]}};var Files={importOBJ:function(a,b){for(var c=b.vertices_,d=b.triangles_,g=[],f=[],k=a.split("\n"),e=[],h=k.length,l=0;l<h;++l){var m=k[l],m=m.trim();if(m.startsWith("v "))e=m.split(/\s+/),c.push(new Vertex(c.length)),g.push(parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3]));else if(m.startsWith("f ")){var e=m.split(/\s+/),m=e[1].split("/"),n=e[2].split("/"),p=e[3].split("/"),m=parseInt(m[0],10),q=parseInt(n[0],10),p=parseInt(p[0],10),r=c.length;0>m?(m+=r,q+=r,p+=r):(--m,--q,--p);var n=c[m],s=c[q],
t=c[p],v=d.length;n.tIndices_.push(v);s.tIndices_.push(v);t.tIndices_.push(v);d.push(new Triangle(v));f.push(m,q,p);4<e.length&&(++v,e=parseInt(e[4].split("/")[0],10),0>e?e+=r:--e,q=c[e],n.tIndices_.push(v),t.tIndices_.push(v),q.tIndices_.push(v),d.push(new Triangle(v)),f.push(m,p,e))}}b.vertexArray_=new Float32Array(2*g.length);b.normalArray_=new Float32Array(2*g.length);b.indexArray_=new SculptGL.indexArrayType(2*f.length);b.vertexArray_.set(g);b.indexArray_.set(f)},exportOBJ:function(a){var b=
a.vertexArray_,c=a.indexArray_,d="s 0\n",g=a.vertices_.length,f=a.triangles_.length;a=1/a.scale_;for(var k=0,e=0,k=0;k<g;++k)e=3*k,d+="v "+b[e]*a+" "+b[e+1]*a+" "+b[e+2]*a+"\n";for(k=0;k<f;++k)e=3*k,d+="f "+(1+c[e])+" "+(1+c[e+1])+" "+(1+c[e+2])+"\n";return d},importSTL:function(a,b){for(var c=a.length,d=new Uint8Array(c),g=0;g<c;++g)d[g]=a[g].charCodeAt()&255;c=new DataView(d.buffer||d);84+50*c.getUint32(80,!0)===c.byteLength?Files.importBinarySTL(a,b):Files.importAsciiSTL(a,b)},importAsciiSTL:function(a,
b){for(var c=b.vertices_,d=b.triangles_,g=[],f=[],k=a.split("\n"),e=[],h=k.length,l={},m=0,n=0,p=e=0,q=0,r=m=0,s=0;s<h;++s)p=k[s],p=p.trim(),p.startsWith("facet")&&(r=d.length,e=k[s+2].split(/\s+/),m=parseFloat(e[1]),n=parseFloat(e[2]),e=parseFloat(e[3]),p=Files.detectNewVertex(l,m,n,e,c,g,r),e=k[s+3].split(/\s+/),m=parseFloat(e[1]),n=parseFloat(e[2]),e=parseFloat(e[3]),q=Files.detectNewVertex(l,m,n,e,c,g,r),e=k[s+4].split(/\s+/),m=parseFloat(e[1]),n=parseFloat(e[2]),e=parseFloat(e[3]),m=Files.detectNewVertex(l,
m,n,e,c,g,r),f.push(p,q,m),d.push(new Triangle(r)),s+=6);b.vertexArray_=new Float32Array(2*g.length);b.normalArray_=new Float32Array(2*g.length);b.indexArray_=new SculptGL.indexArrayType(2*f.length);b.vertexArray_.set(g);b.indexArray_.set(f)},importBinarySTL:function(a,b){for(var c=b.vertices_,d=b.triangles_,g=[],f=[],k=Files.getUint32(a,80),e={},h=0,l=0,m=0,n=0,p=0,h=0,q=96,r=0,s=0;s<k;++s)r=d.length,h=Files.getFloat32(a,q),l=Files.getFloat32(a,q+4),m=Files.getFloat32(a,q+8),n=Files.detectNewVertex(e,
h,l,m,c,g,r),h=Files.getFloat32(a,q+12),l=Files.getFloat32(a,q+16),m=Files.getFloat32(a,q+20),p=Files.detectNewVertex(e,h,l,m,c,g,r),h=Files.getFloat32(a,q+24),l=Files.getFloat32(a,q+28),m=Files.getFloat32(a,q+32),h=Files.detectNewVertex(e,h,l,m,c,g,r),f.push(n,p,h),d.push(new Triangle(r)),q+=50;b.vertexArray_=new Float32Array(2*g.length);b.normalArray_=new Float32Array(2*g.length);b.indexArray_=new SculptGL.indexArrayType(2*f.length);b.vertexArray_.set(g);b.indexArray_.set(f)},detectNewVertex:function(a,
b,c,d,g,f,k){var e=b+"+"+c+"+"+d,h=null,l=0;a.hasOwnProperty(e)?(l=a[e],h=g[l]):(l=g.length,h=new Vertex(l),g.push(h),f.push(b,c,d),a[e]=l);h.tIndices_.push(k);return l},getBytes:function(a,b){return[a[b].charCodeAt(),a[b+1].charCodeAt(),a[b+2].charCodeAt(),a[b+3].charCodeAt()]},getUint32:function(a,b){var c=Files.getBytes(a,b);return c[0]<<0|c[1]<<8|c[2]<<16|c[3]<<24},getFloat32:function(a,b){var c=Files.getBytes(a,b),d=1-2*(c[3]>>7),g=(c[3]<<1&255|c[2]>>7)-127,c=(c[2]&127)<<16|c[1]<<8|c[0];return 128===
g?0!==c?NaN:Infinity*d:-127===g?d*c*Math.pow(2,-149):d*(1+c*Math.pow(2,-23))*Math.pow(2,g)},exportVerold:function(a,b){var c=new FormData;c.append("api_key",b);var d=Files.exportOBJ(a);c.append("model",new Blob([d]),"model.obj");c.append("title","Model");c.append("description","Imported from SculptGL.");var g=new XMLHttpRequest;g.open("POST","http://studio.verold.com/projects.json");g.addEventListener("load",function(){var a=JSON.parse(g.responseText);console.log(a);a.errors?alert("Verold upload error :\n"+
a.errors[0]):alert("Upload success !")},!0);g.send(c)},exportSketchfab:function(a,b){var c=new FormData;c.append("token",b);var d=Files.exportOBJ(a);c.append("fileModel",new Blob([d]));c.append("filenameModel","model.obj");var g=new XMLHttpRequest;g.open("POST","https://api.sketchfab.com/v1/models");g.addEventListener("load",function(){var a=JSON.parse(g.responseText);console.log(a);a.success?alert("Upload success !"):alert("Sketchfab upload error :\n"+a.error)},!0);g.send(c)}};var Geometry={normalizedMouse:function(a,b,c,d){return[2*a/c-1,1-2*b/d]},mouseOnUnitSphere:function(a){var b=a[0];a=a[1];var c=1-b*b-a*a,c=0<c?Math.sqrt(c):0,b=[b,a,c];return vec3.normalize(b,b)},intersectionRayTriangle:function(a,b,c,d,g,f,k){var e=[0,0,0];vec3.sub(e,a,c);var h=vec3.dot(e,f),l=vec3.dot(vec3.sub(e,b,c),f);if(0<=h*l)return!1;vec3.scaleAndAdd(k,a,vec3.sub(e,b,a),-h/(l-h));a=[0,0,0];vec3.cross(a,f,vec3.sub(e,d,c));if(0>vec3.dot(a,vec3.sub(e,k,c)))return!1;vec3.cross(a,f,vec3.sub(e,g,
d));if(0>vec3.dot(a,vec3.sub(e,k,d)))return!1;vec3.cross(a,f,vec3.sub(e,c,g));return 0>vec3.dot(a,vec3.sub(e,k,c))?!1:!0},computeTriangleAabb:function(a,b,c,d,g,f,k,e,h,l){var m=Math.min(b,g,e),n=Math.min(c,f,h),p=Math.min(d,k,l);b=Math.max(b,g,e);c=Math.max(c,f,h);d=Math.max(d,k,l);k=a.min_;a=a.max_;k[0]=m;k[1]=n;k[2]=p;a[0]=b;a[1]=c;a[2]=d},normal:function(a,b,c,d,g,f,k,e,h,l){g-=b;f-=c;k-=d;b=e-b;c=h-c;e=l-d;h=l=d=0;d=f*e-k*c;l=k*b-g*e;h=g*c-f*b;g=d*d+l*l+h*h;0!==g&&(g=1/Math.sqrt(g),a[0]=d*g,
a[1]=l*g,a[2]=h*g)},pointInsideTriangle:function(a,b,c,d){var g=[0,0,0];vec3.sub(g,b,c);var f=[0,0,0];vec3.sub(f,b,d);b=[0,0,0];vec3.sub(b,a,c);c=[0,0,0];vec3.sub(c,a,d);d=[0,0,0];a=vec3.len(vec3.cross(d,g,f));g=vec3.len(vec3.cross(d,g,b));f=vec3.len(vec3.cross(d,f,c));b=vec3.len(vec3.cross(d,b,c));return 1E-4>Math.abs(a-(g+f+b))?!0:!1},sphereIntersectTriangle:function(a,b,c,d,g){return Geometry.distanceToSegment(a,c,d)<b||Geometry.distanceToSegment(a,d,g)<b||Geometry.distanceToSegment(a,c,g)<b?!0:
!1},distanceToSegment:function(a,b,c){var d=[0,0,0];vec3.sub(d,a,b);var g=[0,0,0];vec3.sub(g,c,b);var f=vec3.sqrLen(g),f=vec3.dot(d,g)/f;if(0>f)return vec3.sqrLen(d);if(1<f)return vec3.sqrLen(vec3.sub(d,a,c));d[0]=a[0]-b[0]+f*g[0];d[1]=a[1]-b[1]+f*g[1];d[2]=a[2]-b[2]+f*g[2];return vec3.sqrLen(d)},signedAngle2d:function(a,b){var c=a[0],d=a[1],g=b[0],f=b[1];return Math.atan2(c*f-d*g,c*g+d*f)},pointPlaneDistance:function(a,b,c){return vec3.dot(vec3.sub([0,0,0],a,b),c)},mirrorPoint:function(a,b,c){return vec3.sub(a,
a,vec3.scale([0,0,0],c,2*Geometry.pointPlaneDistance(a,b,c)))},vertexOnLine:function(a,b,c){var d=[0,0,0];vec3.sub(d,c,b);c=[0,0,0];a=vec3.dot(d,vec3.sub(c,a,b));return vec3.scaleAndAdd(c,b,d,a/vec3.sqrLen(d))}};function Grid(){this.aabb_=new Aabb;this.size_=this.cellSize_=this.dimZ_=this.dimY_=this.dimX_=0;this.iVerts_=[]}
Grid.prototype={setBoundaries:function(a){var b=[0,0,0];vec3.sub(b,a.max_,a.min_);vec3.scale(b,b,0.1);vec3.sub(a.min_,a.min_,b);vec3.add(a.max_,a.max_,b);this.aabb_=a},init:function(a){this.cellSize_=a;var b=this.aabb_,c=[0,0,0];vec3.sub(c,b.max_,b.min_);var b=Math.ceil(c[0]/a),d=Math.ceil(c[1]/a);a=Math.ceil(c[2]/a);0>=b&&(b=1);0>=d&&(d=1);0>=a&&(a=1);var c=this.size_=1+b*d*a,g=this.iVerts_;g.length=c;for(var f=0;f<c;++f)g[f]=[];this.dimX_=b;this.dimY_=d;this.dimZ_=a},build:function(a,b){for(var c=
a.vertexArray_,d=this.aabb_.min_,g=this.dimX_,f=g*this.dimY_,k=0,e=0,h=0,l=0,h=0,m=this.cellSize_,n=this.size_,p=this.iVerts_,q=b.length,l=0;l<q;++l){var r=b[l],h=3*r,k=Math.floor((c[h]-d[0])/m),e=Math.floor((c[h+1]-d[1])/m),h=Math.floor((c[h+2]-d[2])/m),k=k+e*g+h*f;0>k?k=0:k>=n&&(k=n-1);p[k].push(r)}},getNeighborhood:function(a,b,c){var d=this.aabb_.min_,g=this.cellSize_,f=this.dimX_,k=this.dimY_,e=this.dimZ_,h=f*this.dimY_;a=Math.floor((a-d[0])/g);b=Math.floor((b-d[1])/g);c=Math.floor((c-d[2])/
g);0>a?a=0:a>=f&&(a=f-1);0>b?b=0:b>=k&&(b=k-1);0>c?c=0:c>=e&&(c=e-1);var l=g=d=-1,m=1,n=1,p=1;0>=a&&(d=0);a>=f-1&&(m=0);0>=b&&(g=0);b>=k-1&&(n=0);0>=c&&(l=0);c>=e-1&&(p=0);for(var q=e=k=0,r=this.iVerts_,s=[],k=d;k<=m;++k)for(e=g;e<=n;++e)for(q=l;q<=p;++q)s.push.apply(s,r[a+k+(b+e)*f+(c+q)*h]);return s}};function Mesh(a){this.vertices_=[];this.triangles_=[];this.indexArray_=this.normalArray_=this.vertexArray_=null;this.center_=[0,0,0];this.octree_=new Octree;this.matTransform_=mat4.create();this.leavesUpdate_=[];this.render_=new Render(a);this.scale_=1}Mesh.globalScale_=500;Mesh.stateMask_=1;
Mesh.prototype={getTrianglesFromVertices:function(a){for(var b=++Triangle.tagMask_,c=[],d=a.length,g=this.vertices_,f=this.triangles_,k=0;k<d;++k)for(var e=g[a[k]].tIndices_,h=e.length,l=0;l<h;++l){var m=e[l];f[m].tagFlag_!==b&&(c.push(m),f[m].tagFlag_=b)}return c},getVerticesFromTriangles:function(a){for(var b=++Vertex.tagMask_,c=[],d=a.length,g=this.vertices_,f=this.indexArray_,k=0;k<d;++k){var e=3*a[k],h=f[e],l=f[e+1],e=f[e+2];g[h].tagFlag_!==b&&(c.push(h),g[h].tagFlag_=b);g[l].tagFlag_!==b&&(c.push(l),
g[l].tagFlag_=b);g[e].tagFlag_!==b&&(c.push(e),g[e].tagFlag_=b)}return c},expandsTriangles:function(a,b){for(var c=++Triangle.tagMask_,d=a.length,g=this.vertices_,f=this.triangles_,k=this.indexArray_,e=0,h=0,e=0;e<d;++e)f[a[e]].tagFlag_=c;for(e=0;b;){for(--b;e<d;++e){for(var h=3*a[e],l=g[k[h]].tIndices_,m=g[k[h+1]].tIndices_,n=g[k[h+2]].tIndices_,p=l.length,q=m.length,r=n.length,h=0;h<p;++h){var s=f[l[h]];s.tagFlag_!==c&&(s.tagFlag_=c,a.push(l[h]))}for(h=0;h<q;++h)l=f[m[h]],l.tagFlag_!==c&&(l.tagFlag_=
c,a.push(m[h]));for(h=0;h<r;++h)m=f[n[h]],m.tagFlag_!==c&&(m.tagFlag_=c,a.push(n[h]))}e=d;d=a.length}},expandsVertices:function(a,b){for(var c=++Vertex.tagMask_,d=a.length,g=this.vertices_,f=0,k=0,f=0;f<d;++f)g[a[f]].tagFlag_=c;for(f=0;b;){for(--b;f<d;++f)for(var e=g[a[f]].ringVertices_,h=e.length,k=0;k<h;++k){var l=g[e[k]];l.tagFlag_!==c&&(l.tagFlag_=c,a.push(e[k]))}f=d;d=a.length}},computeRingVertices:function(a){var b=++Vertex.tagMask_,c=this.vertices_,d=this.indexArray_,g=c[a];g.ringVertices_.length=
0;for(var f=g.ringVertices_,g=g.tIndices_,k=g.length,e=0;e<k;++e){var h=3*g[e],l=d[h],m=d[h+1],h=d[h+2];l!==a&&c[l].tagFlag_!==b&&(f.push(l),c[l].tagFlag_=b);m!==a&&c[m].tagFlag_!==b&&(f.push(m),c[m].tagFlag_=b);h!==a&&c[h].tagFlag_!==b&&(f.push(h),c[h].tagFlag_=b)}},moveTo:function(a){mat4.translate(this.matTransform_,mat4.create(),vec3.sub(a,a,this.center_))},render:function(a,b){this.render_.render(a,b,this.matTransform_,3*this.triangles_.length,this.center_)},initMesh:function(a,b){var c=this.vertexArray_,
d=this.vertices_.length,g=this.triangles_.length,f=new Aabb;f.set(c[0],c[1],c[2],c[0],c[1],c[2]);for(var k=0,e=0,k=0;k<d;++k)this.computeRingVertices(k),e=3*k,f.expandsWithPoint(c[e],c[e+1],c[e+2]);this.center_=f.computeCenter();for(var k=vec3.dist(f.min_,f.max_),h=this.scale_=Mesh.globalScale_/k,k=0;k<d;++k)e=3*k,c[e]*=h,c[e+1]*=h,c[e+2]*=h;mat4.scale(this.matTransform_,this.matTransform_,[h,h,h]);vec3.scale(f.min_,f.min_,h);vec3.scale(f.max_,f.max_,h);vec3.scale(this.center_,this.center_,h);c=[0,
0,0];vec3.sub(c,f.max_,f.min_);vec3.scale(c,c,0.2);vec3.sub(f.min_,f.min_,c);vec3.add(f.max_,f.max_,c);f.enlargeIfFlat(vec3.length(c));for(k=0;k<g;++k)this.updateTriangleAabbAndNormal(k);for(k=0;k<d;++k)this.updateVertexNormal(k);d=Array(g);for(k=0;k<g;++k)d[k]=k;++Triangle.tagMask_;this.octree_=new Octree;this.octree_.build(this,d,f);this.render_.initBuffers(this.vertexArray_,this.normalArray_,this.indexArray_);this.render_.updateShaders(this.render_.shaderType_,a,b)},updateBuffers:function(){this.render_.updateBuffers(this.vertexArray_,
this.normalArray_,this.indexArray_)},updateMesh:function(a,b){for(var c=b.length,d=a.length,g=0,g=0;g<d;++g)this.updateTriangleAabbAndNormal(a[g]);this.updateOctree(a);for(g=0;g<c;++g)this.updateVertexNormal(b[g])},updateTriangleAabbAndNormal:function(a){var b=this.vertexArray_,c=this.indexArray_,d=this.triangles_[a];a*=3;var g=3*c[a],f=3*c[a+1],k=3*c[a+2];a=b[g];var c=b[g+1],g=b[g+2],e=b[f],h=b[f+1],f=b[f+2],l=b[k],m=b[k+1],b=b[k+2];Geometry.normal(d.normal_,a,c,g,e,h,f,l,m,b);Geometry.computeTriangleAabb(d.aabb_,
a,c,g,e,h,f,l,m,b)},updateVertexNormal:function(a){for(var b=this.triangles_,c=this.normalArray_,d=this.vertices_[a].tIndices_,g=d.length,f=0,k=0,e=0,h=0;h<g;++h)var l=b[d[h]].normal_,f=f+l[0],k=k+l[1],e=e+l[2];b=1/Math.sqrt(f*f+k*k+e*e);a*=3;c[a]=f*b;c[a+1]=k*b;c[a+2]=e*b},updateOctree:function(a){for(var b=a.length,c=[],d=this.triangles_,g=0,f,g=0;g<b;++g){var k=d[a[g]];f=k.leaf_;if(f.aabbSplit_.pointInside(k.aabb_.computeCenter()))k.aabb_.isInside(f.aabbLoose_)||f.aabbLoose_.expandsWithAabb(k.aabb_);
else if(c.push(a[g]),f=f.iTris_,0<f.length){var e=f[f.length-1],k=k.posInLeaf_;f[k]=e;d[e].posInLeaf_=k;f.pop()}}a=c.length;for(g=0;g<a;++g)if(b=d[c[g]],this.octree_.aabbLoose_.isOutside(b.aabb_)){c=new Aabb;c.setCopy(this.octree_.aabbSplit_.min_,this.octree_.aabbSplit_.max_);g=[0,0,0];vec3.scale(g,vec3.sub(g,c.max_,c.min_),0.2);vec3.sub(c.min_,c.min_,g);vec3.add(c.max_,c.max_,g);f=[];d=d.length;for(g=0;g<d;++g)f.push(g);this.octree_=new Octree;++Triangle.tagMask_;this.octree_.build(this,f,c);this.leavesUpdate_.length=
0;break}else f=b.leaf_,this.octree_.addTriangle(this,b),f===b.leaf_&&(f=f.iTris_,b.posInLeaf_=f.length,f.push(c[g]))},checkLeavesUpdate:function(){Tools.tidy(this.leavesUpdate_);var a=this.leavesUpdate_,b=a.length,c=[],d=Octree.maxTriangles_,g=Octree.maxDepth_;++Triangle.tagMask_;for(var f=0,k=0,f=0;f<b;++f){k=a[f];if(null===k)break;k.iTris_.length?k.iTris_.length>d&&k.depth_<g&&k.constructCells(this):Octree.checkEmptiness(k,c)}Tools.tidy(c);a=c.length;for(f=0;f<a;++f){b=c[f].child_;for(k=0;8>k;++k)b[k]=
null}this.leavesUpdate_.length=0}};function Octree(a,b){this.parent_="undefined"!==typeof a?a:null;this.depth_="undefined"!==typeof b?b:0;this.child_=[];this.aabbLoose_=new Aabb;this.aabbSplit_=new Aabb;this.iTris_=[]}Octree.maxDepth_=8;Octree.maxTriangles_=100;
Octree.prototype={build:function(a,b,c){var d=this.aabbSplit_,g=this.aabbLoose_;d.copy(c);g.copy(c);this.iTris_.length=0;c=this.iTris_;var f=a.triangles_,k=b.length,e=Triangle.tagMask_,h=0,l;if(this.parent_&&this.parent_.child_[7]===this)for(h=0;h<k;++h)l=f[b[h]],l.tagFlag_!==e&&(g.expandsWithAabb(l.aabb_),c.push(b[h]));else for(h=0;h<k;++h)l=f[b[h]],d.pointInside(l.aabb_.computeCenter())&&l.tagFlag_!==e&&(g.expandsWithAabb(l.aabb_),c.push(b[h]));b=c.length;if(b>Octree.maxTriangles_&&this.depth_<
Octree.maxDepth_)this.constructCells(a);else for(h=0;h<b;++h)l=f[c[h]],l.tagFlag_=e,l.leaf_=this,l.posInLeaf_=h},constructCells:function(a){var b=this.child_,c=this.iTris_,d=this.aabbSplit_.min_,g=this.aabbSplit_.max_,f=d[0],k=d[1],e=d[2],h=g[0],l=g[1],m=g[2],n=this.aabbSplit_.computeCenter(),p=n[0],q=n[1],r=n[2],s=0.5*(h-f),t=0.5*(l-k),v=0.5*(m-e),u=this.depth_+1,w=new Aabb;b[0]=new Octree(this,u);b[0].build(a,c,w.setCopy(d,n));b[1]=new Octree(this,u);b[1].build(a,c,w.set(f+s,k,e,p+s,q,r));b[2]=
new Octree(this,u);b[2].build(a,c,w.set(p,q-t,r,h,l-t,m));b[3]=new Octree(this,u);b[3].build(a,c,w.set(f,k,e+v,p,q,r+v));b[4]=new Octree(this,u);b[4].build(a,c,w.set(f,k+t,e,p,q+t,r));b[5]=new Octree(this,u);b[5].build(a,c,w.set(p,q,r-v,h,l,m-v));b[6]=new Octree(this,u);b[6].build(a,c,w.setCopy(n,g));b[7]=new Octree(this,u);b[7].build(a,c,w.set(p-s,q,r,h-s,l,m));this.iTris_.length=0},intersectRay:function(a,b){if(this.aabbLoose_.intersectRay(a,b)){if(this.child_[0]){for(var c=[],d=this.child_,g=0;8>
g;++g){var f=d[g].intersectRay(a,b);c.push.apply(c,f)}return c}return this.iTris_}return[]},intersectSphere:function(a,b,c){if(this.aabbSplit_.intersectSphere(a,b)){if(this.child_[0]){for(var d=[],g=this.child_,f=0;8>f;++f){var k=g[f].intersectSphere(a,b,c);d.push.apply(d,k)}return d}c.push(this);return this.iTris_}return[]},addTriangle:function(a,b){if(this.aabbSplit_.pointInside(b.aabb_.computeCenter())){this.aabbLoose_.expandsWithAabb(b.aabb_);var c=this.child_;if(c[0])for(var d=0;8>d;++d)c[d].addTriangle(a,
b);else b.posInLeaf_=this.iTris_.length,b.leaf_=this,this.iTris_.push(b.id_)}}};Octree.checkEmptiness=function(a,b){var c=a.parent_;if(c){for(var d=c.child_,g=0,g=0;8>g;++g)if(0<d[g].iTris_.length||d[g].child_[0])return;b.push(c);for(g=0;8>g;++g)b.push(d[g]);Octree.checkEmptiness(c,b)}};function Picking(a){this.mesh_=null;this.pickedTriangle_=-1;this.pickedVertices_=[];this.interPoint_=[0,0,0];this.rDisplay_=50;this.rWorldSqr_=0;this.camera_=a;this.eyeDir_=[0,0,0]}
Picking.prototype={intersectionMouseMesh:function(a,b,c,d,g,f){var k=this.camera_.unproject(b,c,0),e=this.camera_.unproject(b,c,1),h=mat4.create();mat4.invert(h,a.matTransform_);vec3.transformMat4(k,k,h);vec3.transformMat4(e,e,h);g&&(Geometry.mirrorPoint(k,g,f),Geometry.mirrorPoint(e,g,f));this.intersectionRayMesh(a,k,e,b,c,d);a=this.eyeDir_;vec3.sub(a,e,k);vec3.normalize(a,a)},intersectionRayMesh:function(a,b,c,d,g,f){this.mesh_=null;this.pickedTriangle_=-1;var k=a.triangles_,e=a.vertexArray_,h=
a.indexArray_,l=[0,0,0];vec3.sub(l,c,b);vec3.normalize(l,l);for(var l=a.octree_.intersectRay(b,[1/l[0],1/l[1],1/l[2]]),m=-1,n=l.length,p=[0,0,0],q=0;q<n;++q){var r=l[q],s=k[r],r=3*r,t=3*h[r],v=3*h[r+1],r=3*h[r+2];if(Geometry.intersectionRayTriangle(b,c,[e[t],e[t+1],e[t+2]],[e[v],e[v+1],e[v+2]],[e[r],e[r+1],e[r+2]],s.normal_,p)&&(s=vec3.sqrDist(b,p),s<m||-1===m))m=s,vec3.copy(this.interPoint_,p),this.pickedTriangle_=l[q]}-1!==this.pickedTriangle_?(this.mesh_=a,this.computeRadiusWorldSq(d,g,f)):this.rWorldSqr_=
0},pickVerticesInSphere:function(a){this.pickedVertices_=[];for(var b=this.mesh_.vertices_,c=this.mesh_.vertexArray_,d=this.mesh_.octree_.intersectSphere(this.interPoint_,a,this.mesh_.leavesUpdate_),d=this.mesh_.getVerticesFromTriangles(d),g=d.length,f=++Vertex.sculptMask_,k=this.pickedVertices_,e=0,h=e=0;h<g;++h){var e=d[h],l=b[e],e=3*e;vec3.sqrDist([c[e],c[e+1],c[e+2]],this.interPoint_)<a&&(l.sculptFlag_=f,k.push(d[h]))}0===this.pickedVertices_.length&&-1!==this.pickedTriangle_&&(a=this.mesh_.indexArray_,
e=3*this.pickedTriangle_,this.pickedVertices_.push(a[e],a[e+1],a[e+2]))},computeRadiusWorldSq:function(a,b,c){var d=[0,0,0];vec3.transformMat4(d,this.interPoint_,this.mesh_.matTransform_);var g=this.camera_.project(d)[2];a=this.camera_.unproject(a+this.rDisplay_*c,b,g);this.rWorldSqr_=vec3.sqrDist(d,a)}};function Render(a){this.gl_=a;this.color_=[168,66,66];this.shaderType_=Render.mode.PHONG;this.reflectionTexUnif_=this.colorUnif_=this.lightPositionUnif_=this.radiusSquaredUnif_=this.centerPickingUnif_=this.normalMatrixUnif_=this.mvMatrixUnif_=this.mvpMatrixUnif_=this.barycenterAttrib_=this.normalAttrib_=this.vertexAttrib_=this.vertexShader_=this.fragmentShader_=this.shaderProgram_=this.reflectionLoc_=this.indexBuffer_=this.barycenterBuffer_=this.normalBuffer_=this.vertexBuffer_=null}
Render.mode={PHONG:0,TRANSPARENCY:1,WIREFRAME:2,MATERIAL:3};
Render.prototype={updateShaders:function(a,b,c){var d=this.gl_;this.shaderType_=a;d.deleteProgram(this.shaderProgram_);a>=Render.mode.MATERIAL&&(this.reflectionLoc_=this.loadTexture(d,b[a-Render.mode.MATERIAL]));this.initShaders(c)},loadTexture:function(a,b){var c=a.createTexture();a.bindTexture(a.TEXTURE_2D,c);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,b);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR_MIPMAP_NEAREST);
a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null);return c},initShaders:function(a){var b=this.gl_;switch(this.shaderType_){case Render.mode.PHONG:this.loadShaders(a.phongVertex,a.phongFragment);break;case Render.mode.WIREFRAME:this.loadShaders(a.wireframeVertex,a.wireframeFragment);break;case Render.mode.TRANSPARENCY:this.loadShaders(a.transparencyVertex,a.transparencyFragment);break;default:this.loadShaders(a.reflectionVertex,a.reflectionFragment)}a=this.shaderProgram_=b.createProgram();
b.attachShader(a,this.vertexShader_);b.attachShader(a,this.fragmentShader_);b.linkProgram(a);b.useProgram(a);this.vertexAttrib_=b.getAttribLocation(this.shaderProgram_,"vertex");this.normalAttrib_=b.getAttribLocation(this.shaderProgram_,"normal");this.shaderType_===Render.mode.WIREFRAME&&(this.barycenterAttrib_=b.getAttribLocation(this.shaderProgram_,"barycenter"));this.mvpMatrixUnif_=b.getUniformLocation(a,"mvpMat");this.mvMatrixUnif_=b.getUniformLocation(a,"mvMat");this.normalMatrixUnif_=b.getUniformLocation(a,
"nMat");this.centerPickingUnif_=b.getUniformLocation(a,"centerPicking");this.radiusSquaredUnif_=b.getUniformLocation(a,"radiusSquared");this.colorUnif_=b.getUniformLocation(a,"color");this.shaderType_===Render.mode.TRANSPARENCY&&(this.lightPositionUnif_=b.getUniformLocation(a,"lightPos"));this.shaderType_>=Render.mode.MATERIAL&&(this.reflectionTexUnif_=b.getUniformLocation(a,"refTex"));b.detachShader(a,this.fragmentShader_);b.deleteShader(this.fragmentShader_);b.detachShader(a,this.vertexShader_);
b.deleteShader(this.vertexShader_)},loadShaders:function(a,b){var c=this.gl_;this.vertexShader_=c.createShader(c.VERTEX_SHADER);c.shaderSource(this.vertexShader_,a);c.compileShader(this.vertexShader_);this.fragmentShader_=c.createShader(c.FRAGMENT_SHADER);c.shaderSource(this.fragmentShader_,b);c.compileShader(this.fragmentShader_)},initBuffers:function(a,b,c){var d=this.gl_;this.vertexBuffer_=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,this.vertexBuffer_);d.bufferData(d.ARRAY_BUFFER,a,d.DYNAMIC_DRAW);
this.normalBuffer_=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,this.normalBuffer_);d.bufferData(d.ARRAY_BUFFER,b,d.DYNAMIC_DRAW);this.indexBuffer_=d.createBuffer();d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,this.indexBuffer_);d.bufferData(d.ELEMENT_ARRAY_BUFFER,c,d.STATIC_DRAW)},render:function(a,b,c,d,g){var f=this.gl_;f.useProgram(this.shaderProgram_);var k=b.interPoint_;b=b.rWorldSqr_;var e=mat4.create();mat4.mul(e,a.view_,c);c=mat4.create();mat4.mul(c,a.proj_,e);f.enableVertexAttribArray(this.vertexAttrib_);
f.bindBuffer(f.ARRAY_BUFFER,this.vertexBuffer_);f.vertexAttribPointer(this.vertexAttrib_,3,f.FLOAT,!1,0,0);f.enableVertexAttribArray(this.normalAttrib_);f.bindBuffer(f.ARRAY_BUFFER,this.normalBuffer_);f.vertexAttribPointer(this.normalAttrib_,3,f.FLOAT,!1,0,0);f.uniformMatrix4fv(this.mvMatrixUnif_,!1,e);f.uniformMatrix4fv(this.mvpMatrixUnif_,!1,c);f.uniformMatrix3fv(this.normalMatrixUnif_,!1,mat3.normalFromMat4(mat3.create(),e));f.uniform3fv(this.centerPickingUnif_,vec3.transformMat4([0,0,0],k,e));
f.uniform1f(this.radiusSquaredUnif_,b);switch(this.shaderType_){case Render.mode.PHONG:f.uniform3fv(this.colorUnif_,vec3.scale([0,0,0],this.color_,1/255));this.drawBuffer(d);break;case Render.mode.WIREFRAME:f.enableVertexAttribArray(this.barycenterAttrib_);f.bindBuffer(f.ARRAY_BUFFER,this.barycenterBuffer_);f.vertexAttribPointer(this.barycenterAttrib_,3,f.FLOAT,!1,0,0);f.uniform3fv(this.colorUnif_,vec3.scale([0,0,0],this.color_,1/255));f.drawArrays(f.TRIANGLES,0,d);break;case Render.mode.TRANSPARENCY:f.depthMask(!1);
f.enable(f.BLEND);f.uniform4fv(this.colorUnif_,[this.color_[0]/255,this.color_[1]/255,this.color_[2]/255,0.15]);f.uniform3fv(this.lightPositionUnif_,g);this.drawBuffer(d);f.disable(f.BLEND);f.depthMask(!0);break;default:f.activeTexture(f.TEXTURE0),f.bindTexture(f.TEXTURE_2D,this.reflectionLoc_),f.uniform1i(this.reflectionTexUnif_,0),this.drawBuffer(d)}},drawBuffer:function(a){var b=this.gl_;b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,this.indexBuffer_);b.drawElements(b.TRIANGLES,a,SculptGL.elementIndexType,
0)},updateBuffers:function(a,b,c){if(this.shaderType_===Render.mode.WIREFRAME)this.makeWireframeBuffers(a,b,c);else{var d=this.gl_;d.bindBuffer(d.ARRAY_BUFFER,this.vertexBuffer_);d.bufferData(d.ARRAY_BUFFER,a,d.DYNAMIC_DRAW);d.bindBuffer(d.ARRAY_BUFFER,this.normalBuffer_);d.bufferData(d.ARRAY_BUFFER,b,d.DYNAMIC_DRAW);d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,this.indexBuffer_);d.bufferData(d.ELEMENT_ARRAY_BUFFER,c,d.STATIC_DRAW)}},makeWireframeBuffers:function(a,b,c){for(var d=this.gl_,g=new Float32Array(3*
c.length),f=0,k=0,e=0,f=0;f<c.length;++f)k=3*f,e=3*c[f],g[k]=a[e],g[k+1]=a[e+1],g[k+2]=a[e+2];d.bindBuffer(d.ARRAY_BUFFER,this.vertexBuffer_);d.bufferData(d.ARRAY_BUFFER,g,d.DYNAMIC_DRAW);a=new Float32Array(3*c.length);for(f=0;f<c.length;++f)k=3*f,e=3*c[f],a[k]=b[e],a[k+1]=b[e+1],a[k+2]=b[e+2];d.bindBuffer(d.ARRAY_BUFFER,this.normalBuffer_);d.bufferData(d.ARRAY_BUFFER,a,d.DYNAMIC_DRAW);b=new Float32Array(3*c.length);for(f=0;f<c.length/3;++f)k=9*f,b[k]=1,b[k+1]=0,b[k+2]=0,b[k+3]=0,b[k+4]=1,b[k+5]=
0,b[k+6]=0,b[k+7]=0,b[k+8]=1;this.barycenterBuffer_||(this.barycenterBuffer_=d.createBuffer());d.bindBuffer(d.ARRAY_BUFFER,this.barycenterBuffer_);d.bufferData(d.ARRAY_BUFFER,b,d.DYNAMIC_DRAW)}};function Sculpt(a){this.states_=a;this.mesh_=null;this.intensity_=0.75;this.tool_=Sculpt.tool.BRUSH;this.topo_=Sculpt.topo.SUBDIVISION;this.detailSubdivision_=0.75;this.detailDecimation_=0.1;this.culling_=this.clay_=this.negative_=!1;this.d2Max_=this.d2Min_=0;this.d2Thickness_=0.5;this.d2Move_=0;this.rotateData_={normal:[0,0,0],center:[0,0]};this.rotateDataSym_={normal:[0,0,0],center:[0,0]};this.dragDir_=[0,0,0];this.dragDirSym_=[0,0,0]}
Sculpt.tool={BRUSH:0,INFLATE:1,ROTATE:2,SMOOTH:3,FLATTEN:4,PINCH:5,CREASE:6,DRAG:7};Sculpt.topo={STATIC:0,SUBDIVISION:1,ADAPTIVE:2};
Sculpt.prototype={setAdaptiveParameters:function(a){this.d2Max_=0.2*a*(1.1-this.detailSubdivision_);this.d2Min_=this.d2Max_/4.2025;this.d2Move_=0.2375*this.d2Min_;this.d2Thickness_=1.1*(4*this.d2Move_+this.d2Max_/3)},sculptStroke:function(a,b,c,d,g){var f=g.ptPlane_,k=g.nPlane_,e=g.picking_,h=g.pickingSym_,l=g.lastMouseX_,m=g.lastMouseY_,n=a-l,p=b-m,q=Math.sqrt(n*n+p*p);g.sumDisplacement_+=q;var r=g.sumDisplacement_,s=0.2*e.rDisplay_,t=q/Math.floor(q/s),n=n/q,p=p/q;g.continuous_?q=r=0:(a=l,b=m);var l=
g.mesh_,m=g.symmetry_,v=this.tool_===Sculpt.tool.DRAG;if(v){s=0;e.mesh_=h.mesh_=l;var u=e.interPoint_,w=h.interPoint_;w[0]=u[0];w[1]=u[1];w[2]=u[2];Geometry.mirrorPoint(w,f,k)}if(r>50*s&&!v)r=0;else if(r>s||0===r){for(s=r=0;s<=q;s+=t){v?this.updateDragDir(l,e,a,b,c):e.intersectionMouseMesh(l,a,b,c);if(!e.mesh_)break;e.pickVerticesInSphere(e.rWorldSqr_);this.sculptMesh(e,d);if(m){v?this.updateDragDir(l,h,a,b,c,f,k):h.intersectionMouseMesh(l,a,b,c,f,k);if(!h.mesh_)break;h.rWorldSqr_=e.rWorldSqr_;h.pickVerticesInSphere(h.rWorldSqr_);
this.sculptMesh(h,d,!0)}a+=n*t;b+=p*t}this.mesh_.updateBuffers()}g.sumDisplacement_=r},sculptMesh:function(a,b,c,d,g,f,k){var e=this.mesh_,h=a.pickedVertices_,l=a.rWorldSqr_,m=a.interPoint_,n=a.eyeDir_;a=e.vertices_;var p=e.getTrianglesFromVertices(h);b*=this.intensity_;this.states_.pushState(p,h);var q=new Topology(this.states_);q.mesh_=e;q.radiusSquared_=l;q.center_=m;this.setAdaptiveParameters(l);switch(this.topo_){case Sculpt.topo.SUBDIVISION:p=q.subdivision(p,this.d2Max_);0<this.detailDecimation_&&
(p=q.decimation(p,this.d2Min_*this.detailDecimation_));break;case Sculpt.topo.ADAPTIVE:p=q.subdivision(p,this.d2Max_),p=q.decimation(p,this.d2Min_)}for(var h=e.getVerticesFromTriangles(p),r=h.length,s=[],t=[],v=Vertex.sculptMask_,u=e.normalArray_,w=n[0],x=n[1],n=n[2],y=0;y<r;++y){var z=h[y];if(a[z].sculptFlag_===v){s.push(z);var D=3*z;0>=u[D]*w+u[D+1]*x+u[D+2]*n&&t.push(z)}}if(0!==t.length)switch(this.culling_&&(s=t),this.tool_){case Sculpt.tool.BRUSH:this.brush(m,s,t,l,b);break;case Sculpt.tool.INFLATE:this.inflate(m,
s,l,b);break;case Sculpt.tool.ROTATE:this.rotate(m,s,l,d,g,f,k,c);break;case Sculpt.tool.SMOOTH:this.smooth(s,b);break;case Sculpt.tool.FLATTEN:this.flatten(m,s,t,l,b);break;case Sculpt.tool.PINCH:this.pinch(m,s,l,b);break;case Sculpt.tool.CREASE:this.crease(m,s,t,l,b);break;case Sculpt.tool.DRAG:this.drag(m,s,l,c)}this.topo_===Sculpt.topo.ADAPTIVE&&(p=q.adaptTopology(p,this.d2Thickness_),h=e.getVerticesFromTriangles(p));e.updateMesh(p,h)},brush:function(a,b,c,d,g){var f=this.areaNormal(c);if(f){var k=
this.areaCenter(c);c=this.mesh_.vertexArray_;d=Math.sqrt(d);var e=b.length,h=0.1*g*d;g=this.clay_?g:0.3*g;this.negative_&&(h=-h);var l=a[0],m=a[1];a=a[2];for(var n=k[0],p=k[1],k=k[2],q=f[0],r=f[1],f=f[2],s=this.topo_===Sculpt.topo.ADAPTIVE,t=Math.sqrt(this.d2Move_),v=0;v<e;++v){var u=3*b[v],w=c[u],x=c[u+1],y=c[u+2],z=(w-n)*q+(x-p)*r+(y-k)*f,w=w-l,x=x-m,y=y-a,y=Math.sqrt(w*w+x*x+y*y)/d,y=3*y*y*y*y-4*y*y*y+1,y=y*(z*g-h);s&&y>t&&(y=t);c[u]-=q*y;c[u+1]-=r*y;c[u+2]-=f*y}}},inflate:function(a,b,c,d){var g=
this.mesh_,f=g.vertexArray_,g=g.normalArray_,k=b.length;c=Math.sqrt(c);d=0.1*d*c;this.topo_===Sculpt.topo.ADAPTIVE&&(d=Math.min(Math.sqrt(this.d2Move_),d));this.negative_&&(d=-d);var e=a[0],h=a[1];a=a[2];for(var l=0;l<k;++l){var m=3*b[l],n=f[m]-e,p=f[m+1]-h,q=f[m+2]-a,n=Math.sqrt(n*n+p*p+q*q)/c,n=3*n*n*n*n-4*n*n*n+1,n=d*n;f[m]+=g[m]*n;f[m+1]+=g[m+1]*n;f[m+2]+=g[m+2]*n}},startRotate:function(a,b,c,d,g,f,k){var e=a.camera_.unproject(b,c,0),h=a.camera_.unproject(b,c,1),l=mat4.create();mat4.invert(l,
this.mesh_.matTransform_);vec3.transformMat4(e,e,l);vec3.transformMat4(h,h,l);this.initRotateData(a,e,h,b,c,this.rotateData_);k&&(k=[e[0],e[1],e[2]],Geometry.mirrorPoint(k,g,f),h=[h[0],h[1],h[2]],Geometry.mirrorPoint(h,g,f),this.initRotateData(d,k,h,b,c,this.rotateDataSym_),d.rWorldSqr_=a.rWorldSqr_)},initRotateData:function(a,b,c,d,g,f){a.intersectionRayMesh(this.mesh_,b,c,d,g,1);a.mesh_&&(a.pickVerticesInSphere(a.rWorldSqr_),a=[0,0,0],vec3.sub(a,b,c),f.normal=vec3.normalize(a,a),f.center=[d,g])},
rotate:function(a,b,c,d,g,f,k,e){var h=this.rotateData_;e&&(h=this.rotateDataSym_);e=h.center;g=[d-e[0],g-e[1]];if(!(30>vec2.len(g))){vec2.normalize(g,g);h=h.normal;d=[0,0,0,0];f=[f-e[0],k-e[1]];vec2.normalize(f,f);f=Geometry.signedAngle2d(g,f);k=this.mesh_.vertexArray_;c=Math.sqrt(c);e=b.length;g=a[0];for(var l=a[1],m=a[2],n=0;n<e;++n){var p=3*b[n],q=k[p]-g,r=k[p+1]-l,s=k[p+2]-m,q=Math.sqrt(q*q+r*r+s*s)/c,r=[k[p],k[p+1],k[p+2]];quat.setAxisAngle(d,h,f*(3*q*q*q*q-4*q*q*q+1));vec3.sub(r,r,a);vec3.transformQuat(r,
r,d);vec3.add(r,r,a);k[p]=r[0];k[p+1]=r[1];k[p+2]=r[2]}}},smooth:function(a,b){var c=this.mesh_.vertexArray_,d=a.length,g=new Float32Array(3*d);this.laplacianSmooth(a,g);for(var f=this.d2Move_,k=Math.sqrt(f),e=this.topo_===Sculpt.topo.ADAPTIVE,h=0;h<d;++h){var l=3*a[h],m=3*h,n=(g[m]-c[l])*b,p=(g[m+1]-c[l+1])*b,m=(g[m+2]-c[l+2])*b;if(e){var q=n*n+p*p+m*m;q>f&&(q=k/Math.sqrt(q),n*=q,p*=q,m*=q)}c[l]+=n;c[l+1]+=p;c[l+2]+=m}},flatten:function(a,b,c,d,g){var f=this.areaNormal(c);if(f){var k=this.areaCenter(c);
c=this.mesh_.vertexArray_;d=Math.sqrt(d);var e=b.length;g*=0.3;var h=a[0],l=a[1];a=a[2];for(var m=k[0],n=k[1],k=k[2],p=f[0],q=f[1],f=f[2],r=Math.sqrt(this.d2Move_),s=this.topo_===Sculpt.topo.ADAPTIVE,t=0;t<e;++t){var v=3*b[t],u=c[v],w=c[v+1],x=c[v+2],y=(u-m)*p+(w-n)*q+(x-k)*f,u=u-h,w=w-l,x=x-a,x=Math.sqrt(u*u+w*w+x*x)/d,x=3*x*x*x*x-4*x*x*x+1,x=y*g*x;s&&x>r&&(x=r);c[v]-=p*x;c[v+1]-=q*x;c[v+2]-=f*x}}},pinch:function(a,b,c,d){var g=this.mesh_.vertexArray_;c=Math.sqrt(c);var f=b.length,k=a[0],e=a[1];
a=a[2];var h=this.d2Move_,l=Math.sqrt(h),m=this.topo_===Sculpt.topo.ADAPTIVE;d=0.005*d*c;for(var n=0;n<f;++n){var p=3*b[n],q=k-g[p],r=e-g[p+1],s=a-g[p+2],t=Math.sqrt(q*q+r*r+s*s)/c,t=3*t*t*t*t-4*t*t*t+1,t=d*t,q=q*t,r=r*t,s=s*t;m&&(t=q*q+r*r+s*s,t>h&&(t=l/Math.sqrt(t),q*=t,r*=t,s*=t));g[p]+=q;g[p+1]+=r;g[p+2]+=s}},crease:function(a,b,c,d,g){var f=this.areaNormal(c);if(f){c=this.mesh_.vertexArray_;d=Math.sqrt(d);var k=b.length,e=a[0],h=a[1];a=a[2];var l=f[0],m=f[1],f=f[2],n=this.d2Move_,p=Math.sqrt(n),
q=this.topo_===Sculpt.topo.ADAPTIVE;g=0.005*g*d;var r=10;this.negative_&&(r=-10);for(var s=0;s<k;++s){var t=3*b[s],v=e-c[t],u=h-c[t+1],w=a-c[t+2],x=Math.sqrt(v*v+u*u+w*w)/d,x=3*x*x*x*x-4*x*x*x+1,y=g*Math.pow(2-x,-5)*r,x=0.1*x,v=v*x+l*y,u=u*x+m*y,w=w*x+f*y;q&&(x=v*v+u*u+w*w,x>n&&(x=p/Math.sqrt(x),v*=x,u*=x,w*=x));c[t]+=v;c[t+1]+=u;c[t+2]+=w}}},updateDragDir:function(a,b,c,d,g,f,k){var e=b.camera_.unproject(c,d,0),h=b.camera_.unproject(c,d,1),l=mat4.create();mat4.invert(l,a.matTransform_);vec3.transformMat4(e,
e,l);vec3.transformMat4(h,h,l);l=this.dragDir_;f&&(l=this.dragDirSym_,Geometry.mirrorPoint(e,f,k),Geometry.mirrorPoint(h,f,k));f=b.interPoint_;b.interPoint_=Geometry.vertexOnLine(f,e,h);vec3.sub(l,b.interPoint_,f);b.mesh=a;b.computeRadiusWorldSq(c,d,g);a=b.eyeDir_;vec3.sub(a,h,e);vec3.normalize(a,a)},drag:function(a,b,c,d){var g=this.mesh_.vertexArray_,f=b.length;c=Math.sqrt(c);var k=a[0],e=a[1];a=a[2];var h=d?this.dragDirSym_:this.dragDir_;d=h[0];for(var l=h[1],h=h[2],m=0;m<f;++m){var n=3*b[m],p=
g[n]-k,q=g[n+1]-e,r=g[n+2]-a,p=Math.sqrt(p*p+q*q+r*r)/c,p=3*p*p*p*p-4*p*p*p+1;g[n]+=d*p;g[n+1]+=l*p;g[n+2]+=h*p}},smoothFlat:function(a,b){var c=this.mesh_,d=c.vertexArray_,c=c.normalArray_,g=a.length,f=new Float32Array(3*g);this.laplacianSmooth(a,f);for(var k=0;k<g;++k){var e=3*a[k],h=d[e],l=d[e+1],m=d[e+2],n=c[e],p=c[e+1],q=c[e+2],r=3*k,s=f[r],t=f[r+1],r=f[r+2],v=n*(s-h)+p*(t-l)+q*(r-m);d[e]+=(s-n*v-h)*b;d[e+1]+=(t-p*v-l)*b;d[e+2]+=(r-q*v-m)*b}},laplacianSmooth:function(a,b){for(var c=this.mesh_,
d=c.vertices_,c=c.vertexArray_,g=a.length,f=0;f<g;++f){var k=3*f,e=d[a[f]],h=e.ringVertices_,l=h.length,m=0,n=0,p=0,q=0,r=0;if(l!==e.tIndices_.length){for(q=e=0;q<l;++q){var r=h[q],s=d[r];s.ringVertices_.length!==s.tIndices_.length&&(r*=3,m+=c[r],n+=c[r+1],p+=c[r+2],++e)}b[k]=m/e;b[k+1]=n/e;b[k+2]=p/e}else{for(q=0;q<l;++q)r=3*h[q],m+=c[r],n+=c[r+1],p+=c[r+2];b[k]=m/l;b[k+1]=n/l;b[k+2]=p/l}}},areaNormal:function(a){for(var b=this.mesh_.normalArray_,c=a.length,d=0,g=0,f=0,k=0;k<c;++k)var e=3*a[k],d=
d+b[e],g=g+b[e+1],f=f+b[e+2];a=Math.sqrt(d*d+g*g+f*f);if(0===a)return null;a=1/a;return[d*a,g*a,f*a]},areaCenter:function(a){for(var b=this.mesh_.vertexArray_,c=a.length,d=0,g=0,f=0,k=0;k<c;++k)var e=3*a[k],d=d+b[e],g=g+b[e+1],f=f+b[e+2];return[d/c,g/c,f/c]}};var Tools={nextHighestPowerOfTwo:function(a){--a;for(var b=1;32>b;b<<=1)a|=a>>b;return a+1},tidy:function(a){a.sort(function(a,b){return a-b});for(var b=a.length,c=0,d=0,c=1;c<b;++c)a[d]!==a[c]&&(a[++d]=a[c]);1<c&&(a.length=d+1)},intersectionArrays:function(a,b){for(var c=0,d=0,g=[],f=a.length,k=b.length;c<f&&d<k;)a[c]<b[d]?c++:a[c]>b[d]?d++:(g.push(a[c]),++c,++d);return g}},Tablet={};Tablet.plugin=document.querySelector("object[type='application/x-wacomtabletplugin']");
Tablet.pressure=function(){var a;Tablet.plugin&&(a=Tablet.plugin.penAPI);return a&&a.pointerType?a.pressure:1};"function"!==typeof String.prototype.endsWith&&(String.prototype.endsWith=function(a){return this.slice(-a.length)===a});"function"!==typeof String.prototype.startsWith&&(String.prototype.startsWith=function(a){return this.slice(0,a.length)===a});
Array.prototype.rotate=function(){return function(a){a=-a;var b=this.length;a=(Math.abs(a)>=b&&(a%=b),0>a&&(a+=b),a);for(var c,d;a;a=(Math.ceil(b/a)-1)*a-b+(b=a))for(c=b;c>a;d=this[--c],this[c]=this[c-a],this[c-a]=d);return this}}();function Topology(a){this.states_=a;this.mesh_=null;this.center_=[0,0,0];this.verticesMap_={};this.radiusSquared_=0;this.iTrisToDelete_=[];this.iVertsToDelete_=[];this.iVertsDecimated_=[]};Topology.prototype.subdivision=function(a,b){var c=this.mesh_.triangles_,d=0;do d=c.length,a=this.subdivide(a,b);while(d!==c.length);return a};
Topology.prototype.subdivide=function(a,b){var c=this.mesh_,d=c.vertices_,g=c.triangles_,f=d.length,k=g.length,e=[],h=[];this.verticesMap_={};this.initSplit(a,e,h,b);20<e.length&&c.expandsTriangles(e,3);this.states_.pushState(e,c.getVerticesFromTriangles(e));h.length=e.length;this.checkArrayLength(e.length);this.subdivideTriangles(e,h,b);for(var h=[],l=g.length,e=0,e=k;e<l;++e)h.push(e);c.expandsTriangles(h,1);e=h.slice(l-k);this.states_.pushState(e,c.getVerticesFromTriangles(e));a.push.apply(a,h);
for(var k=[],l=a.length,m=++Triangle.tagMask_,e=0;e<l;++e){var n=a[e],p=g[n];p.tagFlag_!==m&&(p.tagFlag_=m,k.push(n))}for(e=g.length;0<h.length;)h=this.fillTriangles(h);for(l=g.length;e<l;++e)k.push(e);g=[];h=d.length;for(e=f;e<h;++e)g.push(e);f=g.length;c.expandsVertices(g,1);e=new Sculpt;e.mesh_=c;e.smoothFlat(g.slice(f),1);for(var c=this.mesh_.vertexArray_,e=this.center_,h=e[0],l=e[1],m=e[2],n=Vertex.sculptMask_,f=g.length,q=0,e=0;e<f;++e){var p=g[e],q=3*p,r=c[q]-h,s=c[q+1]-l,q=c[q+2]-m;d[p].sculptFlag_=
r*r+s*s+q*q<this.radiusSquared_?n:n-1}return k};
Topology.prototype.checkArrayLength=function(a){var b=this.mesh_,c=b.triangles_,d=b.vertexArray_,g=b.normalArray_,f=b.indexArray_,k=0,e=3*b.vertices_.length+200*a;if(d.length<e){b=new Float32Array(2*e);e=d.length;for(k=0;k<e;++k)b[k]=d[k];this.mesh_.vertexArray_=b;b=new Float32Array(2*e);for(k=0;k<e;++k)b[k]=g[k];this.mesh_.normalArray_=b}a=3*c.length+200*a;if(f.length<a){b=new SculptGL.indexArrayType(2*a);a=f.length;for(k=0;k<a;++k)b[k]=f[k];this.mesh_.indexArray_=b}};
Topology.prototype.initSplit=function(a,b,c,d){for(var g=a.length,f=0;f<g;++f){switch(this.findSplit(a[f],d,!0)){case 1:c.push(1);break;case 2:c.push(2);break;case 3:c.push(3);break;default:continue}b.push(a[f])}};
Topology.prototype.findSplit=function(a,b,c){var d=this.mesh_,g=d.vertexArray_,d=d.indexArray_,f=3*a;a=d[f+1];var k=d[f+2],f=3*d[f],d=[g[f],g[f+1],g[f+2]],f=3*a;a=[g[f],g[f+1],g[f+2]];f=3*k;g=[g[f],g[f+1],g[f+2]];if(c&&!Geometry.sphereIntersectTriangle(this.center_,2*this.radiusSquared_,d,a,g)&&!Geometry.pointInsideTriangle(this.center_,d,a,g))return 0;f=[0,0,0];c=vec3.sqrLen(vec3.sub(f,d,a));a=vec3.sqrLen(vec3.sub(f,a,g));d=vec3.sqrLen(vec3.sub(f,d,g));return c>a&&c>d?c>b?1:0:a>d?a>b?2:0:d>b?3:0};
Topology.prototype.subdivideTriangles=function(a,b,c){for(var d=this.mesh_.indexArray_,g=a.length,f=0;f<g;++f){var k=3*a[f];if(1===b[f])this.halfEdgeSplit(a[f],d[k],d[k+1],d[k+2]);else if(2===b[f])this.halfEdgeSplit(a[f],d[k+1],d[k+2],d[k]);else if(3===b[f])this.halfEdgeSplit(a[f],d[k+2],d[k],d[k+1]);else{var e=this.findSplit(a[f],c);1===e?this.halfEdgeSplit(a[f],d[k],d[k+1],d[k+2]):2===e?this.halfEdgeSplit(a[f],d[k+1],d[k+2],d[k]):3===e&&this.halfEdgeSplit(a[f],d[k+2],d[k],d[k+1])}}};
Topology.prototype.halfEdgeSplit=function(a,b,c,d){var g=this.mesh_,f=g.vertices_,k=g.triangles_,e=g.vertexArray_,h=g.normalArray_,l=g.indexArray_,m=k[a].leaf_,g=m.iTris_,n=f[b],p=f[c],q=f[d],r=this.verticesMap_,s=[Math.min(b,c),Math.max(b,c)],t=!1,v=r[s];void 0===v&&(v=f.length,t=!0,r[s]=v);q.ringVertices_.push(v);var u=3*a;l[u]=b;l[u+1]=v;l[u+2]=d;r=k.length;s=new Triangle(r);u=3*r;l[u]=v;l[u+1]=c;l[u+2]=d;s.stateFlag_=Mesh.stateMask_;q.tIndices_.push(r);p.replaceTriangle(a,r);s.leaf_=m;s.posInLeaf_=
g.length;if(t){var w=f.length,l=new Vertex(w),u=3*b,m=e[u],q=e[u+1],t=e[u+2],x=h[u],y=h[u+1],z=h[u+2],u=3*c,D=e[u],F=e[u+1],A=e[u+2],B=h[u],C=h[u+1],G=h[u+2],u=x*B+y*C+z*G,H=0,H=-1>=u?Math.PI:1<=u?0:Math.acos(u),I=x+B,J=y+C,K=z+G,E=1/Math.sqrt(I*I+J*J+K*K),u=3*w;h[u]=I*E;h[u+1]=J*E;h[u+2]=K*E;w=m-D;I=q-F;J=t-A;E=Math.sqrt(w*w+I*I+J*J);0<w*(x-B)+I*(y-C)+J*(z-G)?(e[u]=0.5*(m+D)+0.12*h[u]*H*E,e[u+1]=0.5*(q+F)+0.12*h[u+1]*H*E,e[u+2]=0.5*(t+A)+0.12*h[u+2]*H*E):(e[u]=0.5*(m+D)-0.12*h[u]*H*E,e[u+1]=0.5*
(q+F)-0.12*h[u+1]*H*E,e[u+2]=0.5*(t+A)-0.12*h[u+2]*H*E);l.stateFlag_=Mesh.stateMask_;l.ringVertices_.push(b,c,d);n.replaceRingVertex(c,v);p.replaceRingVertex(b,v);l.tIndices_.push(a,r);f.push(l)}else b=f[v],b.ringVertices_.push(d),b.tIndices_.push(a,r);g.push(r);k.push(s)};
Topology.prototype.fillTriangles=function(a){for(var b=this.mesh_,c=b.vertices_,d=b.triangles_,b=b.indexArray_,g=a.length,f=[],k=0;k<g;++k){var e=a[k],h=3*e,l=b[h],m=b[h+1],h=b[h+2],n=this.verticesMap_,p=n[[Math.min(l,m),Math.max(l,m)]],q=n[[Math.min(m,h),Math.max(m,h)]],n=n[[Math.min(l,h),Math.max(l,h)]],r=c[l].ringVertices_.length,s=c[m].ringVertices_.length,t=c[h].ringVertices_.length,v=0;p?v=q?n?r<s&&r<t?2:s<t?3:1:r<t?2:1:n&&s<t?3:1:q?v=n&&s<r?3:2:n&&(v=3);if(1===v)this.fillTriangle(e,l,m,h,p);
else if(2===v)this.fillTriangle(e,m,h,l,q);else if(3===v)this.fillTriangle(e,h,l,m,n);else continue;f.push(e,d.length-1)}return f};
Topology.prototype.fillTriangle=function(a,b,c,d,g){var f=this.mesh_,k=f.vertices_,e=f.triangles_,f=f.indexArray_,h=3*a;f[h]=b;f[h+1]=g;f[h+2]=d;b=e[a].leaf_;var l=b.iTris_,m=k[c],n=k[d],h=k[g];h.ringVertices_.push(d);n.ringVertices_.push(g);k=e.length;h.tIndices_.push(a,k);var p=new Triangle(k),h=3*k;f[h]=g;f[h+1]=c;f[h+2]=d;p.stateFlag_=Mesh.stateMask_;p.leaf_=b;p.posInLeaf_=l.length;n.tIndices_.push(k);m.replaceTriangle(a,k);l.push(k);e.push(p)};Topology.prototype.decimation=function(a,b){for(var c=0,d=this.radiusSquared_,g=Math.sqrt(d),f=this.mesh_,k=f.triangles_,e=f.vertexArray_,f=f.indexArray_,h=this.center_,l=h[0],m=h[1],h=h[2],n=0;n<a.length;++n){var p=a[n];if(!(0>k[p].tagFlag_)){var c=3*p,q=f[c],r=f[c+1],s=f[c+2],c=3*q,t=e[c],v=e[c+1],u=e[c+2],c=3*r,w=e[c],x=e[c+1],y=e[c+2],c=3*s,z=e[c],D=e[c+1],F=e[c+2],A=(t+w+z)/3-l,B=(v+x+D)/3-m,C=(u+y+F)/3-h,c=A*A+B*B+C*C;if(c<d)c=1;else if(c<2*d)c=(Math.sqrt(c)-g)/(g*Math.SQRT2-g),c=3*c*c*c*c-
4*c*c*c+1;else continue;var A=w-t,B=x-v,C=y-u,G=A*A+B*B+C*C,A=w-z,B=x-D,C=y-F,w=A*A+B*B+C*C,A=t-z,B=v-D,C=u-F,t=A*A+B*B+C*C;G<w&&G<t?G<b*c&&this.decimateTriangles(p,this.findOppositeTriangle(p,q,r),a):w<t?w<b*c&&this.decimateTriangles(p,this.findOppositeTriangle(p,r,s),a):t<b*c&&this.decimateTriangles(p,this.findOppositeTriangle(p,q,s),a)}}this.applyDeletion();return this.getValidModifiedTriangles(this.getValidModifiedVertices(),a)};
Topology.prototype.applyDeletion=function(){var a=this.iTrisToDelete_;Tools.tidy(a);for(var b=0,b=a.length-1;0<=b;--b)this.deleteTriangle(a[b]);a=this.iVertsToDelete_;Tools.tidy(a);for(b=a.length-1;0<=b;--b)this.deleteVertex(a[b])};Topology.prototype.getValidModifiedVertices=function(){for(var a=this.mesh_.vertices_,b=this.iVertsDecimated_,c=b.length,d=a.length,g=++Vertex.tagMask_,f=[],k=0;k<c;++k){var e=b[k];if(!(e>=d)){var h=a[e];h.tagFlag_!==g&&(h.tagFlag_=g,f.push(e))}}return f};
Topology.prototype.getValidModifiedTriangles=function(a,b){var c=this.mesh_,d=c.triangles_,c=c.getTrianglesFromVertices(a);b.push.apply(b,c);for(var c=[],g=b.length,f=d.length,k=++Triangle.tagMask_,e=0;e<g;++e){var h=b[e];if(!(h>=f)){var l=d[h];l.tagFlag_!==k&&(l.tagFlag_=k,c.push(h))}}return c};
Topology.prototype.findOppositeTriangle=function(a,b,c){var d=this.mesh_.vertices_;b=d[b].tIndices_;c=d[c].tIndices_;b.sort(function(a,b){return a-b});c.sort(function(a,b){return a-b});c=Tools.intersectionArrays(b,c);return 2!==c.length?-1:c[0]===a?c[1]:c[0]};
Topology.prototype.decimateTriangles=function(a,b,c){if(-1!==b){var d=this.mesh_.indexArray_,g=3*a,f=d[g],k=d[g+1],e=d[g+2],g=3*b,h=d[g],l=d[g+1],d=d[g+2];f===h?k===d?this.edgeCollapse(a,b,f,k,e,l,c):this.edgeCollapse(a,b,f,e,k,d,c):f===l?k===h?this.edgeCollapse(a,b,f,k,e,d,c):this.edgeCollapse(a,b,f,e,k,h,c):f===d?k===l?this.edgeCollapse(a,b,f,k,e,h,c):this.edgeCollapse(a,b,f,e,k,l,c):k===h?this.edgeCollapse(a,b,e,k,f,l,c):k===l?this.edgeCollapse(a,b,e,k,f,d,c):this.edgeCollapse(a,b,e,k,f,h,c)}};
Topology.prototype.edgeCollapse=function(a,b,c,d,g,f,k){var e=this.mesh_,h=e.vertices_,l=e.triangles_,m=e.vertexArray_,n=e.normalArray_,p=e.indexArray_,q=h[c],r=h[d],s=q.ringVertices_,t=r.ringVertices_,v=q.tIndices_,u=r.tIndices_,w=h[g],x=h[f];if(s.length===v.length&&t.length===u.length&&w.ringVertices_.length===w.tIndices_.length&&x.ringVertices_.length===x.tIndices_.length)if(this.iVertsDecimated_.push(c,d),this.states_.pushState(v,s),this.states_.pushState(u,t),s.sort(function(a,b){return a-b}),
t.sort(function(a,b){return a-b}),h=0,3<=Tools.intersectionArrays(s,t).length)q.removeTriangle(b),r.removeTriangle(a),w.tIndices_.push(b),x.tIndices_.push(a),h=3*a,p[h]===d?p[h]=f:p[h+1]===d?p[h+1]=f:p[h+2]=f,h=3*b,p[h]===c?p[h]=g:p[h+1]===c?p[h+1]=g:p[h+2]=g,e.computeRingVertices(c),e.computeRingVertices(d),e.computeRingVertices(g),e.computeRingVertices(f),this.cleanUpSingularVertex(c),this.cleanUpSingularVertex(d),this.cleanUpSingularVertex(g),this.cleanUpSingularVertex(f);else{var h=3*c,y=3*d;
g=n[h]+n[y];f=n[h+1]+n[y+1];var y=n[h+2]+n[y+2],z=1/Math.sqrt(g*g+f*f+y*y);g*=z;f*=z;y*=z;n[h]=g;n[h+1]=f;n[h+2]=y;s.push.apply(s,t);q.removeTriangle(a);q.removeTriangle(b);r.removeTriangle(a);r.removeTriangle(b);w.removeTriangle(a);x.removeTriangle(b);v.push.apply(v,u);q=u.length;for(n=n=0;n<q;++n)t=3*u[n],p[t]===d?p[t]=c:p[t+1]===d?p[t+1]=c:p[t+2]=c;e.computeRingVertices(c);q=u=p=0;t=s.length;for(n=0;n<t;++n)w=s[n],e.computeRingVertices(w),w*=3,p+=m[w],u+=m[w+1],q+=m[w+2];p/=t;u/=t;q/=t;e=g*(p-
m[h])+f*(u-m[h+1])+y*(q-m[h+2]);m[h]=p-g*e;m[h+1]=u-f*e;m[h+2]=q-y*e;r.tagFlag_=-1;l[a].tagFlag_=-1;l[b].tagFlag_=-1;this.iVertsToDelete_.push(d);this.iTrisToDelete_.push(a,b);k.push.apply(k,v);this.cleanUpSingularVertex(c)}};
Topology.prototype.deleteTriangle=function(a){var b=0,c=this.mesh_,d=c.vertices_,g=c.triangles_,f=c.vertexArray_,k=c.normalArray_,c=c.indexArray_,e=g[a],b=e.posInLeaf_,e=e.leaf_.iTris_,h=e[e.length-1];a!==h&&(e[b]=h,g[h].posInLeaf_=b);e.pop();e=g.length-1;if(e!==a){var h=g[e],b=3*e,l=c[b],m=c[b+1],n=c[b+2],p=Mesh.stateMask_,q=this.states_.undos_[this.states_.curUndoIndex_];h.stateFlag_!==p&&(h.stateFlag_=p,q.tState_.push(h.clone()),q.iArState_.push(l,m,n));h.id_=a;h.leaf_.iTris_[h.posInLeaf_]=a;var r=
d[l],s=d[m],d=d[n];r.stateFlag_!==p&&(b=3*l,r.stateFlag_=p,q.vState_.push(r.clone()),q.vArState_.push(f[b],f[b+1],f[b+2]),q.nArState_.push(k[b],k[b+1],k[b+2]));s.stateFlag_!==p&&(b=3*m,s.stateFlag_=p,q.vState_.push(s.clone()),q.vArState_.push(f[b],f[b+1],f[b+2]),q.nArState_.push(k[b],k[b+1],k[b+2]));d.stateFlag_!==p&&(b=3*n,d.stateFlag_=p,q.vState_.push(d.clone()),q.vArState_.push(f[b],f[b+1],f[b+2]),q.nArState_.push(k[b],k[b+1],k[b+2]));r.replaceTriangle(e,a);s.replaceTriangle(e,a);d.replaceTriangle(e,
a);this.iVertsDecimated_.push(l,m,n);g[a]=h;a*=3;c[a]=l;c[a+1]=m;c[a+2]=n}g.pop()};
Topology.prototype.deleteVertex=function(a){var b=this.mesh_,c=b.vertices_,d=b.triangles_,g=b.vertexArray_,f=b.normalArray_,k=b.indexArray_,b=c.length-1;if(a!==b){var e=0,h=c[b],e=3*b,l=g[e],m=g[e+1],n=g[e+2],p=f[e],q=f[e+1],r=f[e+2],s=Mesh.stateMask_,t=this.states_.undos_[this.states_.curUndoIndex_];h.stateFlag_!==s&&(h.stateFlag_=s,t.vState_.push(h.clone()),t.vArState_.push(l,m,n),t.nArState_.push(p,q,r));h.id_=a;for(var v=h.tIndices_,u=h.ringVertices_,w=v.length,x=u.length,y=0,y=0;y<w;++y){var e=
v[y],z=d[e],e=3*e;z.stateFlag_!==s&&(z.stateFlag_=s,t.tState_.push(z.clone()),t.iArState_.push(k[e],k[e+1],k[e+2]));k[e]===b?k[e]=a:k[e+1]===b?k[e+1]=a:k[e+2]=a}for(y=0;y<x;++y)e=u[y],d=c[e],d.stateFlag_!==s&&(e*=3,d.stateFlag_=s,t.vState_.push(d.clone()),t.vArState_.push(g[e],g[e+1],g[e+2]),t.nArState_.push(f[e],f[e+1],f[e+2])),d.replaceRingVertex(b,a);c[a]=h;e=3*a;g[e]=l;g[e+1]=m;g[e+2]=n;f[e]=p;f[e+1]=q;f[e+2]=r}c.pop()};Topology.prototype.adaptTopology=function(a,b){for(var c=this.mesh_,d=c.triangles_,g=c.vertexArray_,f=this.radiusSquared_,k=c.getVerticesFromTriangles(a),e=k.length,h=[],l=c.vertices_.length,m=0,n=0,m=this.center_,p=m[0],q=m[1],r=m[2],s=0,t=0,m=n=0;m<e;++m){var v=k[m];v>=l||(n=3*v,s=g[n]-p,t=g[n+1]-q,n=g[n+2]-r,s*s+t*t+n*n<f&&h.push(v))}this.checkCollisions(h,b);m=c.getTrianglesFromVertices(this.iVertsDecimated_);a.push.apply(a,m);c=[];g=a.length;f=d.length;++Triangle.tagMask_;k=Triangle.tagMask_;
for(m=0;m<g;++m)e=a[m],e>=f||(h=d[e],h.tagFlag_!==k&&(h.tagFlag_=k,c.push(e)));return c};
Topology.prototype.checkCollisions=function(a,b){var c=this.mesh_,d=c.vertices_,g=c.vertexArray_,f=0;this.iVertsDecimated_=[];this.iTrisToDelete_=[];this.iVertsToDelete_=[];var k=0.25*b,e=new Aabb,h=a.length;0<h&&(f=3*a[0],e.min_=[g[f],g[f+1],g[f+2]],e.max_=[g[f],g[f+1],g[f+2]]);for(var l=0,m=0,l=0;l<h;++l)f=3*a[l],e.expandsWithPoint(g[f],g[f+1],g[f+2]);var n=new Grid;n.setBoundaries(e);n.init(Math.sqrt(k));n.build(c,a);for(l=0;l<h;++l)if(e=a[l],f=d[e],!(0>f.tagFlag_)){var f=f.ringVertices_,p=f.length;
++Vertex.tagMask_;for(m=0;m<p;++m)d[f[m]].tagFlag_=Vertex.tagMask_;for(var f=3*e,q=g[f],r=g[f+1],s=g[f+2],t=n.getNeighborhood(q,r,s),v=t.length,m=0;m<v;++m){var u=t[m];if(e!==u){var w=d[u];if(!(0>w.tagFlag_||w.tagFlag_===Vertex.tagMask_)){var f=3*u,x=q-g[f],y=r-g[f+1],f=s-g[f+2];if(x*x+y*y+f*f<k){p>w.ringVertices_.length?this.vertexJoin(e,u):this.vertexJoin(u,e);break}}}}}this.applyDeletion();k=this.iVertsDecimated_=this.getValidModifiedVertices();h=k.length;g=[];n=Vertex.sculptMask_;for(l=0;l<h;++l)f=
k[l],d[f].sculptFlag_===n&&g.push(f);d=new Sculpt;d.mesh_=c;c.expandsVertices(g,1);d.smooth(g,1)};
Topology.prototype.vertexJoin=function(a,b){var c=this.mesh_,d=c.vertices_,g=c.vertexArray_,f=c.normalArray_,k=d[a],d=d[b],e=k.tIndices_,h=d.tIndices_,l=k.ringVertices_.slice(0),m=d.ringVertices_.slice(0),n=l.length,p=m.length,q=Mesh.stateMask_;this.states_.pushState(e,l);this.states_.pushState(h,m);e=this.states_.undos_[this.states_.curUndoIndex_];h=0;k.stateFlag_!==q&&(h=3*a,k.stateFlag_=q,e.vState_.push(k.clone()),e.vArState_.push(g[h],g[h+1],g[h+2]),e.nArState_.push(f[h],f[h+1],f[h+2]));d.stateFlag_!==
q&&(h=3*b,k.stateFlag_=q,e.vState_.push(d.clone()),e.vArState_.push(g[h],g[h+1],g[h+2]),e.nArState_.push(f[h],f[h+1],f[h+2]));g=[];f=[];this.trianglesRotate(k.tIndices_,a,g);if(this.adjustEdgeOrientation(g)&&(this.trianglesRotate(d.tIndices_,b,f),this.adjustEdgeOrientation(f))){l.sort(function(a,b){return a-b});m.sort(function(a,b){return a-b});q=Tools.intersectionArrays(l,m);0===q.length?this.connect1Ring(g,f):this.connect1RingCommonVertices(g,f,q);for(g=g=0;g<n;++g)c.computeRingVertices(l[g]);for(g=
0;g<p;++g)c.computeRingVertices(m[g]);this.iVertsDecimated_.push(a,b);this.iVertsToDelete_.push(a,b);k.tagFlag_=-1;d.tagFlag_=-1;this.cleanUpNeighborhood(l,m)}};
Topology.prototype.connect1RingCommonVertices=function(a,b,c){var d=this.mesh_,g=d.vertices_,f=d.triangles_,d=a.length,k=b.length,e=c.length,h=0;++Vertex.tagMask_;for(var l=Vertex.tagMask_,h=0;h<e;++h)g[c[h]].tagFlag_=l;for(var e=this.iTrisToDelete_,m=null,n=null,p=0,h=0;h<d;++h)m=g[a[h].v1],n=g[a[h].v2],m.tagFlag_===l&&n.tagFlag_===l&&(p=a[h].t,m.removeTriangle(p),n.removeTriangle(p),f[p].tagFlag_=-1,e.push(p));for(h=0;h<k;++h)m=g[b[h].v1],n=g[b[h].v2],m.tagFlag_===l&&n.tagFlag_===l&&(p=b[h].t,m.removeTriangle(p),
n.removeTriangle(p),f[p].tagFlag_=-1,e.push(p));f=[];e=[];f.push([]);e.push([]);this.matchEdgesCommonVertices(a,b,c[0]);for(h=0;h<d;++h)m=g[a[h].v1],n=g[a[h].v2],(m.tagFlag_!==l||n.tagFlag_!==l)&&f[f.length-1].push(a[h]),n.tagFlag_===l&&0!==f[f.length-1].length&&f.push([]);for(h=0;h<k;++h)m=g[b[h].v1],n=g[b[h].v2],(m.tagFlag_!==l||n.tagFlag_!==l)&&e[e.length-1].push(b[h]),n.tagFlag_===l&&0!==e[e.length-1].length&&e.push([]);0===f[f.length-1].length&&f.pop();0===e[e.length-1].length&&e.pop();b=f.length;
c=e.length-1;for(l=k=g=0;g<b||0<=c;)if(l=k=-1,g<b&&(k=f[g][0].v1),0<=c&&(l=e[c][e[c].length-1].v2),k===l)f[g].length>e[c].length?this.connectLinkedEdges(f[g],e[c]):this.connectLinkedEdges(e[c],f[g]),++g,--c;else for(h=0;h<d;++h)if(m=a[h].v1,m===k){this.connectLoop(f[g]);++g;break}else if(m===l){this.connectLoop(e[c]);--c;break}};
Topology.prototype.connect1Ring=function(a,b){var c=this.mesh_,d=c.vertices_,c=c.indexArray_;this.matchEdgesNearest(a,b);var g=a.length,f=b.length,k=f/g,e=0;g===f&&(e=-1);for(var h=0,l=0,h=0;h<g;++h)l=0,0!==h&&(l=Math.floor(f-k*h)),c[3*a[h].t+2]=b[l].v1,d[b[l].v1].tIndices_.push(a[h].t),l!==e&&(c[3*b[l].t+2]=a[h].v1,d[a[h].v1].tIndices_.push(b[l].t)),e=l};
Topology.prototype.connectLinkedEdges=function(a,b){var c=this.mesh_,d=c.vertices_,g=c.triangles_,c=c.indexArray_,f=a.length,k=b.length,e=b[0],h=e.t;d[e.v1].removeTriangle(h);d[e.v2].removeTriangle(h);var e=b[k-1],l=e.t;d[e.v1].removeTriangle(l);d[e.v2].removeTriangle(l);for(var e=k/f,m=0,n=0,p=0,n=0;n<f;++n)p=Math.floor(k-e*(n+1)),1>p&&(p=1),c[3*a[n].t+2]=b[p].v1,d[b[p].v1].tIndices_.push(a[n].t),p!==m&&p!==k-1&&(c[3*b[p].t+2]=a[n].v1,d[a[n].v1].tIndices_.push(b[p].t)),m=p;g[h].tagFlag_=-1;g[l].tagFlag_=
-1;this.iTrisToDelete_.push(h,l)};Topology.prototype.connectLoop=function(a){var b=this.mesh_,c=b.vertices_,d=b.indexArray_,g=a.length,f=a[0],k=f.t,e=f.v1;c[e].removeTriangle(k);c[f.v2].removeTriangle(k);c=c[e];for(f=1;f<g;++f){var h=a[f].t;d[3*h+2]=e;c.tIndices_.push(h)}b.triangles_[k].tagFlag_=-1;this.iTrisToDelete_.push(k)};
Topology.prototype.trianglesRotate=function(a,b,c){for(var d=this.mesh_.indexArray_,g=a.length,f=0,k=0,e=0,h=0,l=0;l<g;++l)f=3*a[l],k=d[f],e=d[f+1],h=d[f+2],h!==b&&(k===b?(d[f]=e,d[f+1]=h):(d[f+1]=k,d[f]=h),d[f+2]=b),c.push({v1:d[f],v2:d[f+1],t:a[l]})};
Topology.prototype.adjustEdgeOrientation=function(a){for(var b=a.length,c=0,d=-1,g=a[0].v1,f=0,k=0,f=0;f<b-1;f++){c=a[f].v2;d=-1;for(k=f+1;k<b;++k)if(a[k].v1===c)if(a[k].v2!==g)d=k;else{c=a[f+1];a[f+1]=a[k];a[k]=c;++f;f+1<b&&(g=a[f+1].v1);break}if(k===b){if(-1===d)return!1;c=a[f+1];a[f+1]=a[d];a[d]=c}}return!0};
Topology.prototype.matchEdgesCommonVertices=function(a,b,c){for(var d=a.length,g=-1,f=0,f=0;f<d;++f)if(a[f].v1===c){g=f;break}a.rotate(g);a=b.length;g=-1;for(f=0;f<a;++f)if(b[f].v1===c){g=f;break}b.rotate(g)};Topology.prototype.matchEdgesNearest=function(a,b){for(var c=this.mesh_.vertexArray_,d=0,g=3*a[0].v1,f=c[g],k=c[g+1],e=c[g+2],g=3*b[0].v1,h=f-c[g],l=k-c[g+1],g=e-c[g+2],m=h*h+l*l+g*g,n=b.length,p=1;p<n;++p)g=3*b[p].v1,h=f-c[g],l=k-c[g+1],g=e-c[g+2],h=h*h+l*l+g*g,h<m&&(m=h,d=p);b.rotate(d)};
Topology.prototype.cleanUpNeighborhood=function(a,b){for(var c=a.length,d=0,d=0;d<c;++d)this.cleanUpSingularVertex(a[d]);c=b.length;for(d=0;d<c;++d)this.cleanUpSingularVertex(b[d])};
Topology.prototype.cleanUpSingularVertex=function(a){var b=this.mesh_,c=b.vertices_,d=b.vertexArray_,g=b.normalArray_,f=b.indexArray_,k=c[a];if(!(0>k.tagFlag_)){var e=0,e=3*a,h=d[e],l=d[e+1],m=d[e+2],n=g[e],p=g[e+1],q=g[e+2];this.states_.pushState(k.tIndices_,k.ringVertices_);var r=Mesh.stateMask_,s=this.states_.undos_[this.states_.curUndoIndex_];k.stateFlag_!==r&&(k.stateFlag_=r,s.vState_.push(k.clone()),s.vArState_.push(h,l,m),s.nArState_.push(n,p,q));if(!this.deleteVertexIfDegenerate(a)){var t=
[];this.trianglesRotate(k.tIndices_,a,t);if(this.adjustEdgeOrientation(t)){for(var s=t.length,v=t[0].v1,u=-1,e=0,e=1;e<s-1;++e)if(t[e].v2===v){u=e;break}if(-1!==u){this.checkArrayLength(1);s=c.length;v=new Vertex(s);v.stateFlag_=r;e=3*s;d[e]=h;d[e+1]=l;d[e+2]=m;g[e]=-n;g[e+1]=-p;g[e+2]=-q;for(e=0;e<=u;++e)d=t[e].t,v.tIndices_.push(d),k.removeTriangle(d),f[3*d+2]=s;c.push(v);b.computeRingVertices(a);b.computeRingVertices(s);c=v.ringVertices_;f=c.length;for(e=0;e<f;++e)b.computeRingVertices(c[e]);k=
k.ringVertices_;c=k.length;for(e=0;e<c;++e)b.computeRingVertices(k[e]);this.iVertsDecimated_.push(a,s);k=[];k.push(a,s);e=new Sculpt;e.mesh_=b;e.smooth(k,1);this.cleanUpSingularVertex(a);this.cleanUpSingularVertex(s)}}}}};
Topology.prototype.deleteVertexIfDegenerate=function(a){var b=this.mesh_,c=b.vertices_,d=b.triangles_,g=b.indexArray_,f=c[a];if(0>f.tagFlag_)return!0;Tools.tidy(f.tIndices_);var k=f.tIndices_.length,e=0,h=e=0;if(0===k)return f.tagFlag_=-1,this.iVertsToDelete_.push(a),this.iVertsDecimated_.push(a),!0;if(1===k){var k=f.tIndices_[0],e=3*k,l=[];l.push(g[e],g[e+1],g[e+2]);Tools.tidy(l);g=l.length;for(e=0;e<g;++e)h=l[e],h!==a&&(c[h].removeTriangle(k),b.computeRingVertices(h));f.tagFlag_=-1;d[k].tagFlag_=
-1;this.iTrisToDelete_.push(k);this.iVertsToDelete_.push(a);this.iVertsDecimated_.push(a);for(e=0;e<g;++e)h=l[e],h!==a&&3>c[h].tIndices_.length&&this.deleteVertexIfDegenerate(h);return!0}if(2===k){k=f.tIndices_[0];e=3*k;l=[];l.push(g[e],g[e+1],g[e+2]);Tools.tidy(l);for(var m=l.length,e=0;e<m;++e)h=l[e],h!==a&&(c[h].removeTriangle(k),b.computeRingVertices(h));var n=f.tIndices_[1],e=3*n,p=[];p.push(g[e],g[e+1],g[e+2]);Tools.tidy(p);g=p.length;for(e=0;e<g;++e)h=p[e],h!==a&&(c[h].removeTriangle(n),b.computeRingVertices(h));
f.tagFlag_=-1;d[k].tagFlag_=-1;d[n].tagFlag_=-1;this.iTrisToDelete_.push(k,n);this.iVertsToDelete_.push(a);this.iVertsDecimated_.push(a);for(e=0;e<m;++e)h=l[e],h!==a&&3>c[h].tIndices_.length&&this.deleteVertexIfDegenerate(h);for(e=0;e<g;++e)h=p[e],h!==a&&3>c[h].tIndices_.length&&this.deleteVertexIfDegenerate(h);return!0}return!1};function Triangle(a){this.id_=a;this.normal_=[0,0,1];this.aabb_=new Aabb;this.posInLeaf_=this.leaf_=null;this.tagFlag_=1}Triangle.tagMask_=1;Triangle.prototype={clone:function(){var a=new Triangle(this.id_);a.normal_=this.normal_.slice();a.aabb_=this.aabb_.clone();a.leaf_=this.leaf_;a.posInLeaf_=this.posInLeaf_;return a}};function State(){this.nbVerticesState_=this.nbTrianglesState_=0;this.vArState_=[];this.nArState_=[];this.iArState_=[];this.vState_=[];this.tState_=[];this.aabbState_=new Aabb}function States(){this.mesh_=null;this.undos_=[];this.redos_=[];this.curUndoIndex_=0;this.firstState_=!1}
States.prototype={start:function(){++Mesh.stateMask_;var a=this.undos_;this.firstState_?a.length=0:10<a.length&&(a.shift(),--this.curUndoIndex_);this.firstState_=!1;this.redos_.length=0;if(a.length)for(var b=a.length-1;b!==this.curUndoIndex_;)a.pop(),--b;a.push(new State);this.curUndoIndex_=a.length-1;a=a[this.curUndoIndex_];b=this.mesh_;a.nbTrianglesState_=b.triangles_.length;a.nbVerticesState_=b.vertices_.length;a.aabbState_=b.octree_.aabbSplit_.clone()},pushState:function(a,b){this.pushStateTriangles(a);
this.pushStateVertices(b)},pushStateTriangles:function(a){for(var b=this.undos_[this.curUndoIndex_],c=b.iArState_,b=b.tState_,d=this.mesh_,g=d.indexArray_,f=d.triangles_,k=Mesh.stateMask_,e=a.length,d=0,h=b.length,d=0;d<e;++d){var l=f[a[d]];l.stateFlag_!==k&&(l.stateFlag_=k,b.push(l.clone()))}a=b.length;c.length=3*a;k=f=0;for(d=h;d<a;++d)k=3*b[d].id_,f=3*d,c[f]=g[k],c[f+1]=g[k+1],c[f+2]=g[k+2]},pushStateVertices:function(a){for(var b=this.undos_[this.curUndoIndex_],c=b.vArState_,d=b.nArState_,b=b.vState_,
g=this.mesh_,f=g.vertexArray_,k=g.normalArray_,e=g.vertices_,h=Mesh.stateMask_,l=a.length,g=0,m=b.length,g=0;g<l;++g){var n=e[a[g]];n.stateFlag_!==h&&(n.stateFlag_=h,b.push(n.clone()))}a=b.length;c.length=3*a;d.length=3*a;h=e=0;for(g=m;g<a;++g)h=3*b[g].id_,e=3*g,c[e]=f[h],c[e+1]=f[h+1],c[e+2]=f[h+2],d[e]=k[h],d[e+1]=k[h+1],d[e+2]=k[h+2]},undo:function(){if(this.undos_.length&&!this.firstState_){var a=new State,b=this.mesh_;a.nbTrianglesState_=b.triangles_.length;a.nbVerticesState_=b.vertices_.length;
a.aabbState_=b.octree_.aabbSplit_.clone();this.pushRedoTriangles(a);this.pushRedoVertices(a);this.pullUndoTriangles();this.pullUndoVertices();this.recomputeOctree(this.undos_[this.curUndoIndex_].aabbState_);b.updateBuffers();this.redos_.push(a);this.curUndoIndex_?(this.firstState_=!1,--this.curUndoIndex_):this.firstState_=!0}},pushRedoTriangles:function(a){var b=this.mesh_,c=b.indexArray_,d=b.triangles_,g=d.length,b=this.undos_[this.curUndoIndex_],f=b.tState_,k=f.length,e=b.nbTrianglesState_,b=a.iArState_;
a=a.tState_;var h=0,l=0;if(e<g){for(h=e;h<g;++h)a.push(d[h].clone());for(h=0;h<k;++h)l=f[h].id_,l<e&&a.push(d[l].clone());d.length=e}else{d.length=e;for(h=0;h<k;++h)l=f[h].id_,l<g&&a.push(d[l].clone())}d=a.length;b.length=3*d;for(h=g=0;h<d;++h)l=3*a[h].id_,g=3*h,b[g]=c[l],b[g+1]=c[l+1],b[g+2]=c[l+2]},pushRedoVertices:function(a){var b=this.mesh_,c=b.vertexArray_,d=b.normalArray_,g=b.vertices_,f=g.length,b=this.undos_[this.curUndoIndex_],k=b.vState_,e=k.length,h=b.nbVerticesState_,b=a.vArState_,l=
a.nArState_;a=a.vState_;var m=0,n=0;if(h<f){for(m=h;m<f;++m)a.push(g[m].clone());for(m=0;m<e;++m)n=k[m].id_,n<h&&a.push(g[n].clone());g.length=h}else{g.length=h;for(m=0;m<e;++m)n=k[m].id_,n<f&&a.push(g[n].clone())}g=a.length;b.length=3*g;l.length=3*g;for(m=f=0;m<g;++m)n=3*a[m].id_,f=3*m,b[f]=c[n],b[f+1]=c[n+1],b[f+2]=c[n+2],l[f]=d[n],l[f+1]=d[n+1],l[f+2]=d[n+2]},pullUndoTriangles:function(){for(var a=this.undos_[this.curUndoIndex_],b=this.mesh_,c=b.indexArray_,b=b.triangles_,d=a.tState_,g=a.iArState_,
a=a.nbTrianglesState_,f=d.length,k=0,e=0,h=0,k=0;k<f;++k)e=d[k],e.id_<a&&(h=e.id_,b[h]=e.clone(),h*=3,e=3*k,c[h]=g[e],c[h+1]=g[e+1],c[h+2]=g[e+2])},pullUndoVertices:function(){for(var a=this.undos_[this.curUndoIndex_],b=this.mesh_,c=b.vertexArray_,d=b.normalArray_,b=b.vertices_,g=a.vState_,f=a.vArState_,k=a.nArState_,a=a.nbVerticesState_,e=g.length,h=0,l=0,m=0,h=0;h<e;++h)l=g[h],l.id_<a&&(m=l.id_,b[m]=l.clone(),m*=3,l=3*h,c[m]=f[l],c[m+1]=f[l+1],c[m+2]=f[l+2],d[m]=k[l],d[m+1]=k[l+1],d[m+2]=k[l+2])},
redo:function(){if(this.redos_.length){var a=this.redos_[this.redos_.length-1],b=this.mesh_;b.triangles_.length=a.nbTrianglesState_;b.vertices_.length=a.nbVerticesState_;this.pullRedoTriangles();this.pullRedoVertices();this.recomputeOctree(a.aabbState_.clone());b.updateBuffers();this.firstState_?this.firstState_=!1:this.curUndoIndex_++;this.redos_.pop()}},pullRedoTriangles:function(){for(var a=this.redos_[this.redos_.length-1],b=a.iArState_,a=a.tState_,c=a.length,d=this.mesh_,g=d.indexArray_,d=d.triangles_,
f=0,k=0,e=0,f=0;f<c;++f)k=a[f],e=k.id_,d[e]=k.clone(),e*=3,k=3*f,g[e]=b[k],g[e+1]=b[k+1],g[e+2]=b[k+2]},pullRedoVertices:function(){for(var a=this.redos_[this.redos_.length-1],b=a.vArState_,c=a.nArState_,a=a.vState_,d=a.length,g=this.mesh_,f=g.vertexArray_,k=g.normalArray_,g=g.vertices_,e=0,h=0,l=0,e=0;e<d;++e)h=a[e],l=h.id_,g[l]=h.clone(),l*=3,h=3*e,f[l]=b[h],f[l+1]=b[h+1],f[l+2]=b[h+2],k[l]=c[h],k[l+1]=c[h+1],k[l+2]=c[h+2]},recomputeOctree:function(a){for(var b=this.mesh_,c=b.triangles_.length,
d=Array(c),g=0;g<c;++g)d[g]=g;++Triangle.tagMask_;b.octree_=new Octree;b.octree_.build(b,d,a)},reset:function(){this.mesh_=null;this.undos_=[];this.redos_=[];this.curUndoIndex_=0;this.firstState_=!1}};function Vertex(a){this.id_=a;this.tIndices_=[];this.ringVertices_=[];this.stateFlag_=this.sculptFlag_=this.tagFlag_=1}Vertex.tagMask_=1;Vertex.sculptMask_=1;
Vertex.prototype={clone:function(){var a=new Vertex(this.id_);a.tIndices_=this.tIndices_.slice();a.ringVertices_=this.ringVertices_.slice();a.tagFlag_=this.tagFlag_;a.sculptFlag_=this.sculptFlag_;a.stateFlag_=this.stateFlag_;return a},replaceTriangle:function(a,b){for(var c=this.tIndices_,d=c.length,g=0;g<d;++g)if(a===c[g]){c[g]=b;break}},replaceRingVertex:function(a,b){for(var c=this.ringVertices_,d=c.length,g=0;g<d;++g)if(a===c[g]){c[g]=b;break}},removeTriangle:function(a){for(var b=this.tIndices_,
c=b.length,d=0;d<c;++d)if(a===b[d]){b[d]=b[c-1];b.pop();break}},removeRingVertex:function(a){for(var b=this.ringVertices_,c=b.length,d=0;d<c;++d)if(a===b[d]){b[d]=b[c-1];b.pop();break}}};function Gui(a){this.sculptgl_=a;this.ctrlNbTriangles_=this.ctrlNbVertices_=this.ctrlDetailDecimation_=this.ctrlDetailSubdivision_=this.ctrlIntensity_=this.ctrlNegative_=this.ctrlClay_=this.ctrlContinuous_=this.ctrlSculpt_=this.ctrlShaders_=this.ctrlColor_=null;this.dummyFunc_=function(){}}
Gui.prototype={initGui:function(){var a=new dat.GUI;a.domElement.style.position="absolute";a.domElement.style.height="600px";this.initGeneralGui(a);a=new dat.GUI;this.initEditingGui(a)},initGeneralGui:function(a){var b=this.sculptgl_,c=a.addFolder("Wacom tablet");c.add(b,"usePenRadius_").name("Pressure radius");c.add(b,"usePenIntensity_").name("Pressure intensity");c.open();c=a.addFolder("Files (import/export)");c.add(b,"resetSphere_").name("Reset sphere");c.add(b,"open_").name("Import (obj, stl)");
c.add(b,"save_").name("Export (obj)");c.open();c=a.addFolder("Go to Verold !");c.add(b,"keyVerold_").name("API key");c.add(b,"exportVerold_").name("Upload");c=a.addFolder("Go to Sketchfab !");c.add(b,"keySketchfab_").name("API key");c.add(b,"exportSketchfab_").name("Upload");c=a.addFolder("Camera");c.add(b.camera_,"mode_",{Spherical:Camera.mode.SPHERICAL,Plane:Camera.mode.PLANE}).name("Camera").onChange(function(a){b.camera_.updateMode(parseInt(a,10));b.render()});c.open();a=a.addFolder("History");
a.add(b,"undo_").name("Undo (Ctrl+Z)");a.add(b,"redo_").name("Redo (Ctrl+Y)");a.open()},initEditingGui:function(a){var b=this.sculptgl_,c=this,d=a.addFolder("Sculpt");this.ctrlSculpt_=d.add(b.sculpt_,"tool_",{"Brush (1)":Sculpt.tool.BRUSH,"Inflate (2)":Sculpt.tool.INFLATE,"Rotate (3)":Sculpt.tool.ROTATE,"Smooth (4)":Sculpt.tool.SMOOTH,"Flatten (5)":Sculpt.tool.FLATTEN,"Pinch (6)":Sculpt.tool.PINCH,"Crease (7)":Sculpt.tool.CREASE,"Drag (8)":Sculpt.tool.DRAG}).name("Tool");this.ctrlSculpt_.onChange(function(a){b.sculpt_.tool_=
parseInt(a,10);a=b.sculpt_.tool_;var d=Sculpt.tool;c.ctrlClay_.__li.hidden=a!==d.BRUSH;c.ctrlNegative_.__li.hidden=a!==d.BRUSH&&a!==d.FLATE&&a!==d.CREASE;c.ctrlContinuous_.__li.hidden=a===d.ROTATE||a===d.DRAG;c.ctrlContinuous_.__li.hidden=c.ctrlContinuous_.__li.hidden});this.ctrlClay_=d.add(b.sculpt_,"clay_").name("Clay");this.ctrlNegative_=d.add(b.sculpt_,"negative_").name("Negative (N)");this.ctrlContinuous_=d.add(b,"continuous_").name("Continuous");d.add(b,"symmetry_").name("Symmetry");d.add(b.sculpt_,
"culling_").name("Sculpt culling");d.add(b.picking_,"rDisplay_",20,200).name("Radius");this.ctrlIntensity_=d.add(b.sculpt_,"intensity_",0,1).name("Intensity");d.open();d=a.addFolder("Topology");d.add(b.sculpt_,"topo_",{Static:Sculpt.topo.STATIC,Subdivision:Sculpt.topo.SUBDIVISION,"Adaptive (!!!)":Sculpt.topo.ADAPTIVE}).name("Tool").onChange(function(a){b.sculpt_.topo_=parseInt(a,10);a=b.sculpt_.topo_;var d=Sculpt.topo;c.ctrlDetailSubdivision_.__li.hidden=a===d.STATIC;c.ctrlDetailDecimation_.__li.hidden=
a!==d.SUBDIVISION});this.ctrlDetailSubdivision_=d.add(b.sculpt_,"detailSubdivision_",0,1).name("Detail");this.ctrlDetailDecimation_=d.add(b.sculpt_,"detailDecimation_",0,1).name("Min edge");d.open();a=a.addFolder("Mesh");this.ctrlNbVertices_=a.add(this,"dummyFunc_").name("Ver : 0");this.ctrlNbTriangles_=a.add(this,"dummyFunc_").name("Tri : 0");d={Phong:Render.mode.PHONG,"Wireframe (slow)":Render.mode.WIREFRAME,Transparency:Render.mode.TRANSPARENCY,Clay:Render.mode.MATERIAL,Chavant:Render.mode.MATERIAL+
1,Skin:Render.mode.MATERIAL+2,Drink:Render.mode.MATERIAL+3,"Red velvet":Render.mode.MATERIAL+4,Orange:Render.mode.MATERIAL+5,Bronze:Render.mode.MATERIAL+6};this.ctrlShaders_=a.add(new Render,"shaderType_",d).name("Shader");this.ctrlShaders_.onChange(function(a){b.mesh_&&(b.mesh_.render_.updateShaders(parseInt(a,10),b.textures_,b.shaders_),b.mesh_.updateBuffers(),b.render(),c.ctrlColor_.__li.hidden=b.mesh_.render_.shaderType_>=Render.mode.MATERIAL)});this.ctrlColor_=a.addColor(new Render,"color_").name("Color");
this.ctrlColor_.onChange(function(){b.render()});a.open()},updateMesh:function(a){a&&(this.ctrlColor_.object=a.render_,this.ctrlColor_.updateDisplay(),this.ctrlShaders_.object=a.render_,this.ctrlShaders_.updateDisplay(),this.updateMeshInfo(a.vertices_.length,a.triangles_.length))},updateMeshInfo:function(a,b){this.ctrlNbVertices_.name("Ver : "+a);this.ctrlNbTriangles_.name("Tri : "+b)}};function SculptGL(){this.gl_=null;this.mouseButton_=this.sumDisplacement_=this.lastMouseY_=this.lastMouseX_=0;this.cameraTimer_=-1;this.usePenRadius_=!0;this.continuous_=this.symmetry_=this.usePenIntensity_=!1;this.sculptTimer_=-1;this.mouseY_=this.mouseX_=this.pressureIntensity_=this.pressureRadius_=0;this.ptPlane_=[0,0,0];this.nPlane_=[1,0,0];this.states_=new States;this.camera_=new Camera;this.picking_=new Picking(this.camera_);this.pickingSym_=new Picking(this.camera_);this.sculpt_=new Sculpt(this.states_);
this.mesh_=null;this.textures_=[];this.shaders_={};this.sphere_="";this.gui_=new Gui(this);this.resetSphere_=this.resetSphere;this.open_=this.openFile;this.save_=this.saveFile;this.undo_=this.onUndo;this.redo_=this.onRedo;this.keyVerold_="";this.exportVerold_=this.exportVerold;this.keySketchfab_="";this.exportSketchfab_=this.exportSketchfab}SculptGL.elementIndexType=0;SculptGL.indexArrayType=Uint16Array;
SculptGL.prototype={start:function(){var a=this;$("#fileopen").change(function(b){a.loadFile(b)});this.initWebGL();this.loadShaders();this.gui_.initGui();this.onWindowResize();this.loadTextures();this.initEvents()},initEvents:function(){var a=this,b=$("#canvas");b.mousedown(function(b){a.onMouseDown(b)});b.mouseup(function(b){a.onMouseUp(b)});b.mousewheel(function(b,d){a.onMouseWheel(b,d)});b.mousemove(function(b){a.onMouseMove(b)});b.mouseout(function(b){a.onMouseOut(b)});b[0].addEventListener("webglcontextlost",
a.onContextLost,!1);b[0].addEventListener("webglcontextrestored",a.onContextRestored,!1);$(window).keydown(function(b){a.onKeyDown(b)});$(window).keyup(function(b){a.onKeyUp(b)});$(window).resize(function(b){a.onWindowResize(b)})},initWebGL:function(){var a={antialias:!1,stencil:!0};try{this.gl_=$("#canvas")[0].getContext("webgl",a)||$("#canvas")[0].getContext("experimental-webgl",a)}catch(b){alert("Could not initialise WebGL.")}if(a=this.gl_)a.getExtension("OES_element_index_uint")?(SculptGL.elementIndexType=
a.UNSIGNED_INT,SculptGL.indexArrayType=Uint32Array):(SculptGL.elementIndexType=a.UNSIGNED_SHORT,SculptGL.indexArrayType=Uint16Array),a.viewportWidth=$(window).width(),a.viewportHeight=$(window).height(),a.clearColor(0.2,0.2,0.2,1),a.enable(a.DEPTH_TEST),a.depthFunc(a.LEQUAL),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT)},loadTextures:function(){var a=new Image,b=this;a.onload=function(){b.loadSphere()};a.src="ressources/clay.jpg";var c=new Image;c.src=
"ressources/chavant.jpg";var d=new Image;d.src="ressources/skin.jpg";var g=new Image;g.src="ressources/drink.jpg";var f=new Image;f.src="ressources/redvelvet.jpg";var k=new Image;k.src="ressources/orange.jpg";var e=new Image;e.src="ressources/bronze.jpg";this.textures_.push(a,c,d,g,f,k,e)},loadShaders:function(){var a=function(a){var b=new XMLHttpRequest;b.open("GET",a,!1);b.send(null);return b.responseText},b=this.shaders_;b.phongVertex=a("shaders/phongVertex.glsl");b.phongFragment=a("shaders/phongFragment.glsl");
b.wireframeVertex=a("shaders/wireframeVertex.glsl");b.wireframeFragment=a("shaders/wireframeFragment.glsl");b.transparencyVertex=a("shaders/transparencyVertex.glsl");b.transparencyFragment=a("shaders/transparencyFragment.glsl");b.reflectionVertex=a("shaders/reflectionVertex.glsl");b.reflectionFragment=a("shaders/reflectionFragment.glsl")},loadSphere:function(){var a=new XMLHttpRequest;a.open("GET","ressources/sphere.obj",!0);var b=this;a.onload=function(){b.sphere_=this.responseText;b.resetSphere()};
a.send(null)},render:function(){var a=this.gl_;a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);this.camera_.updateView();this.mesh_&&this.mesh_.render(this.camera_,this.picking_)},onWindowResize:function(){var a=$(window).width(),b=$(window).height();this.camera_.width_=a;this.camera_.height_=b;$("#canvas").attr("width",a);$("#canvas").attr("height",b);var c=this.gl_;c.viewportWidth=a;c.viewportHeight=b;c.viewport(0,0,a,b);this.camera_.updateProjection();this.render()},onKeyDown:function(a){a.stopPropagation();
var b=a.which;if(a.ctrlKey&&90===b)this.onUndo();else if(a.ctrlKey&&89===b)this.onRedo();else{switch(b){case 49:case 97:this.gui_.ctrlSculpt_.setValue(Sculpt.tool.BRUSH);break;case 50:case 98:this.gui_.ctrlSculpt_.setValue(Sculpt.tool.INFLATE);break;case 51:case 99:this.gui_.ctrlSculpt_.setValue(Sculpt.tool.ROTATE);break;case 52:case 100:this.gui_.ctrlSculpt_.setValue(Sculpt.tool.SMOOTH);break;case 53:case 101:this.gui_.ctrlSculpt_.setValue(Sculpt.tool.FLATTEN);break;case 54:case 102:this.gui_.ctrlSculpt_.setValue(Sculpt.tool.PINCH);
break;case 55:case 103:this.gui_.ctrlSculpt_.setValue(Sculpt.tool.CREASE);break;case 56:case 104:this.gui_.ctrlSculpt_.setValue(Sculpt.tool.DRAG);break;case 78:this.gui_.ctrlNegative_.setValue(!this.sculpt_.negative_);break;case 37:case 81:case 65:this.camera_.moveX_=-1;break;case 39:case 68:this.camera_.moveX_=1;break;case 38:case 90:case 87:this.camera_.moveZ_=-1;break;case 40:case 83:this.camera_.moveZ_=1}var c=this;-1===this.cameraTimer_&&(this.cameraTimer_=setInterval(function(){c.camera_.updateTranslation();
c.render()},20))}},onKeyUp:function(a){a.stopPropagation();a.preventDefault();switch(a.which){case 37:case 81:case 65:case 39:case 68:this.camera_.moveX_=0;break;case 38:case 90:case 87:case 40:case 83:this.camera_.moveZ_=0}-1!==this.cameraTimer_&&(0===this.camera_.moveX_&&0===this.camera_.moveZ_)&&(clearInterval(this.cameraTimer_),this.cameraTimer_=-1)},onMouseDown:function(a){a.stopPropagation();a.preventDefault();var b=a.pageX,c=a.pageY;a=this.mouseButton_=a.which;var d=Tablet.pressure(),g=this.usePenRadius_?
d:1,d=this.usePenIntensity_?d:1;if(1===a){if(this.mesh_)if(this.sumDisplacement_=0,this.states_.start(),this.sculpt_.tool_===Sculpt.tool.ROTATE)this.sculpt_.startRotate(this.picking_,b,c,this.pickingSym_,this.ptPlane_,this.nPlane_,this.symmetry_);else if(this.continuous_&&this.sculpt_.tool_!==Sculpt.tool.DRAG){this.pressureRadius_=g;this.pressureIntensity_=d;this.mouseX_=b;this.mouseY_=c;var f=this;this.sculptTimer_=setInterval(function(){f.sculpt_.sculptStroke(f.mouseX_,f.mouseY_,f.pressureRadius_,
f.pressureIntensity_,f);f.render()},20)}else this.sculpt_.sculptStroke(b,c,g,d,this)}else 3===a&&this.camera_.start(b,c)},onMouseUp:function(a){a.stopPropagation();a.preventDefault();this.mesh_&&this.mesh_.checkLeavesUpdate();-1!==this.sculptTimer_&&(clearInterval(this.sculptTimer_),this.sculptTimer_=-1);this.mouseButton_=0},onMouseOut:function(){this.mesh_&&this.mesh_.checkLeavesUpdate();-1!==this.sculptTimer_&&(clearInterval(this.sculptTimer_),this.sculptTimer_=-1);this.mouseButton_=0},onMouseWheel:function(a,
b){a.stopPropagation();a.preventDefault();this.camera_.zoom(b/100);this.render()},onMouseMove:function(a){a.stopPropagation();a.preventDefault();var b=a.pageX;a=a.pageY;var c=this.mouseButton_,d=this.sculpt_.tool_,g=Tablet.pressure(),f=this.usePenRadius_?g:1,g=this.usePenIntensity_?g:1;this.continuous_&&-1!==this.sculptTimer_?(this.pressureRadius_=f,this.pressureIntensity_=g,this.mouseX_=b,this.mouseY_=a):(this.mesh_&&(1!==c||d!==Sculpt.tool.ROTATE&&d!==Sculpt.tool.DRAG)&&this.picking_.intersectionMouseMesh(this.mesh_,
b,a,f),1===c?(d!==Sculpt.tool.ROTATE?this.sculpt_.sculptStroke(b,a,f,g,this):this.picking_.mesh_&&(this.picking_.pickVerticesInSphere(this.picking_.rWorldSqr_),this.sculpt_.sculptMesh(this.picking_,g,!1,b,a,this.lastMouseX_,this.lastMouseY_),this.symmetry_&&(this.pickingSym_.pickVerticesInSphere(this.pickingSym_.rWorldSqr_),this.sculpt_.sculptMesh(this.pickingSym_,g,!0,this.lastMouseX_,this.lastMouseY_,b,a)),this.mesh_.updateBuffers()),this.gui_.updateMeshInfo(this.mesh_.vertices_.length,this.mesh_.triangles_.length)):
3===c?this.camera_.rotate(b,a):2===c&&this.camera_.translate((b-this.lastMouseX_)/3E3,(a-this.lastMouseY_)/3E3),this.lastMouseX_=b,this.lastMouseY_=a,this.render())},onContextLost:function(){alert("shit happens : context lost")},onContextRestored:function(){alert("context is restored")},loadFile:function(a){a.stopPropagation();a.preventDefault();if(0!==a.target.files.length){a=a.target.files[0];var b=a.name;if(b.endsWith(".obj")||b.endsWith(".stl")){var c=new FileReader,d=this;c.onload=function(a){d.startMeshLoad();
b.endsWith(".obj")?Files.importOBJ(a.target.result,d.mesh_):Files.importSTL(a.target.result,d.mesh_);d.endMeshLoad();$("#fileopen").replaceWith($("#fileopen").clone(!0))};b.endsWith(".obj")?c.readAsText(a):c.readAsBinaryString(a)}}},resetSphere:function(){this.startMeshLoad();Files.importOBJ(this.sphere_,this.mesh_);this.endMeshLoad()},startMeshLoad:function(){this.mesh_=new Mesh(this.gl_);this.states_.reset();this.states_.mesh_=this.mesh_;this.sculpt_.mesh_=this.mesh_;Mesh.stateMask_=1;Vertex.tagMask_=
1;Vertex.sculptMask_=1;Triangle.tagMask_=1},endMeshLoad:function(){var a=this.mesh_;a.render_.shaderType_=Render.mode.MATERIAL;this.gui_.ctrlColor_.__li.hidden=!0;a.initMesh(this.textures_,this.shaders_);a.moveTo([0,0,0]);var b=vec3.dist(a.octree_.aabbLoose_.max_,a.octree_.aabbLoose_.min_);this.camera_.reset();this.camera_.globalScale_=b;this.camera_.zoom(-0.4);this.gui_.updateMesh(a);this.render()},openFile:function(){$("#fileopen").trigger("click")},saveFile:function(){if(this.mesh_){var a=[Files.exportOBJ(this.mesh_)],
a=new Blob(a,{type:"text/plain;charset=utf-8"});saveAs(a,"yourMesh.obj")}},exportVerold:function(){this.mesh_&&(""===this.keyVerold_?alert("Please enter a verold API Key."):Files.exportVerold(this.mesh_,this.keyVerold_))},exportSketchfab:function(){this.mesh_&&(""===this.keySketchfab_?alert("Please enter a sketchfab API Key."):Files.exportSketchfab(this.mesh_,this.keySketchfab_))},onUndo:function(){this.states_.undo();this.render();this.gui_.updateMesh(this.mesh_)},onRedo:function(){this.states_.redo();
this.render();this.gui_.updateMesh(this.mesh_)}};
